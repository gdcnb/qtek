(function(e){"undefined"!=typeof define&&define.amd?define(["exports"],e.bind(window)):e(window.qtek={})})(function(e){var t,r,n;(function(e){function i(e,t){return b.call(e,t)}function a(e,t){var r,n,i,a,o,s,u,l,c,f,h=t&&t.split("/"),d=_.map,p=d&&d["*"]||{};if(e&&"."===e.charAt(0))if(t){for(h=h.slice(0,h.length-1),e=h.concat(e.split("/")),l=0;e.length>l;l+=1)if(f=e[l],"."===f)e.splice(l,1),l-=1;else if(".."===f){if(1===l&&(".."===e[2]||".."===e[0]))break;l>0&&(e.splice(l-1,2),l-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((h||p)&&d){for(r=e.split("/"),l=r.length;l>0;l-=1){if(n=r.slice(0,l).join("/"),h)for(c=h.length;c>0;c-=1)if(i=d[h.slice(0,c).join("/")],i&&(i=i[n])){a=i,o=l;break}if(a)break;!s&&p&&p[n]&&(s=p[n],u=l)}!a&&s&&(a=s,o=u),a&&(r.splice(0,o,a),e=r.join("/"))}return e}function o(t,r){return function(){return d.apply(e,y.call(arguments,0).concat([t,r]))}}function s(e){return function(t){return a(t,e)}}function u(e){return function(t){m[e]=t}}function l(t){if(i(g,t)){var r=g[t];delete g[t],x[t]=!0,h.apply(e,r)}if(!i(m,t)&&!i(x,t))throw Error("No "+t);return m[t]}function c(e){var t,r=e?e.indexOf("!"):-1;return r>-1&&(t=e.substring(0,r),e=e.substring(r+1,e.length)),[t,e]}function f(e){return function(){return _&&_.config&&_.config[e]||{}}}var h,d,p,v,m={},g={},_={},x={},b=Object.prototype.hasOwnProperty,y=[].slice;p=function(e,t){var r,n=c(e),i=n[0];return e=n[1],i&&(i=a(i,t),r=l(i)),i?e=r&&r.normalize?r.normalize(e,s(t)):a(e,t):(e=a(e,t),n=c(e),i=n[0],e=n[1],i&&(r=l(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:r}},v={require:function(e){return o(e)},exports:function(e){var t=m[e];return t!==void 0?t:m[e]={}},module:function(e){return{id:e,uri:"",exports:m[e],config:f(e)}}},h=function(t,r,n,a){var s,c,f,h,d,_,b=[];if(a=a||t,"function"==typeof n){for(r=!r.length&&n.length?["require","exports","module"]:r,d=0;r.length>d;d+=1)if(h=p(r[d],a),c=h.f,"require"===c)b[d]=v.require(t);else if("exports"===c)b[d]=v.exports(t),_=!0;else if("module"===c)s=b[d]=v.module(t);else if(i(m,c)||i(g,c)||i(x,c))b[d]=l(c);else{if(!h.p)throw Error(t+" missing "+c);h.p.load(h.n,o(a,!0),u(c),{}),b[d]=m[c]}f=n.apply(m[t],b),t&&(s&&s.exports!==e&&s.exports!==m[t]?m[t]=s.exports:f===e&&_||(m[t]=f))}else t&&(m[t]=n)},t=r=d=function(t,r,n,i,a){return"string"==typeof t?v[t]?v[t](r):l(p(t,r).f):(t.splice||(_=t,r.splice?(t=r,r=n,n=null):t=e),r=r||function(){},"function"==typeof n&&(n=i,i=a),i?h(e,t,r,n):setTimeout(function(){h(e,t,r,n)},4),d)},d.config=function(e){return _=e,_.deps&&d(_.deps,_.callback),d},n=function(e,t,r){t.splice||(r=t,t=[]),i(m,e)||i(g,e)||(g[e]=[e,t,r])},n.amd={jQuery:!0}})(),n("build/almond",function(){}),n("2d/camera",function(){}),n("core/mixin/derive",[],function(){function e(e,t,r){"object"==typeof t&&(r=t,t=null);var n={"instanceof":function(e){for(var t=a;t;){if(t===e)return!0;t=t.__super__}}},i=this,a=function(r){if(i.call(this),_.extend(this,"function"==typeof e?e.call(this):e),_.extend(this,r),this.constructor==a){for(var n=a,o=[t];n.__super__;)n=n.__super__,o.unshift(n.__initialize__);for(var s=0;o.length>s;s++)o[s]&&o[s].call(this)}};return a.__super__=i,a.__initialize__=t,_.extend(a.prototype,i.prototype,n,r),a.prototype.constructor=a,a.derive=i.derive,a}return{derive:e}}),n("core/mixin/notifier",[],function(){return{trigger:function(){if(this.__handlers__){var e=arguments[0],t=Array.prototype.slice.call(arguments,1),r=this.__handlers__[e];if(r)for(var n=0;r.length>n;n+=2){var i=r[n],a=r[n+1];i.apply(a||this,t)}}},on:function(e,t,r){if(e){var n=this.__handlers__||(this.__handlers__={});return n[e]||(n[e]=[]),-1==n[e].indexOf(t)&&(n[e].push(t),n[e].push(r)),t}},off:function(e,t){var r=this.__handlers__||(this.__handlers__={});if(r[e])if(t){var n=r[e],i=n.indexOf(t);i>=0&&n.splice(i,2)}else r[e]=[]},has:function(e,t){return this.__handlers__&&this.__handlers__[e]?t?-1!==this.__handlers__[e].indexOf(t):this.__handlers__[e].length:!1}}}),n("core/mixin/dirty",{dirty:function(e){this._dirtyFlag||(this._dirtyFlag={}),this._dirtyFlag[e]=!0},fresh:function(e){this._dirtyFlag||(this._dirtyFlag={}),this._dirtyFlag[e]=!1},isDirty:function(e){return this._dirtyFlag||(this._dirtyFlag={}),this._dirtyFlag[e]===void 0?!0:this._dirtyFlag[e]}}),n("core/cache",[],function(){var e=function(){this._contextId="",this._caches={},this._context={}};return e.prototype={use:function(e){this._caches.hasOwnProperty(e)||(this._caches[e]={}),this._contextId=e,this._context=this._caches[e]},put:function(e,t){this._context[e]=t},get:function(e){return this._context[e]},clearContext:function(){this._caches[this._contextId]={},this._context={}},"delete":function(e){delete this._context[e]},clearAll:function(){this._caches={}},getContext:function(){return this._context},miss:function(e){return!this._context.hasOwnProperty(e)}},e.prototype.constructor=e,e}),function(e){function t(n){function i(e){return e&&"object"==typeof e&&!bn(e)&&Qr.call(e,"__wrapped__")?e:new G(e)}function o(e,t,r){var n=e.length,i=n-t>=r;if(i)for(var a={},o=t-1;n>++o;){var s=Wr(e[o]);(Qr.call(a,s)?a[s]:a[s]=[]).push(e[o])}return function(r){if(i){var n=Wr(r);return Qr.call(a,n)&&qt(a[n],r)>-1}return qt(e,r,t)>-1}}function B(e){return e.charCodeAt(0)}function U(e,t){var n=e.index,i=t.index;if(e=e.criteria,t=t.criteria,e!==t){if(e>t||e===r)return 1;if(t>e||t===r)return-1}return i>n?-1:1}function F(e,t,r,n){function i(){var n=arguments,l=o?this:t;if(a||(e=t[s]),r.length&&(n=n.length?(n=j(n),u?n.concat(r):r.concat(n)):r),this instanceof i){z.prototype=e.prototype,l=new z,z.prototype=null;var c=e.apply(l,n);return ut(c)?c:l}return e.apply(l,n)}var a=st(e),o=!r,s=t;if(o){var u=n;r=t}else if(!a){if(!n)throw new Hr;t=e}return i}function k(){for(var e,t={shadowedProps:y,arrays:"isArray(iterable)",bottom:"",init:"iterable",loop:"",top:"",useHas:!0,useKeys:!!En},r=0;e=arguments[r];r++)for(var n in e)t[n]=e[n];var a=t.args;t.firstArg=/^[^,]+/.exec(a)[0];var o=Cr("hasOwnProperty, isArguments, isArray, isString, keys, lodash, objectTypes","return function("+a+") {\n"+mn(t)+"\n}");return o(Qr,J,bn,dt,En,i,D)}function W(e){return"\\"+L[e]}function H(e){return wn[e]}function V(e){return"function"!=typeof e.toString&&"string"==typeof(e+"")}function G(e){this.__wrapped__=e}function z(){}function q(e){var t=!1;if(!e||tn.call(e)!=M||!vn.argsClass&&J(e))return t;var r=e.constructor;return(st(r)?r instanceof r:vn.nodeClass||!V(e))?vn.ownLast?(Pn(e,function(e,r,n){return t=Qr.call(n,r),!1}),t===!0):(Pn(e,function(e,r){t=r}),t===!1||Qr.call(e,t)):t}function j(e,t,n){t||(t=0),n===r&&(n=e?e.length:0);for(var i=-1,a=n-t||0,o=Sr(0>a?0:a);a>++i;)o[i]=e[t+i];return o}function X(e){return An[e]}function J(e){return tn.call(e)==T}function Y(e,t,n,a,o,s){var u=e;if("function"==typeof t&&(a=n,n=t,t=!1),"function"==typeof n){if(n=a===r?n:i.createCallback(n,a,1),u=n(u),u!==r)return u;u=e}var l=ut(u);if(l){var c=tn.call(u);if(!S[c]||!vn.nodeClass&&V(u))return u;var f=bn(u)}if(!l||!t)return l?f?j(u):On({},u):u;var h=pn[c];switch(c){case A:case O:return new h(+u);case P:case N:return new h(u);case R:return h(u.source,p.exec(u))}o||(o=[]),s||(s=[]);for(var d=o.length;d--;)if(o[d]==e)return s[d];return u=f?h(u.length):{},f&&(Qr.call(e,"index")&&(u.index=e.index),Qr.call(e,"input")&&(u.input=e.input)),o.push(e),s.push(u),(f?Ot:Mn)(e,function(e,i){u[i]=Y(e,t,n,r,o,s)}),u}function Z(e,t,r){return Y(e,!0,t,r)}function Q(e,t,n){var a;return t=i.createCallback(t,n),Mn(e,function(e,n,i){return t(e,n,i)?(a=n,!1):r}),a}function K(e){var t=[];return Pn(e,function(e,r){st(e)&&t.push(r)}),t.sort()}function $(e,t){return e?Qr.call(e,t):!1}function et(e){for(var t=-1,r=En(e),n=r.length,i={};n>++t;){var a=r[t];i[e[a]]=a}return i}function tt(e){return e===!0||e===!1||tn.call(e)==A}function rt(e){return e instanceof Lr||tn.call(e)==O}function nt(e){return e?1===e.nodeType:!1}function it(e){var t=!0;if(!e)return t;var r=tn.call(e),n=e.length;return r==w||r==N||(vn.argsClass?r==T:J(e))||r==M&&"number"==typeof n&&st(e.splice)?!n:(Mn(e,function(){return t=!1}),t)}function at(e,t,n,a,o,s){var l=n===u;if(n&&!l){n=a===r?n:i.createCallback(n,a,2);var c=n(e,t);if(c!==r)return!!c}if(e===t)return 0!==e||1/e==1/t;var f=typeof e,h=typeof t;if(e===e&&(!e||"function"!=f&&"object"!=f)&&(!t||"function"!=h&&"object"!=h))return!1;if(null==e||null==t)return e===t;var d=tn.call(e),p=tn.call(t);if(d==T&&(d=M),p==T&&(p=M),d!=p)return!1;switch(d){case A:case O:return+e==+t;case P:return e!=+e?t!=+t:0==e?1/e==1/t:e==+t;case R:case N:return e==Wr(t)}var v=d==w;if(!v){if(Qr.call(e,"__wrapped__ ")||Qr.call(t,"__wrapped__"))return at(e.__wrapped__||e,t.__wrapped__||t,n,a,o,s);if(d!=M||!vn.nodeClass&&(V(e)||V(t)))return!1;var m=!vn.argsObject&&J(e)?Fr:e.constructor,g=!vn.argsObject&&J(t)?Fr:t.constructor;if(m!=g&&!(st(m)&&m instanceof m&&st(g)&&g instanceof g))return!1}o||(o=[]),s||(s=[]);for(var _=o.length;_--;)if(o[_]==e)return s[_]==t;var x=0;if(c=!0,o.push(e),s.push(t),v){if(_=e.length,x=t.length,c=x==e.length,!c&&!l)return c;for(;x--;){var b=_,y=t[x];if(l)for(;b--&&!(c=at(e[b],y,n,a,o,s)););else if(!(c=at(e[x],y,n,a,o,s)))break}return c}return Pn(t,function(t,i,u){return Qr.call(u,i)?(x++,c=Qr.call(e,i)&&at(e[i],t,n,a,o,s)):r}),c&&!l&&Pn(e,function(e,t,n){return Qr.call(n,t)?c=--x>-1:r}),c}function ot(e){return an(e)&&!on(parseFloat(e))}function st(e){return"function"==typeof e}function ut(e){return e?D[typeof e]:!1}function lt(e){return ft(e)&&e!=+e}function ct(e){return null===e}function ft(e){return"number"==typeof e||tn.call(e)==P}function ht(e){return e instanceof kr||tn.call(e)==R}function dt(e){return"string"==typeof e||tn.call(e)==N}function pt(e){return e===r}function vt(e,t,n){var a=arguments,o=0,s=2;if(!ut(e))return e;if(n===u)var l=a[3],c=a[4],f=a[5];else c=[],f=[],"number"!=typeof n&&(s=a.length),s>3&&"function"==typeof a[s-2]?l=i.createCallback(a[--s-1],a[s--],2):s>2&&"function"==typeof a[s-1]&&(l=a[--s]);for(;s>++o;)(bn(a[o])?Ot:Mn)(a[o],function(t,n){var i,a,o=t,s=e[n];if(t&&((a=bn(t))||Rn(t))){for(var h=c.length;h--;)if(i=c[h]==t){s=f[h];break}i||(s=a?bn(s)?s:[]:Rn(s)?s:{},l&&(o=l(s,t),o!==r&&(s=o)),c.push(t),f.push(s),l||(s=vt(s,t,u,l,c,f)))}else l&&(o=l(s,t),o===r&&(o=t)),o!==r&&(s=o);e[n]=s});return e}function mt(e,t,r){var n="function"==typeof t,a={};if(n)t=i.createCallback(t,r);else var o=Jr.apply(Vr,arguments);return Pn(e,function(e,r,i){(n?!t(e,r,i):0>qt(o,r,1))&&(a[r]=e)}),a}function gt(e){for(var t=-1,r=En(e),n=r.length,i=Sr(n);n>++t;){var a=r[t];i[t]=[a,e[a]]}return i}function _t(e,t,r){var n={};if("function"!=typeof t)for(var a=0,o=Jr.apply(Vr,arguments),s=ut(e)?o.length:0;s>++a;){var u=o[a];u in e&&(n[u]=e[u])}else t=i.createCallback(t,r),Pn(e,function(e,r,i){t(e,r,i)&&(n[r]=e)});return n}function xt(e){for(var t=-1,r=En(e),n=r.length,i=Sr(n);n>++t;)i[t]=e[r[t]];return i}function bt(e){var t=-1,r=Jr.apply(Vr,j(arguments,1)),n=r.length,i=Sr(n);for(vn.unindexedChars&&dt(e)&&(e=e.split(""));n>++t;)i[t]=e[r[t]];return i}function yt(e,t,n){var i=-1,a=e?e.length:0,o=!1;return n=(0>n?un(0,a+n):n)||0,"number"==typeof a?o=(dt(e)?e.indexOf(t,n):qt(e,t,n))>-1:Tn(e,function(e){return++i>=n?!(o=e===t):r}),o}function Et(e,t,r){var n={};return t=i.createCallback(t,r),Ot(e,function(e,r,i){r=Wr(t(e,r,i)),Qr.call(n,r)?n[r]++:n[r]=1}),n}function Tt(e,t,r){var n=!0;if(t=i.createCallback(t,r),bn(e))for(var a=-1,o=e.length;o>++a&&(n=!!t(e[a],a,e)););else Tn(e,function(e,r,i){return n=!!t(e,r,i)});return n}function wt(e,t,r){var n=[];if(t=i.createCallback(t,r),bn(e))for(var a=-1,o=e.length;o>++a;){var s=e[a];t(s,a,e)&&n.push(s)}else Tn(e,function(e,r,i){t(e,r,i)&&n.push(e)});return n}function At(e,t,n){if(t=i.createCallback(t,n),!bn(e)){var a;return Tn(e,function(e,n,i){return t(e,n,i)?(a=e,!1):r}),a}for(var o=-1,s=e.length;s>++o;){var u=e[o];if(t(u,o,e))return u}}function Ot(e,t,n){if(t&&n===r&&bn(e))for(var i=-1,a=e.length;a>++i&&t(e[i],i,e)!==!1;);else Tn(e,t,n);return e}function It(e,t,r){var n={};return t=i.createCallback(t,r),Ot(e,function(e,r,i){r=Wr(t(e,r,i)),(Qr.call(n,r)?n[r]:n[r]=[]).push(e)}),n}function Pt(e,t){var r=j(arguments,2),n=-1,i="function"==typeof t,a=e?e.length:0,o=Sr("number"==typeof a?a:0);return Ot(e,function(e){o[++n]=(i?t:e[t]).apply(e,r)}),o}function Mt(e,t,r){var n=-1,a=e?e.length:0,o=Sr("number"==typeof a?a:0);if(t=i.createCallback(t,r),bn(e))for(;a>++n;)o[n]=t(e[n],n,e);else Tn(e,function(e,r,i){o[++n]=t(e,r,i)});return o}function Rt(e,t,r){var n=-1/0,a=n;if(!t&&bn(e))for(var o=-1,s=e.length;s>++o;){var u=e[o];u>a&&(a=u)}else t=!t&&dt(e)?B:i.createCallback(t,r),Tn(e,function(e,r,i){var o=t(e,r,i);o>n&&(n=o,a=e)});return a}function Nt(e,t,r){var n=1/0,a=n;if(!t&&bn(e))for(var o=-1,s=e.length;s>++o;){var u=e[o];a>u&&(a=u)}else t=!t&&dt(e)?B:i.createCallback(t,r),Tn(e,function(e,r,i){var o=t(e,r,i);n>o&&(n=o,a=e)});return a}function St(e,t,r,n){var a=3>arguments.length;if(t=i.createCallback(t,n,4),bn(e)){var o=-1,s=e.length;for(a&&(r=e[++o]);s>++o;)r=t(r,e[o],o,e)}else Tn(e,function(e,n,i){r=a?(a=!1,e):t(r,e,n,i)});return r}function Dt(e,t,r,n){var a=e,o=e?e.length:0,s=3>arguments.length;if("number"!=typeof o){var u=En(e);o=u.length}else vn.unindexedChars&&dt(e)&&(a=e.split(""));return t=i.createCallback(t,n,4),Ot(e,function(e,n,i){n=u?u[--o]:--o,r=s?(s=!1,a[n]):t(r,a[n],n,i)}),r}function Lt(e,t,r){return t=i.createCallback(t,r),wt(e,function(e,r,n){return!t(e,r,n)})}function Ct(e){var t=-1,r=e?e.length:0,n=Sr("number"==typeof r?r:0);return Ot(e,function(e){var r=Yr(fn()*(++t+1));n[t]=n[r],n[r]=e}),n}function Bt(e){var t=e?e.length:0;return"number"==typeof t?t:En(e).length}function Ut(e,t,r){var n;if(t=i.createCallback(t,r),bn(e))for(var a=-1,o=e.length;o>++a&&!(n=t(e[a],a,e)););else Tn(e,function(e,r,i){return!(n=t(e,r,i))});return!!n}function Ft(e,t,r){var n=-1,a=e?e.length:0,o=Sr("number"==typeof a?a:0);for(t=i.createCallback(t,r),Ot(e,function(e,r,i){o[++n]={criteria:t(e,r,i),index:n,value:e}}),a=o.length,o.sort(U);a--;)o[a]=o[a].value;return o}function kt(e){return e&&"number"==typeof e.length?vn.unindexedChars&&dt(e)?e.split(""):j(e):xt(e)}function Wt(e){for(var t=-1,r=e?e.length:0,n=[];r>++t;){var i=e[t];i&&n.push(i)}return n}function Ht(e){for(var t=-1,r=e?e.length:0,n=Jr.apply(Vr,arguments),i=o(n,r,100),a=[];r>++t;){var s=e[t];i(s)||a.push(s)}return a}function Vt(e,t,r){var n=-1,a=e?e.length:0;for(t=i.createCallback(t,r);a>++n;)if(t(e[n],n,e))return n;return-1}function Gt(e,t,r){if(e){var n=0,a=e.length;if("number"!=typeof t&&null!=t){var o=-1;for(t=i.createCallback(t,r);a>++o&&t(e[o],o,e);)n++}else if(n=t,null==n||r)return e[0];return j(e,0,ln(un(0,n),a))}}function zt(e,t,r,n){var a=-1,o=e?e.length:0,s=[];for("boolean"!=typeof t&&null!=t&&(n=r,r=t,t=!1),null!=r&&(r=i.createCallback(r,n));o>++a;){var u=e[a];r&&(u=r(u,a,e)),bn(u)?Kr.apply(s,t?u:zt(u)):s.push(u)}return s}function qt(e,t,r){var n=-1,i=e?e.length:0;if("number"==typeof r)n=(0>r?un(0,i+r):r||0)-1;else if(r)return n=Kt(e,t),e[n]===t?n:-1;for(;i>++n;)if(e[n]===t)return n;return-1}function jt(e,t,r){if(!e)return[];var n=0,a=e.length;if("number"!=typeof t&&null!=t){var o=a;for(t=i.createCallback(t,r);o--&&t(e[o],o,e);)n++}else n=null==t||r?1:t||n;return j(e,0,ln(un(0,a-n),a))}function Xt(e){var t=arguments,r=t.length,n={0:{}},i=-1,a=e?e.length:0,s=a>=100,u=[],l=u;e:for(;a>++i;){var c=e[i];if(s)var f=Wr(c),h=Qr.call(n[0],f)?!(l=n[0][f]):l=n[0][f]=[];if(h||0>qt(l,c)){s&&l.push(c);for(var d=r;--d;)if(!(n[d]||(n[d]=o(t[d],0,100)))(c))continue e;u.push(c)}}return u}function Jt(e,t,r){if(e){var n=0,a=e.length;if("number"!=typeof t&&null!=t){var o=a;for(t=i.createCallback(t,r);o--&&t(e[o],o,e);)n++}else if(n=t,null==n||r)return e[a-1];return j(e,un(0,a-n))}}function Yt(e,t,r){var n=e?e.length:0;for("number"==typeof r&&(n=(0>r?un(0,n+r):ln(r,n-1))+1);n--;)if(e[n]===t)return n;return-1}function Zt(e,t,r){e=+e||0,r=+r||1,null==t&&(t=e,e=0);for(var n=-1,i=un(0,jr((t-e)/r)),a=Sr(i);i>++n;)a[n]=e,e+=r;return a}function Qt(e,t,r){if("number"!=typeof t&&null!=t){var n=0,a=-1,o=e?e.length:0;for(t=i.createCallback(t,r);o>++a&&t(e[a],a,e);)n++}else n=null==t||r?1:un(0,t);return j(e,n)}function Kt(e,t,r,n){var a=0,o=e?e.length:a;for(r=r?i.createCallback(r,n,1):br,t=r(t);o>a;){var s=a+o>>>1;t>r(e[s])?a=s+1:o=s}return a}function $t(){return er(Jr.apply(Vr,arguments))}function er(e,t,r,n){var a=-1,o=e?e.length:0,s=[],u=s;"boolean"!=typeof t&&null!=t&&(n=r,r=t,t=!1);var l=!t&&o>=75;if(l)var c={};for(null!=r&&(u=[],r=i.createCallback(r,n));o>++a;){var f=e[a],h=r?r(f,a,e):f;if(l)var d=Wr(h),p=Qr.call(c,d)?!(u=c[d]):u=c[d]=[];(t?!a||u[u.length-1]!==h:p||0>qt(u,h))&&((r||l)&&u.push(h),s.push(f))}return s}function tr(e){for(var t=-1,r=e?e.length:0,n=o(arguments,1,30),i=[];r>++t;){var a=e[t];n(a)||i.push(a)}return i}function rr(e){for(var t=-1,r=e?Rt(Nn(arguments,"length")):0,n=Sr(r);r>++t;)n[t]=Nn(arguments,t);return n}function nr(e,t){for(var r=-1,n=e?e.length:0,i={};n>++r;){var a=e[r];t?i[a]=t[r]:i[a[0]]=a[1]}return i}function ir(e,t){return 1>e?t():function(){return 1>--e?t.apply(this,arguments):r}}function ar(e,t){return vn.fastBind||rn&&arguments.length>2?rn.call.apply(rn,arguments):F(e,t,j(arguments,2))}function or(e){for(var t=Jr.apply(Vr,arguments),r=t.length>1?0:(t=K(e),-1),n=t.length;n>++r;){var i=t[r];e[i]=ar(e[i],e)}return e}function sr(e,t){return F(e,t,j(arguments,2),u)}function ur(){var e=arguments;return function(){for(var t=arguments,r=e.length;r--;)t=[e[r].apply(this,t)];return t[0]}}function lr(e,t,n){if(null==e)return br;var i=typeof e;if("function"!=i){if("object"!=i)return function(t){return t[e]};var a=En(e);return function(t){for(var r=a.length,n=!1;r--&&(n=at(t[a[r]],e[a[r]],u)););return n}}return t!==r?1===n?function(r){return e.call(t,r)}:2===n?function(r,n){return e.call(t,r,n)}:4===n?function(r,n,i,a){return e.call(t,r,n,i,a)}:function(r,n,i){return e.call(t,r,n,i)}:e}function cr(e,t,r){function n(){s=null,r||(a=e.apply(o,i))}var i,a,o,s;return function(){var u=r&&!s;return i=arguments,o=this,Xr(s),s=en(n,t),u&&(a=e.apply(o,i)),a}}function fr(e){var t=j(arguments,1);return en(function(){e.apply(r,t)},1)}function hr(e,t){var n=j(arguments,2);return en(function(){e.apply(r,n)},t)}function dr(e,t){var r={};return function(){var n=Wr(t?t.apply(this,arguments):arguments[0]);return Qr.call(r,n)?r[n]:r[n]=e.apply(this,arguments)}}function pr(e){var t,r;return function(){return t?r:(t=!0,r=e.apply(this,arguments),e=null,r)}}function vr(e){return F(e,j(arguments,1))}function mr(e){return F(e,j(arguments,1),null,u)}function gr(e,t){function r(){s=new Lr,o=null,i=e.apply(a,n)}var n,i,a,o,s=0;return function(){var u=new Lr,l=t-(u-s);return n=arguments,a=this,0>=l?(Xr(o),o=null,s=u,i=e.apply(a,n)):o||(o=en(r,l)),i}}function _r(e,t){return function(){var r=[e];return Kr.apply(r,arguments),t.apply(this,r)}}function xr(e){return null==e?"":Wr(e).replace(_,H)}function br(e){return e}function yr(e){Ot(K(e),function(t){var r=i[t]=e[t];i.prototype[t]=function(){var e=this.__wrapped__,t=[e];Kr.apply(t,arguments);var n=r.apply(i,t);return e&&"object"==typeof e&&e==n?this:new G(n)}})}function Er(){return n._=zr,this}function Tr(e,t){return null==e&&null==t&&(t=1),e=+e||0,null==t&&(t=e,e=0),e+Yr(fn()*((+t||0)-e+1))}function wr(e,t){var n=e?e[t]:r;return st(n)?e[t]():n}function Ar(e,t,n){var a=i.templateSettings;e||(e=""),n=In({},n,a);var o,s=In({},n.imports,a.imports),u=En(s),h=xt(s),p=0,m=n.interpolate||g,_="__p += '",b=kr((n.escape||g).source+"|"+m.source+"|"+(m===v?d:g).source+"|"+(n.evaluate||g).source+"|$","g");e.replace(b,function(t,r,n,i,a,s){return n||(n=i),_+=e.slice(p,s).replace(x,W),r&&(_+="' +\n__e("+r+") +\n'"),a&&(o=!0,_+="';\n"+a+";\n__p += '"),n&&(_+="' +\n((__t = ("+n+")) == null ? '' : __t) +\n'"),p=s+t.length,t}),_+="';\n";var y=n.variable,T=y;T||(y="obj",_="with ("+y+") {\n"+_+"\n}\n"),_=(o?_.replace(l,""):_).replace(c,"$1").replace(f,"$1;"),_="function("+y+") {\n"+(T?"":y+" || ("+y+" = {});\n")+"var __t, __p = '', __e = _.escape"+(o?", __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n":";\n")+_+"return __p\n}";var w="\n/*\n//@ sourceURL="+(n.sourceURL||"/lodash/template/source["+E++ +"]")+"\n*/";try{var A=Cr(u,"return "+_+w).apply(r,h)}catch(O){throw O.source=_,O}return t?A(t):(A.source=_,A)}function Or(e,t,r){e=(e=+e)>-1?e:0;var n=-1,a=Sr(e);for(t=i.createCallback(t,r,1);e>++n;)a[n]=t(n);return a}function Ir(e){return null==e?"":Wr(e).replace(h,X)}function Pr(e){var t=++s;return Wr(null==e?"":e)+t}function Mr(e,t){return t(e),e}function Rr(){return Wr(this.__wrapped__)}function Nr(){return this.__wrapped__}n=n?C.defaults(e.Object(),n,C.pick(e,b)):e;var Sr=n.Array,Dr=n.Boolean,Lr=n.Date,Cr=n.Function,Br=n.Math,Ur=n.Number,Fr=n.Object,kr=n.RegExp,Wr=n.String,Hr=n.TypeError,Vr=Sr(),Gr=Fr(),zr=n._,qr=kr("^"+Wr(Gr.valueOf).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/valueOf|for [^\]]+/g,".+?")+"$"),jr=Br.ceil,Xr=n.clearTimeout,Jr=Vr.concat,Yr=Br.floor,Zr=qr.test(Zr=Fr.getPrototypeOf)&&Zr,Qr=Gr.hasOwnProperty,Kr=Vr.push,$r=n.setImmediate,en=n.setTimeout,tn=Gr.toString,rn=qr.test(rn=j.bind)&&rn,nn=qr.test(nn=Sr.isArray)&&nn,an=n.isFinite,on=n.isNaN,sn=qr.test(sn=Fr.keys)&&sn,un=Br.max,ln=Br.min,cn=n.parseInt,fn=Br.random,hn=qr.test(n.attachEvent),dn=rn&&!/\n|true/.test(rn+hn),pn={};pn[w]=Sr,pn[A]=Dr,pn[O]=Lr,pn[M]=Fr,pn[P]=Ur,pn[R]=kr,pn[N]=Wr;var vn=i.support={};(function(){var e=function(){this.x=1},t={0:1,length:1},r=[];e.prototype={valueOf:1,y:1};for(var n in new e)r.push(n);for(n in arguments);vn.argsObject=arguments.constructor==Fr,vn.argsClass=J(arguments),vn.enumPrototypes=e.propertyIsEnumerable("prototype"),vn.fastBind=rn&&!dn,vn.ownLast="x"!=r[0],vn.nonEnumArgs=0!=n,vn.nonEnumShadows=!/valueOf/.test(r),vn.spliceObjects=(Vr.splice.call(t,0,1),!t[0]),vn.unindexedChars="xx"!="x"[0]+Fr("x")[0];try{vn.nodeClass=!(tn.call(document)==M&&!({toString:0}+""))}catch(i){vn.nodeClass=!0}})(1),i.templateSettings={escape:/<%-([\s\S]+?)%>/g,evaluate:/<%([\s\S]+?)%>/g,interpolate:v,variable:"",imports:{_:i}};var mn=function(e){var t="var index, iterable = "+e.firstArg+", result = "+e.init+";\nif (!iterable) return result;\n"+e.top+";\n";if(e.arrays?(t+="var length = iterable.length; index = -1;\nif ("+e.arrays+") {  ",vn.unindexedChars&&(t+="\n  if (isString(iterable)) {\n    iterable = iterable.split('')\n  }  "),t+="\n  while (++index < length) {\n    "+e.loop+"\n  }\n}\nelse {  "):vn.nonEnumArgs&&(t+="\n  var length = iterable.length; index = -1;\n  if (length && isArguments(iterable)) {\n    while (++index < length) {\n      index += '';\n      "+e.loop+"\n    }\n  } else {  "),vn.enumPrototypes&&(t+="\n  var skipProto = typeof iterable == 'function';\n  "),e.useHas&&e.useKeys)t+="\n  var ownIndex = -1,\n      ownProps = objectTypes[typeof iterable] ? keys(iterable) : [],\n      length = ownProps.length;\n\n  while (++ownIndex < length) {\n    index = ownProps[ownIndex];\n    ",vn.enumPrototypes&&(t+="if (!(skipProto && index == 'prototype')) {\n  "),t+=e.loop,vn.enumPrototypes&&(t+="}\n"),t+="  }  ";else if(t+="\n  for (index in iterable) {",(vn.enumPrototypes||e.useHas)&&(t+="\n    if (",vn.enumPrototypes&&(t+="!(skipProto && index == 'prototype')"),vn.enumPrototypes&&e.useHas&&(t+=" && "),e.useHas&&(t+="hasOwnProperty.call(iterable, index)"),t+=") {    "),t+=e.loop+";    ",(vn.enumPrototypes||e.useHas)&&(t+="\n    }"),t+="\n  }    ",vn.nonEnumShadows){t+="\n\n  var ctor = iterable.constructor;\n      ";for(var r=0;7>r;r++)t+="\n  index = '"+e.shadowedProps[r]+"';\n  if (","constructor"==e.shadowedProps[r]&&(t+="!(ctor && ctor.prototype === iterable) && "),t+="hasOwnProperty.call(iterable, index)) {\n    "+e.loop+"\n  }      "}return(e.arrays||vn.nonEnumArgs)&&(t+="\n}"),t+=e.bottom+";\nreturn result"},gn={args:"object, source, guard",top:"var args = arguments,\n    argsIndex = 0,\n    argsLength = typeof guard == 'number' ? 2 : args.length;\nwhile (++argsIndex < argsLength) {\n  iterable = args[argsIndex];\n  if (iterable && objectTypes[typeof iterable]) {",loop:"if (typeof result[index] == 'undefined') result[index] = iterable[index]",bottom:"  }\n}"},_n={args:"collection, callback, thisArg",top:"callback = callback && typeof thisArg == 'undefined' ? callback : lodash.createCallback(callback, thisArg)",arrays:"typeof length == 'number'",loop:"if (callback(iterable[index], index, collection) === false) return result"},xn={top:"if (!objectTypes[typeof iterable]) return result;\n"+_n.top,arrays:!1};G.prototype=i.prototype,vn.argsClass||(J=function(e){return e?Qr.call(e,"callee"):!1});var bn=nn||function(e){return vn.argsObject&&e instanceof Sr||tn.call(e)==w},yn=k({args:"object",init:"[]",top:"if (!(objectTypes[typeof object])) return result",loop:"result.push(index)",arrays:!1}),En=sn?function(e){return ut(e)?vn.enumPrototypes&&"function"==typeof e||vn.nonEnumArgs&&e.length&&J(e)?yn(e):sn(e):[]}:yn,Tn=k(_n),wn={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},An=et(wn),On=k(gn,{top:gn.top.replace(";",";\nif (argsLength > 3 && typeof args[argsLength - 2] == 'function') {\n  var callback = lodash.createCallback(args[--argsLength - 1], args[argsLength--], 2);\n} else if (argsLength > 2 && typeof args[argsLength - 1] == 'function') {\n  callback = args[--argsLength];\n}"),loop:"result[index] = callback ? callback(result[index], iterable[index]) : iterable[index]"}),In=k(gn),Pn=k(_n,xn,{useHas:!1}),Mn=k(_n,xn);st(/x/)&&(st=function(e){return e instanceof Cr||tn.call(e)==I});var Rn=Zr?function(e){if(!e||tn.call(e)!=M||!vn.argsClass&&J(e))return!1;var t=e.valueOf,r="function"==typeof t&&(r=Zr(t))&&Zr(r);return r?e==r||Zr(e)==r:q(e)}:q,Nn=Mt,Sn=wt;dn&&a&&"function"==typeof $r&&(fr=ar($r,n));var Dn=8==cn("08")?cn:function(e,t){return cn(dt(e)?e.replace(m,""):e,t||0)};return i.after=ir,i.assign=On,i.at=bt,i.bind=ar,i.bindAll=or,i.bindKey=sr,i.compact=Wt,i.compose=ur,i.countBy=Et,i.createCallback=lr,i.debounce=cr,i.defaults=In,i.defer=fr,i.delay=hr,i.difference=Ht,i.filter=wt,i.flatten=zt,i.forEach=Ot,i.forIn=Pn,i.forOwn=Mn,i.functions=K,i.groupBy=It,i.initial=jt,i.intersection=Xt,i.invert=et,i.invoke=Pt,i.keys=En,i.map=Mt,i.max=Rt,i.memoize=dr,i.merge=vt,i.min=Nt,i.omit=mt,i.once=pr,i.pairs=gt,i.partial=vr,i.partialRight=mr,i.pick=_t,i.pluck=Nn,i.range=Zt,i.reject=Lt,i.rest=Qt,i.shuffle=Ct,i.sortBy=Ft,i.tap=Mr,i.throttle=gr,i.times=Or,i.toArray=kt,i.union=$t,i.uniq=er,i.values=xt,i.where=Sn,i.without=tr,i.wrap=_r,i.zip=rr,i.zipObject=nr,i.collect=Mt,i.drop=Qt,i.each=Ot,i.extend=On,i.methods=K,i.object=nr,i.select=wt,i.tail=Qt,i.unique=er,yr(i),i.clone=Y,i.cloneDeep=Z,i.contains=yt,i.escape=xr,i.every=Tt,i.find=At,i.findIndex=Vt,i.findKey=Q,i.has=$,i.identity=br,i.indexOf=qt,i.isArguments=J,i.isArray=bn,i.isBoolean=tt,i.isDate=rt,i.isElement=nt,i.isEmpty=it,i.isEqual=at,i.isFinite=ot,i.isFunction=st,i.isNaN=lt,i.isNull=ct,i.isNumber=ft,i.isObject=ut,i.isPlainObject=Rn,i.isRegExp=ht,i.isString=dt,i.isUndefined=pt,i.lastIndexOf=Yt,i.mixin=yr,i.noConflict=Er,i.parseInt=Dn,i.random=Tr,i.reduce=St,i.reduceRight=Dt,i.result=wr,i.runInContext=t,i.size=Bt,i.some=Ut,i.sortedIndex=Kt,i.template=Ar,i.unescape=Ir,i.uniqueId=Pr,i.all=Tt,i.any=Ut,i.detect=At,i.foldl=St,i.foldr=Dt,i.include=yt,i.inject=St,Mn(i,function(e,t){i.prototype[t]||(i.prototype[t]=function(){var t=[this.__wrapped__];return Kr.apply(t,arguments),e.apply(i,t)})}),i.first=Gt,i.last=Jt,i.take=Gt,i.head=Gt,Mn(i,function(e,t){i.prototype[t]||(i.prototype[t]=function(t,r){var n=e(this.__wrapped__,t,r);return null==t||r&&"function"!=typeof t?n:new G(n)})}),i.VERSION="1.1.1",i.prototype.toString=Rr,i.prototype.value=Nr,i.prototype.valueOf=Nr,Tn(["join","pop","shift"],function(e){var t=Vr[e];i.prototype[e]=function(){return t.apply(this.__wrapped__,arguments)}}),Tn(["push","reverse","sort","unshift"],function(e){var t=Vr[e];i.prototype[e]=function(){return t.apply(this.__wrapped__,arguments),this}}),Tn(["concat","slice","splice"],function(e){var t=Vr[e];i.prototype[e]=function(){return new G(t.apply(this.__wrapped__,arguments))}}),vn.spliceObjects||Tn(["pop","shift","splice"],function(e){var t=Vr[e],r="splice"==e;i.prototype[e]=function(){var e=this.__wrapped__,n=t.apply(e,arguments);return 0===e.length&&delete e[0],r?new G(n):n}}),i}var r,i="object"==typeof exports&&exports,a="object"==typeof module&&module&&module.exports==i&&module,o="object"==typeof global&&global;o.global===o&&(e=o);var s=0,u={},l=/\b__p \+= '';/g,c=/\b(__p \+=) '' \+/g,f=/(__e\(.*?\)|\b__t\)) \+\n'';/g,h=/&(?:amp|lt|gt|quot|#39);/g,d=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,p=/\w*$/,v=/<%=([\s\S]+?)%>/g,m=/^0+(?=.$)/,g=/($^)/,_=/[&<>"']/g,x=/['\n\r\t\u2028\u2029\\]/g,b=["Array","Boolean","Date","Function","Math","Number","Object","RegExp","String","_","attachEvent","clearTimeout","isFinite","isNaN","parseInt","setImmediate","setTimeout"],y=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],E=0,T="[object Arguments]",w="[object Array]",A="[object Boolean]",O="[object Date]",I="[object Function]",P="[object Number]",M="[object Object]",R="[object RegExp]",N="[object String]",S={};S[I]=!1,S[T]=S[w]=S[A]=S[O]=S[P]=S[M]=S[R]=S[N]=!0;var D={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,undefined:!1},L={"\\":"\\","'":"'","\n":"n","\r":"r","	":"t","\u2028":"u2028","\u2029":"u2029"},C=t();"function"==typeof n&&"object"==typeof n.amd&&n.amd?(e._=C,n("_",[],function(){return C})):i&&!i.nodeType?a?(a.exports=C)._=C:i._=C:e._=C}(this),n("core/base",["require","./mixin/derive","./mixin/notifier","./mixin/dirty","./cache","_"],function(e){var t=e("./mixin/derive"),r=e("./mixin/notifier"),n=e("./mixin/dirty"),i=e("./cache"),a=e("_"),o=function(){this.cache=new i};return a.extend(o,t),a.extend(o.prototype,r),a.extend(o.prototype,n),o}),function(e){var t={};"undefined"==typeof exports?"function"==typeof n&&"object"==typeof n.amd&&n.amd?(t.exports={},n("glmatrix",[],function(){return t.exports})):t.exports="undefined"!=typeof window?window:e:t.exports=exports,function(e){if(!t)var t=1e-6;if(!r)var r="undefined"!=typeof Float32Array?Float32Array:Array;if(!n)var n=Math.random;var i={};i.setMatrixArrayType=function(e){r=e},e!==void 0&&(e.glMatrix=i);var a={};a.create=function(){var e=new r(2);return e[0]=0,e[1]=0,e},a.clone=function(e){var t=new r(2);return t[0]=e[0],t[1]=e[1],t},a.fromValues=function(e,t){var n=new r(2);return n[0]=e,n[1]=t,n},a.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e},a.set=function(e,t,r){return e[0]=t,e[1]=r,e},a.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e},a.subtract=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e},a.sub=a.subtract,a.multiply=function(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e},a.mul=a.multiply,a.divide=function(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e},a.div=a.divide,a.min=function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e},a.max=function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e},a.scale=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e},a.scaleAndAdd=function(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e},a.distance=function(e,t){var r=t[0]-e[0],n=t[1]-e[1];return Math.sqrt(r*r+n*n)},a.dist=a.distance,a.squaredDistance=function(e,t){var r=t[0]-e[0],n=t[1]-e[1];return r*r+n*n},a.sqrDist=a.squaredDistance,a.length=function(e){var t=e[0],r=e[1];return Math.sqrt(t*t+r*r)},a.len=a.length,a.squaredLength=function(e){var t=e[0],r=e[1];return t*t+r*r},a.sqrLen=a.squaredLength,a.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e},a.normalize=function(e,t){var r=t[0],n=t[1],i=r*r+n*n;return i>0&&(i=1/Math.sqrt(i),e[0]=t[0]*i,e[1]=t[1]*i),e},a.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]},a.cross=function(e,t,r){var n=t[0]*r[1]-t[1]*r[0];return e[0]=e[1]=0,e[2]=n,e},a.lerp=function(e,t,r,n){var i=t[0],a=t[1];return e[0]=i+n*(r[0]-i),e[1]=a+n*(r[1]-a),e},a.random=function(e,t){t=t||1;var r=2*n()*Math.PI;return e[0]=Math.cos(r)*t,e[1]=Math.sin(r)*t,e},a.transformMat2=function(e,t,r){var n=t[0],i=t[1];return e[0]=r[0]*n+r[2]*i,e[1]=r[1]*n+r[3]*i,e},a.transformMat2d=function(e,t,r){var n=t[0],i=t[1];return e[0]=r[0]*n+r[2]*i+r[4],e[1]=r[1]*n+r[3]*i+r[5],e
},a.transformMat3=function(e,t,r){var n=t[0],i=t[1];return e[0]=r[0]*n+r[3]*i+r[6],e[1]=r[1]*n+r[4]*i+r[7],e},a.transformMat4=function(e,t,r){var n=t[0],i=t[1];return e[0]=r[0]*n+r[4]*i+r[12],e[1]=r[1]*n+r[5]*i+r[13],e},a.forEach=function(){var e=a.create();return function(t,r,n,i,a,o){var s,u;for(r||(r=2),n||(n=0),u=i?Math.min(i*r+n,t.length):t.length,s=n;u>s;s+=r)e[0]=t[s],e[1]=t[s+1],a(e,e,o),t[s]=e[0],t[s+1]=e[1];return t}}(),a.str=function(e){return"vec2("+e[0]+", "+e[1]+")"},e!==void 0&&(e.vec2=a);var o={};o.create=function(){var e=new r(3);return e[0]=0,e[1]=0,e[2]=0,e},o.clone=function(e){var t=new r(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},o.fromValues=function(e,t,n){var i=new r(3);return i[0]=e,i[1]=t,i[2]=n,i},o.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},o.set=function(e,t,r,n){return e[0]=t,e[1]=r,e[2]=n,e},o.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e},o.subtract=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e},o.sub=o.subtract,o.multiply=function(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e},o.mul=o.multiply,o.divide=function(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e},o.div=o.divide,o.min=function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e},o.max=function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e},o.scale=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e},o.scaleAndAdd=function(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e},o.distance=function(e,t){var r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(r*r+n*n+i*i)},o.dist=o.distance,o.squaredDistance=function(e,t){var r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2];return r*r+n*n+i*i},o.sqrDist=o.squaredDistance,o.length=function(e){var t=e[0],r=e[1],n=e[2];return Math.sqrt(t*t+r*r+n*n)},o.len=o.length,o.squaredLength=function(e){var t=e[0],r=e[1],n=e[2];return t*t+r*r+n*n},o.sqrLen=o.squaredLength,o.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},o.normalize=function(e,t){var r=t[0],n=t[1],i=t[2],a=r*r+n*n+i*i;return a>0&&(a=1/Math.sqrt(a),e[0]=t[0]*a,e[1]=t[1]*a,e[2]=t[2]*a),e},o.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},o.cross=function(e,t,r){var n=t[0],i=t[1],a=t[2],o=r[0],s=r[1],u=r[2];return e[0]=i*u-a*s,e[1]=a*o-n*u,e[2]=n*s-i*o,e},o.lerp=function(e,t,r,n){var i=t[0],a=t[1],o=t[2];return e[0]=i+n*(r[0]-i),e[1]=a+n*(r[1]-a),e[2]=o+n*(r[2]-o),e},o.random=function(e,t){t=t||1;var r=2*n()*Math.PI,i=2*n()-1,a=Math.sqrt(1-i*i)*t;return e[0]=Math.cos(r)*a,e[1]=Math.sin(r)*a,e[2]=i*t,e},o.transformMat4=function(e,t,r){var n=t[0],i=t[1],a=t[2];return e[0]=r[0]*n+r[4]*i+r[8]*a+r[12],e[1]=r[1]*n+r[5]*i+r[9]*a+r[13],e[2]=r[2]*n+r[6]*i+r[10]*a+r[14],e},o.transformMat3=function(e,t,r){var n=t[0],i=t[1],a=t[2];return e[0]=n*r[0]+i*r[3]+a*r[6],e[1]=n*r[1]+i*r[4]+a*r[7],e[2]=n*r[2]+i*r[5]+a*r[8],e},o.transformQuat=function(e,t,r){var n=t[0],i=t[1],a=t[2],o=r[0],s=r[1],u=r[2],l=r[3],c=l*n+s*a-u*i,f=l*i+u*n-o*a,h=l*a+o*i-s*n,d=-o*n-s*i-u*a;return e[0]=c*l+d*-o+f*-u-h*-s,e[1]=f*l+d*-s+h*-o-c*-u,e[2]=h*l+d*-u+c*-s-f*-o,e},o.forEach=function(){var e=o.create();return function(t,r,n,i,a,o){var s,u;for(r||(r=3),n||(n=0),u=i?Math.min(i*r+n,t.length):t.length,s=n;u>s;s+=r)e[0]=t[s],e[1]=t[s+1],e[2]=t[s+2],a(e,e,o),t[s]=e[0],t[s+1]=e[1],t[s+2]=e[2];return t}}(),o.str=function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"},e!==void 0&&(e.vec3=o);var s={};s.create=function(){var e=new r(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e},s.clone=function(e){var t=new r(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},s.fromValues=function(e,t,n,i){var a=new r(4);return a[0]=e,a[1]=t,a[2]=n,a[3]=i,a},s.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},s.set=function(e,t,r,n,i){return e[0]=t,e[1]=r,e[2]=n,e[3]=i,e},s.add=function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e},s.subtract=function(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e},s.sub=s.subtract,s.multiply=function(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e[3]=t[3]*r[3],e},s.mul=s.multiply,s.divide=function(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e[3]=t[3]/r[3],e},s.div=s.divide,s.min=function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e[3]=Math.min(t[3],r[3]),e},s.max=function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e[3]=Math.max(t[3],r[3]),e},s.scale=function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e},s.scaleAndAdd=function(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e[3]=t[3]+r[3]*n,e},s.distance=function(e,t){var r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2],a=t[3]-e[3];return Math.sqrt(r*r+n*n+i*i+a*a)},s.dist=s.distance,s.squaredDistance=function(e,t){var r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2],a=t[3]-e[3];return r*r+n*n+i*i+a*a},s.sqrDist=s.squaredDistance,s.length=function(e){var t=e[0],r=e[1],n=e[2],i=e[3];return Math.sqrt(t*t+r*r+n*n+i*i)},s.len=s.length,s.squaredLength=function(e){var t=e[0],r=e[1],n=e[2],i=e[3];return t*t+r*r+n*n+i*i},s.sqrLen=s.squaredLength,s.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},s.normalize=function(e,t){var r=t[0],n=t[1],i=t[2],a=t[3],o=r*r+n*n+i*i+a*a;return o>0&&(o=1/Math.sqrt(o),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e[3]=t[3]*o),e},s.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},s.lerp=function(e,t,r,n){var i=t[0],a=t[1],o=t[2],s=t[3];return e[0]=i+n*(r[0]-i),e[1]=a+n*(r[1]-a),e[2]=o+n*(r[2]-o),e[3]=s+n*(r[3]-s),e},s.random=function(e,t){return t=t||1,e[0]=n(),e[1]=n(),e[2]=n(),e[3]=n(),s.normalize(e,e),s.scale(e,e,t),e},s.transformMat4=function(e,t,r){var n=t[0],i=t[1],a=t[2],o=t[3];return e[0]=r[0]*n+r[4]*i+r[8]*a+r[12]*o,e[1]=r[1]*n+r[5]*i+r[9]*a+r[13]*o,e[2]=r[2]*n+r[6]*i+r[10]*a+r[14]*o,e[3]=r[3]*n+r[7]*i+r[11]*a+r[15]*o,e},s.transformQuat=function(e,t,r){var n=t[0],i=t[1],a=t[2],o=r[0],s=r[1],u=r[2],l=r[3],c=l*n+s*a-u*i,f=l*i+u*n-o*a,h=l*a+o*i-s*n,d=-o*n-s*i-u*a;return e[0]=c*l+d*-o+f*-u-h*-s,e[1]=f*l+d*-s+h*-o-c*-u,e[2]=h*l+d*-u+c*-s-f*-o,e},s.forEach=function(){var e=s.create();return function(t,r,n,i,a,o){var s,u;for(r||(r=4),n||(n=0),u=i?Math.min(i*r+n,t.length):t.length,s=n;u>s;s+=r)e[0]=t[s],e[1]=t[s+1],e[2]=t[s+2],e[3]=t[s+3],a(e,e,o),t[s]=e[0],t[s+1]=e[1],t[s+2]=e[2],t[s+3]=e[3];return t}}(),s.str=function(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},e!==void 0&&(e.vec4=s);var u={};u.create=function(){var e=new r(4);return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},u.clone=function(e){var t=new r(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},u.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},u.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},u.transpose=function(e,t){if(e===t){var r=t[1];e[1]=t[2],e[2]=r}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},u.invert=function(e,t){var r=t[0],n=t[1],i=t[2],a=t[3],o=r*a-i*n;return o?(o=1/o,e[0]=a*o,e[1]=-n*o,e[2]=-i*o,e[3]=r*o,e):null},u.adjoint=function(e,t){var r=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=r,e},u.determinant=function(e){return e[0]*e[3]-e[2]*e[1]},u.multiply=function(e,t,r){var n=t[0],i=t[1],a=t[2],o=t[3],s=r[0],u=r[1],l=r[2],c=r[3];return e[0]=n*s+i*l,e[1]=n*u+i*c,e[2]=a*s+o*l,e[3]=a*u+o*c,e},u.mul=u.multiply,u.rotate=function(e,t,r){var n=t[0],i=t[1],a=t[2],o=t[3],s=Math.sin(r),u=Math.cos(r);return e[0]=n*u+i*s,e[1]=n*-s+i*u,e[2]=a*u+o*s,e[3]=a*-s+o*u,e},u.scale=function(e,t,r){var n=t[0],i=t[1],a=t[2],o=t[3],s=r[0],u=r[1];return e[0]=n*s,e[1]=i*u,e[2]=a*s,e[3]=o*u,e},u.str=function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},e!==void 0&&(e.mat2=u);var l={};l.create=function(){var e=new r(6);return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},l.clone=function(e){var t=new r(6);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},l.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},l.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},l.invert=function(e,t){var r=t[0],n=t[1],i=t[2],a=t[3],o=t[4],s=t[5],u=r*a-n*i;return u?(u=1/u,e[0]=a*u,e[1]=-n*u,e[2]=-i*u,e[3]=r*u,e[4]=(i*s-a*o)*u,e[5]=(n*o-r*s)*u,e):null},l.determinant=function(e){return e[0]*e[3]-e[1]*e[2]},l.multiply=function(e,t,r){var n=t[0],i=t[1],a=t[2],o=t[3],s=t[4],u=t[5],l=r[0],c=r[1],f=r[2],h=r[3],d=r[4],p=r[5];return e[0]=n*l+i*f,e[1]=n*c+i*h,e[2]=a*l+o*f,e[3]=a*c+o*h,e[4]=l*s+f*u+d,e[5]=c*s+h*u+p,e},l.mul=l.multiply,l.rotate=function(e,t,r){var n=t[0],i=t[1],a=t[2],o=t[3],s=t[4],u=t[5],l=Math.sin(r),c=Math.cos(r);return e[0]=n*c+i*l,e[1]=-n*l+i*c,e[2]=a*c+o*l,e[3]=-a*l+c*o,e[4]=c*s+l*u,e[5]=c*u-l*s,e},l.scale=function(e,t,r){var n=r[0],i=r[1];return e[0]=t[0]*n,e[1]=t[1]*i,e[2]=t[2]*n,e[3]=t[3]*i,e[4]=t[4]*n,e[5]=t[5]*i,e},l.translate=function(e,t,r){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4]+r[0],e[5]=t[5]+r[1],e},l.str=function(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"},e!==void 0&&(e.mat2d=l);var c={};c.create=function(){var e=new r(9);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},c.fromMat4=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},c.clone=function(e){var t=new r(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},c.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},c.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},c.transpose=function(e,t){if(e===t){var r=t[1],n=t[2],i=t[5];e[1]=t[3],e[2]=t[6],e[3]=r,e[5]=t[7],e[6]=n,e[7]=i}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},c.invert=function(e,t){var r=t[0],n=t[1],i=t[2],a=t[3],o=t[4],s=t[5],u=t[6],l=t[7],c=t[8],f=c*o-s*l,h=-c*a+s*u,d=l*a-o*u,p=r*f+n*h+i*d;return p?(p=1/p,e[0]=f*p,e[1]=(-c*n+i*l)*p,e[2]=(s*n-i*o)*p,e[3]=h*p,e[4]=(c*r-i*u)*p,e[5]=(-s*r+i*a)*p,e[6]=d*p,e[7]=(-l*r+n*u)*p,e[8]=(o*r-n*a)*p,e):null},c.adjoint=function(e,t){var r=t[0],n=t[1],i=t[2],a=t[3],o=t[4],s=t[5],u=t[6],l=t[7],c=t[8];return e[0]=o*c-s*l,e[1]=i*l-n*c,e[2]=n*s-i*o,e[3]=s*u-a*c,e[4]=r*c-i*u,e[5]=i*a-r*s,e[6]=a*l-o*u,e[7]=n*u-r*l,e[8]=r*o-n*a,e},c.determinant=function(e){var t=e[0],r=e[1],n=e[2],i=e[3],a=e[4],o=e[5],s=e[6],u=e[7],l=e[8];return t*(l*a-o*u)+r*(-l*i+o*s)+n*(u*i-a*s)},c.multiply=function(e,t,r){var n=t[0],i=t[1],a=t[2],o=t[3],s=t[4],u=t[5],l=t[6],c=t[7],f=t[8],h=r[0],d=r[1],p=r[2],v=r[3],m=r[4],g=r[5],_=r[6],x=r[7],b=r[8];return e[0]=h*n+d*o+p*l,e[1]=h*i+d*s+p*c,e[2]=h*a+d*u+p*f,e[3]=v*n+m*o+g*l,e[4]=v*i+m*s+g*c,e[5]=v*a+m*u+g*f,e[6]=_*n+x*o+b*l,e[7]=_*i+x*s+b*c,e[8]=_*a+x*u+b*f,e},c.mul=c.multiply,c.translate=function(e,t,r){var n=t[0],i=t[1],a=t[2],o=t[3],s=t[4],u=t[5],l=t[6],c=t[7],f=t[8],h=r[0],d=r[1];return e[0]=n,e[1]=i,e[2]=a,e[3]=o,e[4]=s,e[5]=u,e[6]=h*n+d*o+l,e[7]=h*i+d*s+c,e[8]=h*a+d*u+f,e},c.rotate=function(e,t,r){var n=t[0],i=t[1],a=t[2],o=t[3],s=t[4],u=t[5],l=t[6],c=t[7],f=t[8],h=Math.sin(r),d=Math.cos(r);return e[0]=d*n+h*o,e[1]=d*i+h*s,e[2]=d*a+h*u,e[3]=d*o-h*n,e[4]=d*s-h*i,e[5]=d*u-h*a,e[6]=l,e[7]=c,e[8]=f,e},c.scale=function(e,t,r){var n=r[0],i=r[1];return e[0]=n*t[0],e[1]=n*t[1],e[2]=n*t[2],e[3]=i*t[3],e[4]=i*t[4],e[5]=i*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},c.fromMat2d=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e},c.fromQuat=function(e,t){var r=t[0],n=t[1],i=t[2],a=t[3],o=r+r,s=n+n,u=i+i,l=r*o,c=r*s,f=r*u,h=n*s,d=n*u,p=i*u,v=a*o,m=a*s,g=a*u;return e[0]=1-(h+p),e[3]=c+g,e[6]=f-m,e[1]=c-g,e[4]=1-(l+p),e[7]=d+v,e[2]=f+m,e[5]=d-v,e[8]=1-(l+h),e},c.normalFromMat4=function(e,t){var r=t[0],n=t[1],i=t[2],a=t[3],o=t[4],s=t[5],u=t[6],l=t[7],c=t[8],f=t[9],h=t[10],d=t[11],p=t[12],v=t[13],m=t[14],g=t[15],_=r*s-n*o,x=r*u-i*o,b=r*l-a*o,y=n*u-i*s,E=n*l-a*s,T=i*l-a*u,w=c*v-f*p,A=c*m-h*p,O=c*g-d*p,I=f*m-h*v,P=f*g-d*v,M=h*g-d*m,R=_*M-x*P+b*I+y*O-E*A+T*w;return R?(R=1/R,e[0]=(s*M-u*P+l*I)*R,e[1]=(u*O-o*M-l*A)*R,e[2]=(o*P-s*O+l*w)*R,e[3]=(i*P-n*M-a*I)*R,e[4]=(r*M-i*O+a*A)*R,e[5]=(n*O-r*P-a*w)*R,e[6]=(v*T-m*E+g*y)*R,e[7]=(m*b-p*T-g*x)*R,e[8]=(p*E-v*b+g*_)*R,e):null},c.str=function(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"},e!==void 0&&(e.mat3=c);var f={};f.create=function(){var e=new r(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},f.clone=function(e){var t=new r(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},f.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},f.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},f.transpose=function(e,t){if(e===t){var r=t[1],n=t[2],i=t[3],a=t[6],o=t[7],s=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=r,e[6]=t[9],e[7]=t[13],e[8]=n,e[9]=a,e[11]=t[14],e[12]=i,e[13]=o,e[14]=s}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e},f.invert=function(e,t){var r=t[0],n=t[1],i=t[2],a=t[3],o=t[4],s=t[5],u=t[6],l=t[7],c=t[8],f=t[9],h=t[10],d=t[11],p=t[12],v=t[13],m=t[14],g=t[15],_=r*s-n*o,x=r*u-i*o,b=r*l-a*o,y=n*u-i*s,E=n*l-a*s,T=i*l-a*u,w=c*v-f*p,A=c*m-h*p,O=c*g-d*p,I=f*m-h*v,P=f*g-d*v,M=h*g-d*m,R=_*M-x*P+b*I+y*O-E*A+T*w;return R?(R=1/R,e[0]=(s*M-u*P+l*I)*R,e[1]=(i*P-n*M-a*I)*R,e[2]=(v*T-m*E+g*y)*R,e[3]=(h*E-f*T-d*y)*R,e[4]=(u*O-o*M-l*A)*R,e[5]=(r*M-i*O+a*A)*R,e[6]=(m*b-p*T-g*x)*R,e[7]=(c*T-h*b+d*x)*R,e[8]=(o*P-s*O+l*w)*R,e[9]=(n*O-r*P-a*w)*R,e[10]=(p*E-v*b+g*_)*R,e[11]=(f*b-c*E-d*_)*R,e[12]=(s*A-o*I-u*w)*R,e[13]=(r*I-n*A+i*w)*R,e[14]=(v*x-p*y-m*_)*R,e[15]=(c*y-f*x+h*_)*R,e):null},f.adjoint=function(e,t){var r=t[0],n=t[1],i=t[2],a=t[3],o=t[4],s=t[5],u=t[6],l=t[7],c=t[8],f=t[9],h=t[10],d=t[11],p=t[12],v=t[13],m=t[14],g=t[15];return e[0]=s*(h*g-d*m)-f*(u*g-l*m)+v*(u*d-l*h),e[1]=-(n*(h*g-d*m)-f*(i*g-a*m)+v*(i*d-a*h)),e[2]=n*(u*g-l*m)-s*(i*g-a*m)+v*(i*l-a*u),e[3]=-(n*(u*d-l*h)-s*(i*d-a*h)+f*(i*l-a*u)),e[4]=-(o*(h*g-d*m)-c*(u*g-l*m)+p*(u*d-l*h)),e[5]=r*(h*g-d*m)-c*(i*g-a*m)+p*(i*d-a*h),e[6]=-(r*(u*g-l*m)-o*(i*g-a*m)+p*(i*l-a*u)),e[7]=r*(u*d-l*h)-o*(i*d-a*h)+c*(i*l-a*u),e[8]=o*(f*g-d*v)-c*(s*g-l*v)+p*(s*d-l*f),e[9]=-(r*(f*g-d*v)-c*(n*g-a*v)+p*(n*d-a*f)),e[10]=r*(s*g-l*v)-o*(n*g-a*v)+p*(n*l-a*s),e[11]=-(r*(s*d-l*f)-o*(n*d-a*f)+c*(n*l-a*s)),e[12]=-(o*(f*m-h*v)-c*(s*m-u*v)+p*(s*h-u*f)),e[13]=r*(f*m-h*v)-c*(n*m-i*v)+p*(n*h-i*f),e[14]=-(r*(s*m-u*v)-o*(n*m-i*v)+p*(n*u-i*s)),e[15]=r*(s*h-u*f)-o*(n*h-i*f)+c*(n*u-i*s),e},f.determinant=function(e){var t=e[0],r=e[1],n=e[2],i=e[3],a=e[4],o=e[5],s=e[6],u=e[7],l=e[8],c=e[9],f=e[10],h=e[11],d=e[12],p=e[13],v=e[14],m=e[15],g=t*o-r*a,_=t*s-n*a,x=t*u-i*a,b=r*s-n*o,y=r*u-i*o,E=n*u-i*s,T=l*p-c*d,w=l*v-f*d,A=l*m-h*d,O=c*v-f*p,I=c*m-h*p,P=f*m-h*v;return g*P-_*I+x*O+b*A-y*w+E*T},f.multiply=function(e,t,r){var n=t[0],i=t[1],a=t[2],o=t[3],s=t[4],u=t[5],l=t[6],c=t[7],f=t[8],h=t[9],d=t[10],p=t[11],v=t[12],m=t[13],g=t[14],_=t[15],x=r[0],b=r[1],y=r[2],E=r[3];return e[0]=x*n+b*s+y*f+E*v,e[1]=x*i+b*u+y*h+E*m,e[2]=x*a+b*l+y*d+E*g,e[3]=x*o+b*c+y*p+E*_,x=r[4],b=r[5],y=r[6],E=r[7],e[4]=x*n+b*s+y*f+E*v,e[5]=x*i+b*u+y*h+E*m,e[6]=x*a+b*l+y*d+E*g,e[7]=x*o+b*c+y*p+E*_,x=r[8],b=r[9],y=r[10],E=r[11],e[8]=x*n+b*s+y*f+E*v,e[9]=x*i+b*u+y*h+E*m,e[10]=x*a+b*l+y*d+E*g,e[11]=x*o+b*c+y*p+E*_,x=r[12],b=r[13],y=r[14],E=r[15],e[12]=x*n+b*s+y*f+E*v,e[13]=x*i+b*u+y*h+E*m,e[14]=x*a+b*l+y*d+E*g,e[15]=x*o+b*c+y*p+E*_,e},f.mul=f.multiply,f.translate=function(e,t,r){var n,i,a,o,s,u,l,c,f,h,d,p,v=r[0],m=r[1],g=r[2];return t===e?(e[12]=t[0]*v+t[4]*m+t[8]*g+t[12],e[13]=t[1]*v+t[5]*m+t[9]*g+t[13],e[14]=t[2]*v+t[6]*m+t[10]*g+t[14],e[15]=t[3]*v+t[7]*m+t[11]*g+t[15]):(n=t[0],i=t[1],a=t[2],o=t[3],s=t[4],u=t[5],l=t[6],c=t[7],f=t[8],h=t[9],d=t[10],p=t[11],e[0]=n,e[1]=i,e[2]=a,e[3]=o,e[4]=s,e[5]=u,e[6]=l,e[7]=c,e[8]=f,e[9]=h,e[10]=d,e[11]=p,e[12]=n*v+s*m+f*g+t[12],e[13]=i*v+u*m+h*g+t[13],e[14]=a*v+l*m+d*g+t[14],e[15]=o*v+c*m+p*g+t[15]),e},f.scale=function(e,t,r){var n=r[0],i=r[1],a=r[2];return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*a,e[9]=t[9]*a,e[10]=t[10]*a,e[11]=t[11]*a,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},f.rotate=function(e,r,n,i){var a,o,s,u,l,c,f,h,d,p,v,m,g,_,x,b,y,E,T,w,A,O,I,P,M=i[0],R=i[1],N=i[2],S=Math.sqrt(M*M+R*R+N*N);return t>Math.abs(S)?null:(S=1/S,M*=S,R*=S,N*=S,a=Math.sin(n),o=Math.cos(n),s=1-o,u=r[0],l=r[1],c=r[2],f=r[3],h=r[4],d=r[5],p=r[6],v=r[7],m=r[8],g=r[9],_=r[10],x=r[11],b=M*M*s+o,y=R*M*s+N*a,E=N*M*s-R*a,T=M*R*s-N*a,w=R*R*s+o,A=N*R*s+M*a,O=M*N*s+R*a,I=R*N*s-M*a,P=N*N*s+o,e[0]=u*b+h*y+m*E,e[1]=l*b+d*y+g*E,e[2]=c*b+p*y+_*E,e[3]=f*b+v*y+x*E,e[4]=u*T+h*w+m*A,e[5]=l*T+d*w+g*A,e[6]=c*T+p*w+_*A,e[7]=f*T+v*w+x*A,e[8]=u*O+h*I+m*P,e[9]=l*O+d*I+g*P,e[10]=c*O+p*I+_*P,e[11]=f*O+v*I+x*P,r!==e&&(e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15]),e)},f.rotateX=function(e,t,r){var n=Math.sin(r),i=Math.cos(r),a=t[4],o=t[5],s=t[6],u=t[7],l=t[8],c=t[9],f=t[10],h=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=a*i+l*n,e[5]=o*i+c*n,e[6]=s*i+f*n,e[7]=u*i+h*n,e[8]=l*i-a*n,e[9]=c*i-o*n,e[10]=f*i-s*n,e[11]=h*i-u*n,e},f.rotateY=function(e,t,r){var n=Math.sin(r),i=Math.cos(r),a=t[0],o=t[1],s=t[2],u=t[3],l=t[8],c=t[9],f=t[10],h=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=a*i-l*n,e[1]=o*i-c*n,e[2]=s*i-f*n,e[3]=u*i-h*n,e[8]=a*n+l*i,e[9]=o*n+c*i,e[10]=s*n+f*i,e[11]=u*n+h*i,e},f.rotateZ=function(e,t,r){var n=Math.sin(r),i=Math.cos(r),a=t[0],o=t[1],s=t[2],u=t[3],l=t[4],c=t[5],f=t[6],h=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=a*i+l*n,e[1]=o*i+c*n,e[2]=s*i+f*n,e[3]=u*i+h*n,e[4]=l*i-a*n,e[5]=c*i-o*n,e[6]=f*i-s*n,e[7]=h*i-u*n,e},f.fromRotationTranslation=function(e,t,r){var n=t[0],i=t[1],a=t[2],o=t[3],s=n+n,u=i+i,l=a+a,c=n*s,f=n*u,h=n*l,d=i*u,p=i*l,v=a*l,m=o*s,g=o*u,_=o*l;return e[0]=1-(d+v),e[1]=f+_,e[2]=h-g,e[3]=0,e[4]=f-_,e[5]=1-(c+v),e[6]=p+m,e[7]=0,e[8]=h+g,e[9]=p-m,e[10]=1-(c+d),e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e},f.fromQuat=function(e,t){var r=t[0],n=t[1],i=t[2],a=t[3],o=r+r,s=n+n,u=i+i,l=r*o,c=r*s,f=r*u,h=n*s,d=n*u,p=i*u,v=a*o,m=a*s,g=a*u;return e[0]=1-(h+p),e[1]=c+g,e[2]=f-m,e[3]=0,e[4]=c-g,e[5]=1-(l+p),e[6]=d+v,e[7]=0,e[8]=f+m,e[9]=d-v,e[10]=1-(l+h),e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},f.frustum=function(e,t,r,n,i,a,o){var s=1/(r-t),u=1/(i-n),l=1/(a-o);return e[0]=2*a*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*a*u,e[6]=0,e[7]=0,e[8]=(r+t)*s,e[9]=(i+n)*u,e[10]=(o+a)*l,e[11]=-1,e[12]=0,e[13]=0,e[14]=2*o*a*l,e[15]=0,e},f.perspective=function(e,t,r,n,i){var a=1/Math.tan(t/2),o=1/(n-i);return e[0]=a/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(i+n)*o,e[11]=-1,e[12]=0,e[13]=0,e[14]=2*i*n*o,e[15]=0,e},f.ortho=function(e,t,r,n,i,a,o){var s=1/(t-r),u=1/(n-i),l=1/(a-o);return e[0]=-2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*u,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*l,e[11]=0,e[12]=(t+r)*s,e[13]=(i+n)*u,e[14]=(o+a)*l,e[15]=1,e},f.lookAt=function(e,r,n,i){var a,o,s,u,l,c,h,d,p,v,m=r[0],g=r[1],_=r[2],x=i[0],b=i[1],y=i[2],E=n[0],T=n[1],w=n[2];return t>Math.abs(m-E)&&t>Math.abs(g-T)&&t>Math.abs(_-w)?f.identity(e):(h=m-E,d=g-T,p=_-w,v=1/Math.sqrt(h*h+d*d+p*p),h*=v,d*=v,p*=v,a=b*p-y*d,o=y*h-x*p,s=x*d-b*h,v=Math.sqrt(a*a+o*o+s*s),v?(v=1/v,a*=v,o*=v,s*=v):(a=0,o=0,s=0),u=d*s-p*o,l=p*a-h*s,c=h*o-d*a,v=Math.sqrt(u*u+l*l+c*c),v?(v=1/v,u*=v,l*=v,c*=v):(u=0,l=0,c=0),e[0]=a,e[1]=u,e[2]=h,e[3]=0,e[4]=o,e[5]=l,e[6]=d,e[7]=0,e[8]=s,e[9]=c,e[10]=p,e[11]=0,e[12]=-(a*m+o*g+s*_),e[13]=-(u*m+l*g+c*_),e[14]=-(h*m+d*g+p*_),e[15]=1,e)},f.str=function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"},e!==void 0&&(e.mat4=f);var h={};h.create=function(){var e=new r(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},h.rotationTo=function(){var e=o.create(),t=o.fromValues(1,0,0),r=o.fromValues(0,1,0);return function(n,i,a){var s=o.dot(i,a);return-.999999>s?(o.cross(e,t,i),1e-6>o.length(e)&&o.cross(e,r,i),o.normalize(e,e),h.setAxisAngle(n,e,Math.PI),n):s>.999999?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):(o.cross(e,i,a),n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=1+s,h.normalize(n,n))}}(),h.setAxes=function(){var e=c.create();return function(t,r,n,i){return e[0]=n[0],e[3]=n[1],e[6]=n[2],e[1]=i[0],e[4]=i[1],e[7]=i[2],e[2]=r[0],e[5]=r[1],e[8]=r[2],h.normalize(t,h.fromMat3(t,e))}}(),h.clone=s.clone,h.fromValues=s.fromValues,h.copy=s.copy,h.set=s.set,h.identity=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},h.setAxisAngle=function(e,t,r){r=.5*r;var n=Math.sin(r);return e[0]=n*t[0],e[1]=n*t[1],e[2]=n*t[2],e[3]=Math.cos(r),e},h.add=s.add,h.multiply=function(e,t,r){var n=t[0],i=t[1],a=t[2],o=t[3],s=r[0],u=r[1],l=r[2],c=r[3];return e[0]=n*c+o*s+i*l-a*u,e[1]=i*c+o*u+a*s-n*l,e[2]=a*c+o*l+n*u-i*s,e[3]=o*c-n*s-i*u-a*l,e},h.mul=h.multiply,h.scale=s.scale,h.rotateX=function(e,t,r){r*=.5;var n=t[0],i=t[1],a=t[2],o=t[3],s=Math.sin(r),u=Math.cos(r);return e[0]=n*u+o*s,e[1]=i*u+a*s,e[2]=a*u-i*s,e[3]=o*u-n*s,e},h.rotateY=function(e,t,r){r*=.5;var n=t[0],i=t[1],a=t[2],o=t[3],s=Math.sin(r),u=Math.cos(r);return e[0]=n*u-a*s,e[1]=i*u+o*s,e[2]=a*u+n*s,e[3]=o*u-i*s,e},h.rotateZ=function(e,t,r){r*=.5;var n=t[0],i=t[1],a=t[2],o=t[3],s=Math.sin(r),u=Math.cos(r);return e[0]=n*u+i*s,e[1]=i*u-n*s,e[2]=a*u+o*s,e[3]=o*u-a*s,e},h.calculateW=function(e,t){var r=t[0],n=t[1],i=t[2];return e[0]=r,e[1]=n,e[2]=i,e[3]=-Math.sqrt(Math.abs(1-r*r-n*n-i*i)),e},h.dot=s.dot,h.lerp=s.lerp,h.slerp=function(e,t,r,n){var i,a,o,s,u,l=t[0],c=t[1],f=t[2],h=t[3],d=r[0],p=r[1],v=r[2],m=r[3];return a=l*d+c*p+f*v+h*m,0>a&&(a=-a,d=-d,p=-p,v=-v,m=-m),1-a>1e-6?(i=Math.acos(a),o=Math.sin(i),s=Math.sin((1-n)*i)/o,u=Math.sin(n*i)/o):(s=1-n,u=n),e[0]=s*l+u*d,e[1]=s*c+u*p,e[2]=s*f+u*v,e[3]=s*h+u*m,e},h.invert=function(e,t){var r=t[0],n=t[1],i=t[2],a=t[3],o=r*r+n*n+i*i+a*a,s=o?1/o:0;return e[0]=-r*s,e[1]=-n*s,e[2]=-i*s,e[3]=a*s,e},h.conjugate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},h.length=s.length,h.len=h.length,h.squaredLength=s.squaredLength,h.sqrLen=h.squaredLength,h.normalize=s.normalize,h.fromMat3=function(){var e="undefined"!=typeof Int8Array?new Int8Array([1,2,0]):[1,2,0];return function(t,r){var n,i=r[0]+r[4]+r[8];if(i>0)n=Math.sqrt(i+1),t[3]=.5*n,n=.5/n,t[0]=(r[7]-r[5])*n,t[1]=(r[2]-r[6])*n,t[2]=(r[3]-r[1])*n;else{var a=0;r[4]>r[0]&&(a=1),r[8]>r[3*a+a]&&(a=2);var o=e[a],s=e[o];n=Math.sqrt(r[3*a+a]-r[3*o+o]-r[3*s+s]+1),t[a]=.5*n,n=.5/n,t[3]=(r[3*s+o]-r[3*o+s])*n,t[o]=(r[3*o+a]+r[3*a+o])*n,t[s]=(r[3*s+a]+r[3*a+s])*n}return t}}(),h.str=function(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},e!==void 0&&(e.quat=h)}(t.exports)}(this),n("2d/style",["require","core/base","_"],function(e){function t(e){return(e||"").replace(/^(\s|\u00A0)+|(\s|\u00A0)+$/g,"")}var r=e("core/base"),n=e("_"),i=["fillStyle","strokeStyle","lineWidth","shadowColor","shadowOffsetX","shadowOffsetY","shadowBlur","globalAlpha","font"],a={fill:"fillStyle",stroke:"strokeStyle",alpha:"globalAlpha",shadow:["shadowOffsetX","shadowOffsetY","shadowBlur","shadowColor"]},o=/([0-9]+)\s+([0-9]+)\s+([0-9]+)\s+([a-zA-Z0-9\(\)\s,#]+)/,s=r.derive({},{bind:function(e){var r=i,s=a;for(var u in s)if(this.hasOwnProperty(u)){var l=s[u],c=this[u];if("shadow"==u){var f=o.exec(t(c));if(!f)continue;c=f.slice(1),n.each(c,function(t,r){l[r]&&(e[l[r]]=t)},this)}else e[l]=c}n.each(r,function(t){this.hasOwnProperty(t)&&(e[t]=this[t])},this)}});return s}),n("2d/node",["require","core/base","glmatrix","./style"],function(e){var t=e("core/base"),r=e("glmatrix"),n=r.vec2,i=r.mat2d,a=e("./style"),o=t.derive(function(){return{__mouseover__:!1,id:0,AABB:[n.fromValues(0,0),n.fromValues(0,0)],z:0,style:null,position:n.fromValues(0,0),rotation:0,scale:n.fromValues(1,1),_transform:i.create(),_transformInverse:i.create(),visible:!0,children:{},intersectLineWidth:0,clip:!1,fill:!0,stroke:!0,fixAA:!0}},function(){this.__GUID__=s()},{updateTransform:function(){var e=this._transform;return i.identity(e),this.scale&&i.scale(e,e,this.scale),this.rotation&&i.rotate(e,e,this.rotation),this.position&&i.translate(e,e,this.position),e},updateTransformInverse:function(){i.invert(this._transformInverse,this._transformInverse)},intersectAABB:function(e,t){var r=this.AABB;return e>r[0][0]&&r[1][0]>e&&t>r[0][1]&&r[1][1]>t},add:function(e){e&&(this.children[e.__GUID__]=e,e.parent=this)},remove:function(e){this.children[e.__GUID__]=null,e.parent=null},draw:function(){},render:function(e){var t=this._getSortedRenderQueue();if(e.save(),this.style)if(!this.style instanceof a)for(var r in this.style)this.style[r].bind(e);else this.style.bind(e);var n=this.updateTransform();e.transform(n[0],n[1],n[2],n[3],n[4],n[5]),this.draw(e),this.clip&&e.clip();for(var i=0;t.length>i;i++)t[i].render(e);e.restore()},traverse:function(e){var t=e&&e(this);if(!t)for(var r=this.children,n=0,i=r.length;i>n;n++)r[n].traverse(e)},intersect:function(){},_getSortedRenderQueue:function(){var e=[];for(var t in this.children)e.push(this.children[t]);return e.sort(function(e,t){return e.z===t.z?e.__GUID__>t.__GUID__?1:-1:e.z>t.z?1:-1}),e}}),s=function(){var e=0;return function(){return++e}}();return o}),n("2d/util",["require"],function(){return{fixPos:function(e){return[e[0]+.5,e[1]+.5]},fixPosArray:function(e){for(var t=[],r=e.length,n=0;r>n;n++)t.push(this.fixPos(e[n]));return t},computeAABB:function(e){for(var t=e[0][0],r=e[0][0],n=e[0][1],i=e[0][1],a=1;e.length>a;a++)t=t>e[a][0]?e[a][0]:t,r=e[a][0]>r?e[a][0]:r,n=n>e[a][1]?e[a][1]:n,i=e[a][1]>i?e[a][1]:i;return[[t,n],[r,i]]}}}),n("2d/renderable/arc",["require","../node","../util","glmatrix"],function(e){var t=e("../node"),r=e("../util"),n=e("glmatrix");n.vec2;var i=t.derive(function(){return{center:[0,0],radius:0,startAngle:0,endAngle:2*Math.PI,clockwise:!0}},{computeAABB:function(){this.AABB=[[0,0],[0,0]]},draw:function(){var e=this.fixAA?r.fixPos(this.center):this.center;ctx.beginPath(),ctx.arc(e[0],e[1],this.radius,this.startAngle,this.endAngle,!this.clockwise),this.stroke&&ctx.stroke(),this.fill&&ctx.fill()},intersect:function(){return!1}});return i}),n("2d/renderable/circle",["require","../node","../util","glmatrix"],function(e){var t=e("../node"),r=e("../util"),n=e("glmatrix"),i=n.vec2,a=t.derive(function(){return{center:[0,0],radius:0}},{computeAABB:function(){this.AABB=[[this.center[0]-this.radius,this.center[1]-this.radius],[this.center[0]+this.radius,this.center[1]+this.radius]]},draw:function(e){var t=this.fixAA?r.fixPos(this.center):this.center;e.beginPath(),e.arc(t[0],t[1],this.radius,0,2*Math.PI,!1),this.stroke&&e.stroke(),this.fill&&e.fill()},intersect:function(){return i.len([this.center[0]-x,this.center[1]-y])<this.radius}});return a}),n("2d/renderable/image",["require","../node","../util","glmatrix"],function(e){var t=e("../node"),r=e("../util"),n=e("glmatrix");n.vec2;var i={},a=t.derive(function(){return{img:"",start:[0,0],size:0,onload:function(){}}},function(){if("string"==typeof this.img){var e=this;this.load(this.img,function(t){e.img=t,e.onload.call(e)})}},{computeAABB:function(){this.AABB=r.computeAABB([this.start,[this.start[0]+this.size[0],this.start[1]+this.size[1]]])},draw:function(e){var t=this.fixAA?r.fixPos(this.start):this.start;"string"!=typeof this.img&&(this.size?e.drawImage(this.img,t[0],t[1],this.size[0],this.size[1]):e.drawImage(this.img,t[0],t[1]))},intersect:function(e,t){return this.intersectAABB(e,t)},load:function(e,t){if(i[e]){var r=i[e];r.constructor==Array?r.push(t):t(r)}else{i[e]=[t];var r=new a;r.onload=function(){each(i[e],function(e){e(r)}),i[e]=r},r.src=e}}});return a}),n("2d/renderable/line",["require","../node","../util","glmatrix"],function(e){var t=e("../node"),r=e("../util"),n=e("glmatrix"),i=n.vec2,a=t.derive(function(){return{start:[0,0],end:[0,0],width:0}},{computeAABB:function(){this.AABB=r.computeAABB([this.start,this.end]),this.AABB[0][0]==this.AABB[1][0]&&(this.AABB[0][0]-=this.width/2,this.AABB[1][0]+=this.width/2),this.AABB[0][1]==this.AABB[1][1]&&(this.AABB[0][1]-=this.width/2,this.AABB[1][1]+=this.width/2)},draw:function(e){var t=this.fixAA?r.fixPos(this.start):this.start,n=this.fixAA?r.fixPos(this.end):this.end;e.beginPath(),e.moveTo(t[0],t[1]),e.lineTo(n[0],n[1]),e.stroke()},intersect:function(e,t){if(!this.intersectAABB(e,t))return!1;var r=[e,t];b=this.start,c=this.end,ba=i.sub([],r,b),bc=i.sub([],c,b);var n=i.dot(bc,ba);i.normalize(bc,bc);var a=i.add(b,i.scale(bc,n)),o=i.length(i.sub(r,r,a));return this.width/2>o}});return a}),n("2d/renderable/path",["require","../node","../util","glmatrix"],function(e){var t=e("../node");e("../util");var r=e("glmatrix"),n=r.vec2,i=t.derive(function(){return{segments:[],globalStyle:!0}},{computeAABB:function(){this.AABB=[[0,0],[0,0]]},draw:function(e){this.globalStyle?this.drawWithSameStyle(e):this.drawWithDifferentStyle(e)},drawWithSameStyle:function(e){var t=this.segments.length,r=this.segments;e.beginPath(),e.moveTo(r[0].point[0],r[0].point[1]);for(var n=1;t>n;n++)if(r[n-1].handleOut||r[n].handleIn){var i=r[n-1].handleOut||r[n-1].point,a=r[n].handleIn||r[n].point;e.bezierCurveTo(i[0],i[1],a[0],a[1],r[n].point[0],r[n].point[1])}else e.lineTo(r[n].point[0],r[n].point[1]);this.fill&&e.fill(),this.stroke&&e.stroke()},drawWithDifferentStyle:function(e){for(var t=this.segments.length,r=this.segments,n=0;t-1>n;n++){if(e.save(),r[n].style&&r[n].style.bind(e),e.beginPath(),e.moveTo(r[n].point[0],r[n].point[1]),r[n].handleOut||r[n+1].handleIn){var i=r[n].handleOut||r[n].point,a=r[n+1].handleIn||r[n+1].point;e.bezierCurveTo(i[0],i[1],a[0],a[1],r[n+1].point[0],r[n+1].point[1])}else e.lineTo(r[n+1].point[0],r[n+1].point[1]);this.stroke&&e.stroke(),this.fill&&e.fill(),e.restore()}},smooth:function(e){function t(e,t,r){var i=n.scale([],n.add([],t,r),.5);return n.sub([],e,i)}for(var r=this.segments.length,i=[],a=this.segments,o=0;r>o;o++){var s=a[o].point,u=o==r-1?a[0].point:a[o+1].point;i.push(n.scale([],n.add([],s,u),.5))}for(var o=0;r>o;o++){var s=a[o].point,l=i[o],c=0==o?i[r-1]:i[o-1],e=a[o].smoothLevel||e||1,f=n.scale([],n.add([],l,c),.5),h=n.sub([],l,f),d=n.sub([],c,f),p=t(s,c,l);n.scale(d,d,e),n.scale(h,h,e),a[o].handleIn=n.add([],n.add([],f,d),p),a[o].handleOut=n.add([],n.add([],f,h),p)}a[0].handleOut=a[0].handleIn=null,a[r-1].handleIn=a[r-1].handleOut=null},pushPoints:function(e){for(var t=0;e.length>t;t++)this.segments.push({point:e[t],handleIn:null,handleOut:null})}});return i}),n("2d/renderable/polygon",["require","../node","../util","glmatrix"],function(e){var t=e("../node"),r=e("../util"),n=e("glmatrix");return n.vec2,t.derive(function(){return{points:[]}},{computeAABB:function(){this.AABB=r.computeAABB(this.points)},draw:function(e){var t=this.fixAA?r.fixPosArray(this.points):this.points;e.beginPath(),e.moveTo(t[0][0],t[0][1]);for(var n=1;t.length>n;n++)e.lineTo(t[n][0],t[n][1]);e.closePath(),this.stroke&&e.stroke(),this.fill&&e.fill()},intersect:function(e,t){if(!this.intersectAABB(e,t))return!1;for(var r,n,i,a,o=this.points.length,s=0,u=this.points,l=0;o>l;l++)r=n.normalize([],[u[l][0]-e,u[l][1]-t]),i=(l+1)%o,n=n.normalize([],[u[i][0]-e,u[i][1]-t]),a=Math.acos(n.dot(r,n)),s+=a;return.001>Math.length(s-2*Math.PI)}}),t
}),n("2d/renderable/rectangle",["require","../node","../util","glmatrix"],function(e){var t=e("../node"),r=e("../util"),n=e("glmatrix"),i=n.vec2,a=t.derive(function(){return{start:[0,0],size:[0,0]}},{computeAABB:function(){var e=i.add([],this.start,this.size);this.AABB=r.computeAABB([this.start,e])},draw:function(e){var t=this.fixAA?r.fixPos(this.start):this.start;e.beginPath(),e.rect(t[0],t[1],this.size[0],this.size[1]),this.stroke&&e.stroke(),this.fill&&e.fill()},intersect:function(e,t){return this.intersectAABB(e,t)}});return a}),n("2d/renderable/roundedrectangle",["require","../node","../util","glmatrix"],function(e){var t=e("../node"),r=e("../util"),n=e("glmatrix"),i=n.vec2,a=t.derive(function(){return{start:[0,0],size:[0,0],radius:0}},{computeAABB:function(){var e=i.add([],this.start,this.size);this.AABB=r.computeAABB([this.start,e])},draw:function(e){if(this.radius.constructor==Number)var t=[this.radius,this.radius,this.radius,this.radius];else if(2==this.radius.length)var t=[this.radius[0],this.radius[1],this.radius[0],this.radius[1]];else var t=this.radius;var n=this.fixAA?r.fixPos(this.start):this.start,a=this.size,o=i.add([],n,[t[0],0]),s=i.add([],n,[a[0],0]),u=i.add([],n,a),l=i.add([],n,[0,a[1]]);e.beginPath(),e.moveTo(o[0],o[1]),t[1]?e.arcTo(s[0],s[1],u[0],u[1],t[1]):e.lineTo(s[0],s[1]),t[2]?e.arcTo(u[0],u[1],l[0],l[1],t[2]):e.lineTo(u[0],u[1]),t[3]?e.arcTo(l[0],l[1],n[0],n[1],t[3]):e.lineTo(l[0],l[1]),t[0]?e.arcTo(n[0],n[1],s[0],s[1],t[0]):e.lineTo(n[0],n[1]),this.stroke&&e.stroke(),this.fill&&e.fill()},intersect:function(){return!1}});return a}),n("2d/renderable/sector",["require","../node","../util","glmatrix"],function(e){var t=e("../node"),r=e("../util"),n=e("glmatrix"),i=n.vec2,a=t.derive(function(){return{center:[0,0],innerRadius:0,outerRadius:0,startAngle:0,endAngle:0,clockwise:!0}},{computeAABB:function(){this.AABB=[0,0]},intersect:function(e,t){var r=this.startAngle,n=this.endAngle,a=this.innerRadius,o=this.outerRadius,s=this.center,u=i.sub([],[e,t],s),l=i.length(u),c=2*Math.PI;if(a>l||l>o)return!1;var f=Math.atan2(u[1],u[0]);return 0>f&&(f+=c),this.clockwise?n>f&&f>r:(r=c-r,n=c-n,f>n&&r>f)},draw:function(e){var t=this.startAngle,n=this.endAngle,a=this.innerRadius,o=this.outerRadius,s=this.fixAA?r.fixPos(this.center):this.center;this.clockwise||(t=2*Math.PI-t,n=2*Math.PI-n);var u=i.add([],s,[a*Math.cos(t),a*Math.sin(t)]),l=i.add([],s,[o*Math.cos(t),o*Math.sin(t)]),c=i.add([],s,[a*Math.cos(n),a*Math.sin(n)]);i.add([],s,[o*Math.cos(n),o*Math.sin(n)]),e.beginPath(),e.moveTo(u[0],u[1]),e.lineTo(l[0],l[1]),e.arc(s[0],s[1],o,t,n,!this.clockwise),e.lineTo(c[0],c[1]),e.arc(s[0],s[1],a,n,t,this.clockwise),e.endPath(),this.stroke&&e.stroke(),this.fill&&e.fill()}});return a}),n("2d/renderable/text",["require","../node","../util","glmatrix"],function(e){var t=e("../node"),r=e("../util"),n=e("glmatrix");n.vec2;var i=t.derive(function(){return{text:"",start:[0,0],size:[0,0],font:"",textAlign:"",textBaseline:""}},{computeAABB:function(){this.AABB=r.computeAABB([this.start,[this.start[0]+this.size[0],this.start[1]+this.size[1]]])},draw:function(e){var t=this.fixAA?r.fixPos(this.start):this.start;this.font&&(e.font=this.font),this.textAlign&&(e.textAlign=this.textAlign),this.textBaseline&&(e.textBaseline=this.textBaseline),this.fill&&(this.size.length&&this.size[0]?e.fillText(this.text,t[0],t[1],this.size[0]):e.fillText(this.text,t[0],t[1])),this.stroke&&(this.size.length&&this.size[0]?e.strokeText(this.text,t[0],t[1],this.size[0]):e.strokeText(this.text,t[0],t[1]))},resize:function(e){(!this.size[0]||this.needResize)&&(this.size[0]=e.measureText(this.text).width,this.size[1]=e.measureText("m").width)},intersect:function(e,t){return this.intersectAABB(e,t)}});return i}),n("2d/renderable/textbox",["require","../node","../util","glmatrix","./text","_"],function(e){var t=e("../node");e("../util");var r=e("glmatrix"),n=r.vec2,i=e("./text"),a=e("_"),o=t.derive(function(){return{text:"",textAlign:"",textBaseline:"top",font:"",start:[0,0],width:0,wordWrap:!1,wordBreak:!1,lineHeight:0,stroke:!1,_texts:[]}},function(){this._oldText=""},{computeAABB:function(){},draw:function(e){if(this.text!=this._oldText)if(this._oldText=this.text,this.font&&(e.font=this.font),this.wordBreak)this._texts=this.computeWordBreak(e);else if(this.wordWrap)this._texts=this.computeWordWrap(e);else{var t=new i({text:this.text,textBaseline:this.textBaseline});this.extendCommonProperties(t),this._texts=[t]}a.each(this._texts,function(t){t.draw(e)})},computeWordWrap:function(e){if(this.text){for(var t,r,a,o=this.text.split(" "),s=o.length,u=0,l=[],c=0;s>c;c++)r=c==s-1?o[c]:o[c]+" ",t=e.measureText(r).width,u+t>this.width||!a?(a=new i({text:r,start:n.add([],this.start,[0,this.lineHeight*l.length])}),this.extendCommonProperties(a),l.push(a),u=t):(u+=t,a.text+=r);return l}},computeWordBreak:function(e){if(this.text){for(var t,r,a,o=this.text.length,s=e.measureText(this.text[0]).width,u=[],l=0;o>l;l++)if(r=this.text[l],t=e.measureText(r).width,s+t>this.width||!a){var a=new i({text:r,start:n.add([],this.start,[0,this.lineHeight*u.length])});this.extendCommonProperties(a),u.push(a),s=t}else s+=t,a.text+=r;return u}},extendCommonProperties:function(e){a.extend(e,{textAlign:this.textAlign,textBaseline:this.textBaseline,style:this.style,font:this.font,fill:this.fill,stroke:this.stroke})},intersect:function(){}});return o}),n("2d/renderer",["require","core/base"],function(e){var t=e("core/base"),r=t.derive(function(){return{canvas:null,context:null,width:0,height:0,_latestRenderedScene:null}},function(){this.canvas||(this.canvas=document.createElement("canvas")),this.canvas.addEventListener("click",this._clickHandler.bind(this)),this.canvas.addEventListener("mousedown",this._mouseDownHandler.bind(this)),this.canvas.addEventListener("mouseup",this._mouseUpHandler.bind(this)),this.canvas.addEventListener("mousemove",this._mouseMoveHandler.bind(this)),this.canvas.addEventListener("mouseout",this._mouseOutHandler.bind(this)),this.width?this.canvas.width=this.width:this.width=this.canvas.width,this.height?this.canvas.height=this.height:this.height=this.canvas.height,this.context=this.canvas.getContext("2d")},{resize:function(e,t){this.canvas.width=e,this.canvas.height=t},render:function(e){this.context.clearRect(0,0,this.width,this.height),e.render(this.context),this._latestRenderedScene=e},_clickHandler:function(){this._latestRenderedScene},_mouseDownHandler:function(){},_mouseUpHandler:function(){},_mouseMoveHandler:function(){},_mouseOutHandler:function(){}});return r}),n("2d/scene",["require","./node"],function(e){var t=e("./node"),r=t.derive(function(){return{}},{});return r}),n("util/util",["require"],function(){return{genGUID:function(){var e=0;return function(){return++e}}()}}),n("3d/node",["require","core/base","glmatrix","util/util","_"],function(e){var t=e("core/base"),r=e("glmatrix"),n=r.vec3,i=r.quat,a=r.mat3,o=r.mat4,s=e("util/util"),u=e("_"),l=t.derive(function(){return{__GUID__:s.genGUID(),visible:!0,position:n.create(),rotation:n.create(),eulerOrder:["X","Y","Z"],scale:n.fromValues(1,1,1),up:n.fromValues(0,1,0),quaternion:i.create(),useQuaternion:!1,children:[],parent:null,worldMatrix:o.create(),matrix:o.create(),autoUpdate:!0}},{x:function(e){return 0===arguments.length?this.position[0]:(this.position[0]=e,this.dirty("matrix"),this)},y:function(e){return 0===arguments.length?this.position[1]:(this.position[1]=e,this.dirty("matrix"),this)},z:function(e){return 0===arguments.length?this.position[2]:(this.position[2]=e,this.dirty("matrix"),this)},roll:function(e){return 0===arguments.length?this.rotation[0]:(this.rotation[0]=e,this.dirty("matrix"),this)},pitch:function(e){return 0===arguments.length?this.rotation[1]:(this.rotation[1]=e,this.dirty("matrix"),this)},yaw:function(e){return 0===arguments.length?this.rotation[2]:(this.rotation[2]=e,this.dirty("matrix"),this)},lookAt:function(){var e=o.create();return function(t){o.lookAt(e,t,this.position,this.up),this.updateFromLookAtMatrix(e)}}(),updateFromLookAtMatrix:function(){var e=a.create();return function(t){function r(e){return Math.min(Math.max(e,-1),1)}if(this.useQuaternion)a.fromMat4(e,t),i.fromMat3(this.quaternion,e);else{var o,s,u,l=t,c=l[0],f=l[1],h=l[2],d=l[4],p=l[5],v=l[6],m=l[8],g=l[9],_=l[10],x=this.eulerOrder.join("");"XYZ"===x?(s=Math.asin(r(h)),.99999>Math.abs(h)?(o=Math.atan2(-v,_),u=Math.atan2(-f,c)):(o=Math.atan2(g,p),u=0)):"YXZ"===x?(o=Math.asin(-r(v)),.99999>Math.abs(v)?(s=Math.atan2(h,_),u=Math.atan2(d,p)):(s=Math.atan2(-m,c),u=0)):"ZXY"===x?(o=Math.asin(r(g)),.99999>Math.abs(g)?(s=Math.atan2(-m,_),u=Math.atan2(-f,p)):(s=0,u=Math.atan2(d,c))):"ZYX"===x?(s=Math.asin(-r(m)),.99999>Math.abs(m)?(o=Math.atan2(g,_),u=Math.atan2(d,c)):(o=0,u=Math.atan2(-f,p))):"YZX"===x?(u=Math.asin(r(d)),.99999>Math.abs(d)?(o=Math.atan2(-v,p),s=Math.atan2(-m,c)):(o=0,s=Math.atan2(h,_))):"XZY"===x&&(u=Math.asin(-r(f)),.99999>Math.abs(f)?(o=Math.atan2(g,p),s=Math.atan2(h,c)):(o=Math.atan2(-v,_),s=0)),n.set(this.rotation,o,s,u)}this.dirty("matrix")}}(),add:function(e){this.children.indexOf(e)>=0||(this.children.push(e),e.parent=this)},remove:function(e){u.without(this.children,e),e.parent=null},traverse:function(e){var t=e&&e(this);if(!t)for(var r=this.children,n=0,i=r.length;i>n;n++)r[n].traverse(e)},updateMatrix:function(){var e=o.create();return function(){var t=this.matrix;if(o.identity(t),o.translate(t,t,this.position),this.useQuaternion)o.fromQuat(e,this.quaternion),o.multiply(t,t,e);else for(var r=0;3>r;r++){var n=this.eulerOrder[r].toUpperCase(),i=["X","Y","Z"],a=i.indexOf(n);o["rotate"+n](t,t,this.rotation[a])}o.scale(t,t,this.scale)}}(),updateWorldMatrix:function(){(this.isDirty("matrix")||this.autoUpdate)&&(this.updateMatrix(),this.fresh("matrix")),this.parent?o.multiply(this.worldMatrix,this.parent.worldMatrix,this.matrix):o.copy(this.worldMatrix,this.matrix)},update:function(e,t){t||this.trigger("beforeupdate",e),this.updateWorldMatrix(),t||this.trigger("afterupdate",e);for(var r=0;this.children.length>r;r++){var n=this.children[r];n.visible&&n.update(e)}},getWorldPosition:function(){var e=this.worldMatrix;return n.fromValues(e[12],e[13],e[14])}});return l}),n("3d/camera",["require","./node","glmatrix"],function(e){var t=e("./node"),r=e("glmatrix"),n=r.mat4;r.vec3;var i=t.derive(function(){return{projectionMatrix:n.create()}},function(){this.update()},{update:function(e){t.prototype.update.call(this,e),this.updateProjectionMatrix()},lookAt:function(){var e=n.create();return function(t){n.lookAt(e,this.position,t,this.up),this.updateFromLookAtMatrix(e)}}()});return i}),n("3d/camera/orthographic",["require","../camera","glmatrix"],function(e){var t=e("../camera"),r=e("glmatrix"),n=r.mat4,i=t.derive(function(){return{left:-1,right:1,near:0,far:1,top:1,bottom:-1}},{updateProjectionMatrix:function(){n.ortho(this.projectionMatrix,this.left,this.right,this.bottom,this.top,this.near,this.far)}});return i}),n("3d/camera/perspective",["require","../camera","glmatrix"],function(e){var t=e("../camera"),r=e("glmatrix"),n=r.mat4,i=t.derive(function(){return{fov:50,aspect:1,near:.1,far:2e3}},{updateProjectionMatrix:function(){var e=this.fov/180*Math.PI;n.perspective(this.projectionMatrix,e,this.aspect,this.near,this.far)}});return i}),n("3d/compositor/graph/graph",["require","core/base","_"],function(e){var t=e("core/base"),r=e("_"),n=t.derive(function(){return{_nodes:[],_finalNode:null}},{add:function(e){this._nodes.push(e),this.dirty("graph")},remove:function(e){r.without(this._nodes,e),this.dirty("graph")},update:function(){for(var e=0;this._nodes.length>e;e++)this._nodes[e].clear();for(var e=0;this._nodes.length>e;e++){var t=this._nodes[e];if(t.inputs){for(var r in t.inputs){var n=t.inputs[r],i=this.findPin(n);i?t.link(r,i.node,i.pin):console.warn("Pin of "+n.node+"."+n.pin+" not exist")}t.outputs||(this._finalNode=t)}}},findPin:function(e){for(var t,r=0;this._nodes.length>r;r++){var n=this._nodes[r];n.name===e.node&&(t=n)}return t&&t.outputs[e.pin]?{node:t,pin:e.pin}:void 0},load:function(){},render:function(e){this.isDirty("graph")&&(this.update(),this.fresh("graph"));for(var t=0;this._nodes.length>t;t++)this._nodes[t].updateReference();this._finalNode&&this._finalNode.render(e)}});return n}),n("3d/scene",["require","./node"],function(e){var t=e("./node"),r=t.derive(function(){return{material:null,lightNumber:{},lightUniforms:{},filter:null}},{});return r}),n("3d/geometry",["require","core/base","util/util","glmatrix","_"],function(e){var t=e("core/base"),r=e("util/util"),n=e("glmatrix"),i=n.vec3;n.vec2,n.mat2;var a=n.mat4;e("_");var o=Array.prototype.slice,s=t.derive(function(){return{__GUID__:r.genGUID(),attributes:{position:{type:"float",semantic:"POSITION",size:3,value:[]},texcoord0:{type:"float",semantic:"TEXCOORD_0",size:2,value:[]},texcoord1:{type:"float",semantic:"TEXCOORD_1",size:2,value:[]},normal:{type:"float",semantic:"NORMAL",size:3,value:[]},tangent:{type:"float",semantic:"TANGENT",size:4,value:[]},color:{type:"float",semantic:"COLOR",size:3,value:[]},barycentric:{type:"float",size:3,value:[]}},_verticesNumber:0,useFaces:!0,faces:[],hint:"STATIC_DRAW",chunkSize:65535,_normalType:"vertex",_arrayChunks:[],_verticesReorganizedMap:[],_reorganizedFaces:[]}},{dirty:function(e){if(e)for(var t in this.cache._caches)this.cache._caches[t]["dirty_"+e]=!0;else{this.dirty("indices");for(var r in this.attributes)this.dirty(r)}},getVerticesNumber:function(){return this._verticesNumber=this.attributes.position.value.length,this._verticesNumber},getEnabledAttributes:function(){var e={},t=this.getVerticesNumber();for(var r in this.attributes){var n=this.attributes[r];n.value&&n.value.length&&n.value.length===t&&(e[r]=n)}return e},getDirtyAttributes:function(){var e={};this.getVerticesNumber();var t=this.getEnabledAttributes(),r=!0;for(var n in t)t[n],(this.cache.get("dirty_"+n)||this.cache.miss("dirty_"+n))&&(e[n]=t[n],r=!1);return r?void 0:e},getChunkNumber:function(){return this._arrayChunks.length},getBufferChunks:function(e){this.cache.use(e.__GUID__+"_dirty");var t=this.cache.getContext(),r=this.getDirtyAttributes(),n=this.cache.get("dirty_faces")||this.cache.miss("dirty_faces");if(r){this._updateAttributesAndIndicesArrays(r,n),this._updateBuffer(e,r,n);for(var i in r)t["dirty_"+i]=!1}return this.cache.use(e.__GUID__+"_buffers"),this.cache.get("chunks")},_updateAttributesAndIndicesArrays:function(e,t){var r=this,n={},i=this.getVerticesNumber(),a=this._verticesReorganizedMap,o={};for(var s in e){switch(B){case"byte":o[s]=Int8Array;break;case"ubyte":o[s]=Uint8Array;break;case"short":o[s]=Int16Array;break;case"ushort":o[s]=Uint16Array;break;default:o[s]=Float32Array}n[s]=0}var u=function(t){if(r._arrayChunks[t])return r._arrayChunks[t];var o={attributeArrays:{},indicesArray:null};for(var s in e)o.attributeArrays[s]=null;for(var s in n)n[s]=0;for(var u=0;i>u;u++)a[u]=-1;return r._arrayChunks.push(o),o},l=Object.keys(e);if(i>this.chunkSize&&this.useFaces){var c,f=0,h=0,d=[0],p=[];for(v=0;i>v;v++)p[v]=-1,a[v]=-1;if(t&&this._reorganizedFaces.length!==this.faces.length)for(v=0;this.faces.length>v;v++)this._reorganizedFaces[v]=[0,0,0];c=u(h);for(var v=0;this.faces.length>v;v++){var m=this.faces[v],g=this._reorganizedFaces[v],_=m[0],x=m[1],b=m[2];f+3>this.chunkSize&&(h++,d[h]=v,f=0,c=u(h));for(var y=-1===a[_],E=-1===a[x],T=-1===a[b],w=0;l.length>w;w++){var s=l[w],A=c.attributeArrays[s],O=e[s].value,I=e[s].size;if(A||(A=c.attributeArrays[s]=[]),1===I)y&&(A[n[s]++]=O[_]),E&&(A[n[s]++]=O[x]),T&&(A[n[s]++]=O[b]);else{if(y)for(var P=0;I>P;P++)A[n[s]++]=O[_][P];if(E)for(var P=0;I>P;P++)A[n[s]++]=O[x][P];if(T)for(var P=0;I>P;P++)A[n[s]++]=O[b][P]}}y?(a[_]=f,g[0]=f,f++):g[0]=a[_],E?(a[x]=f,g[1]=f,f++):g[1]=a[x],T?(a[b]=f,g[2]=f,f++):g[2]=a[b]}for(var M=0;this._arrayChunks.length>M;M++){var R=this._arrayChunks[M];for(var s in R.attributeArrays){var N=R.attributeArrays[s];N instanceof Array&&(R.attributeArrays[s]=new o[s](N))}}if(t)for(var S,D,L,R,M=0;this._arrayChunks.length>M;M++){S=d[M],D=d[M+1]||this.faces.length,L=0,R=this._arrayChunks[M];var C=R.indicesArray;C||(C=R.indicesArray=new Uint16Array(3*(D-S)));for(var v=S;D>v;v++)C[L++]=this._reorganizedFaces[v][0],C[L++]=this._reorganizedFaces[v][1],C[L++]=this._reorganizedFaces[v][2]}}else{var R=u(0);if(this.useFaces){var C=R.indicesArray;C||(C=R.indicesArray=new Uint16Array(3*this.faces.length));for(var L=0,v=0;this.faces.length>v;v++)C[L++]=this.faces[v][0],C[L++]=this.faces[v][1],C[L++]=this.faces[v][2]}for(var s in e){var O=e[s].value,B=e[s].type,I=e[s].size,A=R.attributeArrays[s];if(A||(A=R.attributeArrays[s]=new o[s](i*I)),1===I)for(var v=0;O.length>v;v++)A[v]=O[v];else for(var L=0,v=0;O.length>v;v++)for(var P=0;I>P;P++)A[L++]=O[v][P]}}},_updateBuffer:function(e,t,r){this.cache.use(e.__GUID__+"_buffers");var n=this.cache.get("chunks");if(!n){n=[];for(var i=0;this._arrayChunks.length>i;i++)n[i]={attributeBuffers:{},indicesBuffer:null};this.cache.put("chunks",n)}for(var i=0;n.length>i;i++){var a=n[i];a||(a=n[i]={attributeBuffers:{},indicesBuffer:null});var o=a.attributeBuffers,s=a.indicesBuffer,u=this._arrayChunks[i],l=u.attributeArrays,c=u.indicesArray;for(var f in t){var h,d=t[f],p=(d.value,d.type),v=d.semantic,m=d.size,g=o[f];h=g?g.buffer:e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,h),e.bufferData(e.ARRAY_BUFFER,l[f],e[this.hint]),o[f]={type:p,buffer:h,size:m,semantic:v}}r&&this.useFaces&&(s||(s=a.indicesBuffer={buffer:e.createBuffer(),count:c.length}),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s.buffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,c,e[this.hint]))}},generateVertexNormals:function(){var e=this.faces,t=(e.length,this.attributes.position.value),r=this.attributes.normal.value,n=i.create();v12=i.create(),v23=i.create(),t.length-r.length;for(var a=0;r.length>a;a++)i.set(r[a],0,0,0);for(var a=r.length;t.length>a;a++)r[a]=[0,0,0];for(var o=0;this.faces.length>o;o++){var s=e[o],u=s[0],l=s[1],c=s[2],f=t[u],h=t[l],d=t[c];i.sub(v12,f,h),i.sub(v23,h,d),i.cross(n,v12,v23),i.add(r[u],r[u],n),i.add(r[l],r[l],n),i.add(r[c],r[c],n)}for(var a=0;r.length>a;a++)i.normalize(r[a],r[a]);this._normalType="vertex"},generateFaceNormals:function(){this.isUniqueVertex()||this.generateUniqueVertex();var e=this.faces,t=e.length,r=this.attributes.position.value,n=this.attributes.normal.value,a=i.create();v12=i.create(),v23=i.create();for(var s=n.length===r.length,u=0;t>u;u++){var l=e[u],c=l[0],f=l[1],h=l[2],d=r[c],p=r[f],v=r[h];i.sub(v12,d,p),i.sub(v23,p,v),i.cross(a,v12,v23),s?(i.copy(n[c],a),i.copy(n[f],a),i.copy(n[h],a)):n[c]=n[f]=n[h]=o.call(a)}this._normalType="face"},generateTangents:function(){for(var e=this.attributes.texcoord0.value,t=this.attributes.position.value,r=this.attributes.tangent.value,n=this.attributes.normal.value,a=[],o=[],s=this.getVerticesNumber(),u=0;s>u;u++)a[u]=[0,0,0],o[u]=[0,0,0];for(var l=[0,0,0],c=[0,0,0],u=0;this.faces.length>u;u++){var f=this.faces[u],h=f[0],d=f[1],p=f[2],v=e[h],m=e[d],g=e[p],_=t[h],x=t[d],b=t[p],y=x[0]-_[0],E=b[0]-_[0],T=x[1]-_[1],w=b[1]-_[1],A=x[2]-_[2],O=b[2]-_[2],I=m[0]-v[0],P=g[0]-v[0],M=m[1]-v[1],R=g[1]-v[1],N=1/(I*R-M*P);l[0]=(R*y-M*E)*N,l[1]=(R*T-M*w)*N,l[2]=(R*A-M*O)*N,c[0]=(I*E-P*y)*N,c[1]=(I*w-P*T)*N,c[2]=(I*O-P*A)*N,i.add(a[h],a[h],l),i.add(a[d],a[d],l),i.add(a[p],a[p],l),i.add(o[h],o[h],c),i.add(o[d],o[d],c),i.add(o[p],o[p],c)}for(var S=[0,0,0,0],D=[0,0,0],u=0;s>u;u++){var L=n[u],C=a[u];i.scale(S,L,i.dot(L,C)),i.sub(S,C,S),i.normalize(S,S),i.cross(D,L,C),S[3]=0>i.dot(D,o[u])?-1:1,r[u]=S.slice()}},isUniqueVertex:function(){return this.faces.length&&this.useFaces?this.getVerticesNumber()===3*this.faces.length:!0},generateUniqueVertex:function(){function e(e){for(var t in i){var r=i[t].value,n=r[0].length||1;1===n?r.push(r[e]):r.push(o.call(r[e]))}}for(var t=[],r=0;this.getVerticesNumber()>r;r++)t[r]=0;for(var n=this.getVerticesNumber(),i=this.getEnabledAttributes(),a=this.faces,r=0;a.length>r;r++){var s=a[r],u=s[0],l=s[1],c=s[2];t[u]>0&&(e(u),s[0]=n,n++),t[l]>0&&(e(l),s[1]=n,n++),t[c]>0&&(e(c),s[2]=n,n++),t[u]++,t[l]++,t[c]++}this.dirty()},generateBarycentric:function(){var e=[1,0,0],t=[0,0,1],r=[0,1,0];return function(){this.isUniqueVertex()||this.generateUniqueVertex();var n=this.attributes.barycentric.value;if(n.length!=3*this.faces.length)for(var i,a,o,s,u=0;this.faces.length>u;u++)s=this.faces[u],i=s[0],a=s[1],o=s[2],n[i]=e,n[a]=t,n[o]=r}}(),applyMatrix:function(e){for(var t=this.attributes.position.value,r=this.attributes.normal.value,n=0;t.length>n;n++)i.transformMat4(t[n],t[n],e);var o=a.create();a.invert(o,e),a.transpose(o,o);for(var n=0;r.length>n;n++)i.transformMat4(r[n],r[n],o)},dispose:function(){}});return s}),n("3d/geometry/plane",["require","../geometry"],function(e){var t=e("../geometry"),r=t.derive(function(){return{widthSegments:1,heightSegments:1}},function(){for(var e=this.heightSegments,t=this.widthSegments,r=this.attributes.position.value,n=this.attributes.texcoord0.value,i=this.attributes.normal.value,a=this.faces,o=0;e>=o;o++)for(var s=o/e,u=0;t>=u;u++){var l=u/t;if(r.push([2*l-1,2*s-1,0]),n&&n.push([l,s]),i&&i.push([0,0,1]),t>u&&e>o){var c=u+o*(t+1);a.push([c,c+1,c+t+1]),a.push([c+t+1,c+1,c+t+2])}}});return r}),n("3d/shader",["require","core/base","glmatrix","util/util","_"],function(e){function t(e){for(var t=e.split("\n"),r=0,n=t.length;n>r;r++)t[r]=r+1+": "+t[r];return t.join("\n")}var r=e("core/base"),n=e("glmatrix"),i=n.mat2;mat3=n.mat3,mat4=n.mat4,vec2=n.vec2,vec3=n.vec3,vec4=n.vec4,util=e("util/util"),_=e("_");var a=/uniform\s+(bool|float|int|vec2|vec3|vec4|ivec2|ivec3|ivec4|mat2|mat3|mat4|sampler2D|samplerCube)\s+(\w+)?(\[.*?\])?\s*(:\s*([\S\s]+?))?;/g,o=/attribute\s+(float|int|vec2|vec3|vec4)\s+(\w*)\s*(:\s*(\w+))?;/g,s={bool:"1i","int":"1i",sampler2D:"t",samplerCube:"t","float":"1f",vec2:"2f",vec3:"3f",vec4:"4f",ivec2:"2i",ivec3:"3i",ivec4:"4i",mat2:"m2",mat3:"m3",mat4:"m4"},u={bool:function(){return!0},"int":function(){return 0},"float":function(){return 0},sampler2D:function(){return null},samplerCube:function(){return null},vec2:function(){return new Float32Array(2)},vec3:function(){return new Float32Array(3)},vec4:function(){return new Float32Array(4)},ivec2:function(){return new Int32Array(2)},ivec3:function(){return new Int32Array(3)},ivec4:function(){return new Int32Array(4)},mat2:function(){return i.create()},mat3:function(){return mat3.create()},mat4:function(){return mat4.create()},array:function(){return[]}},l=["POSITION","NORMAL","BINORMAL","TANGENT","TEXCOORD","TEXCOORD_0","TEXCOORD_1","COLOR","WORLD","VIEW","PROJECTION","WORLDVIEW","VIEWPROJECTION","WORLDVIEWPROJECTION","WORLDINVERSE","VIEWINVERSE","PROJECTIONINVERSE","WORLDVIEWINVERSE","VIEWPROJECTIONINVERSE","WORLDVIEWPROJECTIONINVERSE","WORLDTRANSPOSE","VIEWTRANSPOSE","PROJECTIONTRANSPOSE","WORLDVIEWTRANSPOSE","VIEWPROJECTIONTRANSPOSE","WORLDVIEWPROJECTIONTRANSPOSE","WORLDINVERSETRANSPOSE","VIEWINVERSETRANSPOSE","PROJECTIONINVERSETRANSPOSE","WORLDVIEWINVERSETRANSPOSE","VIEWPROJECTIONINVERSETRANSPOSE","WORLDVIEWPROJECTIONINVERSETRANSPOSE"],c={},f={},h=r.derive(function(){return{__GUID__:util.genGUID(),vertex:"",fragment:"",precision:"mediump",semantics:{},uniformTemplates:{},attributeTemplates:{},vertexDefines:{},fragmentDefines:{},lightNumber:{},_vextureStatus:{},_vertexProcessed:"",_fragmentProcessed:"",_program:null}},function(){this.update()},{setVertex:function(e){this.vertex=e,this.update()},setFragment:function(e){this.fragment=e,this.update()},bind:function(e){this.cache.use(e.__GUID__+"_program"),(this.cache.get("dirty")||this.cache.miss("program"))&&(this.cache.clearContext(),this._buildProgram(e,this._vertexProcessed,this._fragmentProcessed),this.cache.put("dirty",!1)),e.useProgram(this.cache.get("program"))},dirty:function(){this.cache.clearAll()},update:function(e){(this.vertex!==this._vertexPrev||this.fragment!==this._fragmentPrev||e)&&(this._parseImport(),this.semantics={},this._textureStatus={},this._parseUniforms(),this._parseAttributes(),this._vertexPrev=this.vertex,this._fragmentPrev=this.fragment),this._addDefine(),this.dirty()},enableTexture:function(e,t){var r=this._textureStatus[e];if(r){var n=r.enabled;if(n)return;r.enabled=!0;var t=t===void 0||!0;t&&this.update()}},enableTexturesAll:function(e){for(var t in this._textureStatus)this._textureStatus[t].enabled=!0;var e=e===void 0||!0;e&&this.update()},disableTexture:function(e,t){var r=this._textureStatus[e];if(r){var n=!r.enabled;if(n)return;r.enabled=!1;var t=t===void 0||!0;t&&this.update()}},disableTexturesAll:function(e,t){for(var e in this._textureStatus)this._textureStatus[e].enabled=!1;var t=t===void 0||!0;t&&this.update()},setUniform:function(e,t,r,n){this.cache.use(e.__GUID__+"_program");var i=this.cache.get("program");this.cache.use(e.__GUID__+"_uniformlocation");var a=this.cache.get(r);if(null!==a){if(!a){if(a=e.getUniformLocation(i,r),null===a)return this.cache.put(r,null),void 0;this.cache.put(r,a)}switch(t){case"1i":e.uniform1i(a,n);break;case"1f":e.uniform1f(a,n);break;case"1fv":e.uniform1fv(a,n);break;case"1iv":e.uniform1iv(a,n);break;case"2iv":e.uniform2iv(a,n);break;case"2fv":e.uniform2fv(a,n);break;case"3iv":e.uniform3iv(a,n);break;case"3fv":e.uniform3fv(a,n);break;case"4iv":e.uniform4iv(a,n);break;case"4fv":e.uniform4fv(a,n);break;case"2i":e.uniform2i(a,n[0],n[1]);break;case"2f":e.uniform2f(a,n[0],n[1]);break;case"3i":e.uniform3i(a,n[0],n[1],n[2]);break;case"3f":e.uniform3f(a,n[0],n[1],n[2]);break;case"4i":e.uniform4i(a,n[0],n[1],n[2],n[3]);break;case"4f":e.uniform4f(a,n[0],n[1],n[2],n[3]);break;case"m2":e.uniformMatrix2fv(a,!1,n);break;case"m3":e.uniformMatrix3fv(a,!1,n);break;case"m4":e.uniformMatrix4fv(a,!1,n);break;case"m2v":var o=4;case"m3v":var o=9;case"m4v":var o=16;if(n instanceof Array){for(var s=new Float32Array(n.length*o),u=0,l=0;n.length>l;l++)for(var c=n[l],f=0;c.length>f;f++)s[u++]=c[f];e.uniformMatrix4fv(a,!1,s)}else n instanceof Float32Array&&e.uniformMatrix4fv(a,!1,n)}}},enableAttributes:function(e,t){this.cache.use(e.__GUID__+"_program");var r=this.cache.get("program");this.cache.use(e.__GUID__+"_attriblocation");var n=this.cache.getContext();"string"==typeof t&&(t=Array.prototype.slice.call(arguments,1));var i=f[e.__GUID__];i||(i=f[e.__GUID__]=[]);for(var a in this.attributeTemplates){var o=n[a];if(o===void 0){if(o=e.getAttribLocation(r,a),-1===o)continue;n[a]=o}t.indexOf(a)>=0?i[o]||(e.enableVertexAttribArray(o),i[o]=!0):i[o]&&(e.disableVertexAttribArray(o),i[o]=!1)}},setMeshAttribute:function(e,t,r){var n,i=r.type,a=r.size;switch(i){case"byte":n=e.BYTE;break;case"ubyte":n=e.UNSIGNED_BYTE;break;case"short":n=e.SHORT;break;case"ushort":n=e.UNSIGNED_SHORT;break;default:n=e.FLOAT}this.cache.use(e.__GUID__+"_program");var o=this.cache.get("program");this.cache.use(e.__GUID__+"_attriblocation");var s=this.cache.get(t);if(this.cache.miss(t)){if(s=e.getAttribLocation(o,t),-1===s)return;this.cache.put(t,s)}this.cache.use(e.__GUID__+"_attribenabled"),e.vertexAttribPointer(s,a,n,!1,0,0)},_parseImport:function(){this._vertexProcessedWithoutDefine=h.parseImport(this.vertex),this._fragmentProcessedWithoutDefine=h.parseImport(this.fragment)},_addDefine:function(){var e=[];_.each(this.lightNumber,function(t,r){t&&e.push("#define "+r.toUpperCase()+"_NUMBER "+t)}),_.each(this._textureStatus,function(t,r){t.enabled&&"vertex"===t.shaderType&&e.push("#define "+r.toUpperCase()+"_ENABLED")}),_.each(this.vertexDefines,function(t,r){null===t?e.push("#define "+r):e.push("#define "+r+" "+(""+t))}),this._vertexProcessed=e.join("\n")+"\n"+this._vertexProcessedWithoutDefine,e=[],_.each(this.lightNumber,function(t,r){t&&e.push("#define "+r+"_NUMBER "+t)}),_.each(this._textureStatus,function(t,r){t.enabled&&"fragment"===t.shaderType&&e.push("#define "+r.toUpperCase()+"_ENABLED")}),_.each(this.fragmentDefines,function(t,r){null===t?e.push("#define "+r):e.push("#define "+r+" "+(""+t))});var t=e.join("\n")+"\n"+this._fragmentProcessedWithoutDefine;this._fragmentProcessed=["precision",this.precision,"float"].join(" ")+";\n"+t},_parseUniforms:function(){function e(e,i,a,o,c,f){if(i&&a){var h=s[i];if(h){if(("sampler2D"===i||"samplerCube"===i)&&(r._textureStatus[a]={enabled:!1,shaderType:n}),o&&(h+="v"),f)if(0>l.indexOf(f)){var d=r._parseDefaultValue(i,f);d?f="":console.warn('Unkown semantic "'+f+'"')}else r.semantics[f]={symbol:a,type:h};t[a]={type:h,value:o?u.array:d||u[i],semantic:f||null}}return["uniform",i,a,o].join(" ")+";\n"}}var t={},r=this,n="vertex";this._vertexProcessedWithoutDefine=this._vertexProcessedWithoutDefine.replace(a,e),n="fragment",this._fragmentProcessedWithoutDefine=this._fragmentProcessedWithoutDefine.replace(a,e),this.uniformTemplates=t},_parseDefaultValue:function(e,t){var r=/\[\s*(.*)\s*\]/;{if("vec2"!==e&&"vec3"!==e&&"vec4"!==e)return"bool"===e?function(){return"true"===t.toLowerCase()?!0:!1}:"float"===e?function(){return parseFloat(t)}:void 0;var n=r.exec(t)[1];if(n){var i=n.split(/\s*,\s*/);return function(){return new Float32Array(i)}}}},createUniforms:function(){var e={};return _.each(this.uniformTemplates,function(t,r){e[r]={type:t.type,value:t.value()}}),e},_parseAttributes:function(){function e(e,n,i,a,o){if(n&&i){var s=1;switch(n){case"vec4":s=4;break;case"vec3":s=3;break;case"vec2":s=2;break;case"float":s=1}t[i]={type:"float",size:s,semantic:o||null},o&&(0>l.indexOf(o)?console.warn('Unkown semantic "'+o+'"'):r.semantics[o]={symbol:i,type:n})}return["attribute",n,i].join(" ")+";\n"}var t={},r=this;this._vertexProcessedWithoutDefine=this._vertexProcessedWithoutDefine.replace(o,e),this.attributeTemplates=t},_buildProgram:function(e,t,r){this.cache.use(e.__GUID__+"_program"),this.cache.get("program")&&e.deleteProgram(this.cache.get("program"));var n=e.createProgram();try{var i=this._compileShader(e,"vertex",t),a=this._compileShader(e,"fragment",r);if(e.attachShader(n,i),e.attachShader(n,a),e.linkProgram(n),!e.getProgramParameter(n,e.LINK_STATUS))throw Error("Could not initialize shader\nVALIDATE_STATUS: "+e.getProgramParameter(n,e.VALIDATE_STATUS)+", gl error ["+e.getError()+"]")}catch(o){if(c[this.__GUID__])return;throw c[this.__GUID__]=this,o}e.deleteShader(i),e.deleteShader(a),this.cache.put("program",n)},_compileShader:function(e,r,n){var i=e.createShader("fragment"===r?e.FRAGMENT_SHADER:e.VERTEX_SHADER);if(e.shaderSource(i,n),e.compileShader(i),!e.getShaderParameter(i,e.COMPILE_STATUS))throw Error([e.getShaderInfoLog(i),t(n)].join("\n"));return i},dispose:function(){}}),d=/(@import)\s*([0-9a-zA-Z_\-\.]*)/g;h.parseImport=function(e){return e=e.replace(d,function(e,t,r){return v[r]?h.parseImport(v[r]):void 0})};var p=/(@export)\s*([0-9a-zA-Z_\-\.]*)\s*\n([\s\S]*?)@end/g;h.import=function(e){e.replace(p,function(e,t,r,n){return v[r]=n,n})};var v={};return h.source=function(e){var t=v[e];return t?t:(console.warn('Shader "'+e+'" not existed in library'),void 0)},h}),n("3d/texture",["require","core/base","_"],function(e){var t=e("core/base");e("_");var r=t.derive(function(){return{width:512,height:512,type:"UNSIGNED_BYTE",format:"RGBA",wrapS:"CLAMP_TO_EDGE",wrapT:"CLAMP_TO_EDGE",minFilter:"LINEAR_MIPMAP_LINEAR",magFilter:"LINEAR",generateMipmaps:!0,anisotropic:1,flipY:!0,unpackAlignment:4,premultiplyAlpha:!1,NPOT:!1}},{getWebGLTexture:function(e){return this.cache.use(e.__GUID__),this.cache.miss("webgl_texture")&&(this.cache.put("webgl_texture",e.createTexture()),this.cache.put("dirty",!0)),this.cache.get("dirty")&&(this.update(e),this.cache.put("dirty",!1)),this.cache.get("webgl_texture")},bind:function(){},unbind:function(){},dirty:function(){for(var e in this.cache._caches)this.cache._caches[e].dirty=!0},update:function(){},beforeUpdate:function(e){e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,this.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,this.unpackAlignment);var t=this.isPowerOfTwo(this.image||{width:this.width,height:this.height});t&&this.generateMipmaps?(this._minFilterOriginal&&(this.minFilter=this._minFilterOriginal),this._magFilterOriginal&&(this.magFilter=this._magFilterOriginal),this._wrapSOriginal&&(this.wrapS=this._wrapSOriginal),this._wrapTOriginal&&(this.wrapT=this._wrapTOriginal)):(this.NPOT=!0,this._minFilterOriginal=this.minFilter,this._magFilterOriginal=this.magFilter,this._wrapSOriginal=this.wrapS,this._wrapTOriginal=this.wrapT,this.minFilter=0==this.minFilter.indexOf("NEARST")?"NEARST":"LINEAR",this.magFilter=0==this.magFilter.indexOf("NEARST")?"NEARST":"LINEAR",this.wrapS="CLAMP_TO_EDGE",this.wrapT="CLAMP_TO_EDGE")
},isPowerOfTwo:function(e){var t=e.width,r=e.height;return 0===(t&t-1)&&0===(r&r-1)},nextHighestPowerOfTwo:function(e){--e;for(var t=1;32>t;t<<=1)e|=e>>t;return e+1},dispose:function(e){this.cache.use(e.__GUID__),e.deleteTexture(this.cache.get("webgl_texture"))}});return r}),n("3d/texture/texture2d",["require","../texture"],function(e){var t=e("../texture"),r=t.derive({image:null,pixels:null},{update:function(e){e.bindTexture(e.TEXTURE_2D,this.cache.get("webgl_texture")),this.beforeUpdate(e);var t=e[this.format.toUpperCase()],r=e[this.type.toUpperCase()];if(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e[this.wrapS.toUpperCase()]),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e[this.wrapT.toUpperCase()]),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e[this.magFilter.toUpperCase()]),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e[this.minFilter.toUpperCase()]),this.cache.miss("anisotropic_ext")){var n=e.getExtension("MOZ_EXT_texture_filter_anisotropic");n||(n=e.getExtension("WEBKIT_EXT_texture_filter_anisotropic")),this.cache.put("anisotropic_ext",n)}else{var n=this.cache.get("anisotropic_ext");n&&e.texParameterf(e.TEXTURE_2D,n.TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropic)}this.image?this.image.width&&e.texImage2D(e.TEXTURE_2D,0,t,t,r,this.image):e.texImage2D(e.TEXTURE_2D,0,t,this.width,this.height,0,t,r,this.pixels),!this.NPOT&&this.generateMipmaps&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null)},bind:function(e){e.bindTexture(e.TEXTURE_2D,this.getWebGLTexture(e))},unbind:function(e){e.bindTexture(e.TEXTURE_2D,null)}});return r}),n("3d/texture/texturecube",["require","../texture","_"],function(e){var t=e("../texture"),r=e("_"),n={px:"TEXTURE_CUBE_MAP_POSITIVE_X",py:"TEXTURE_CUBE_MAP_POSITIVE_Y",pz:"TEXTURE_CUBE_MAP_POSITIVE_Z",nx:"TEXTURE_CUBE_MAP_NEGATIVE_X",ny:"TEXTURE_CUBE_MAP_NEGATIVE_Y",nz:"TEXTURE_CUBE_MAP_NEGATIVE_Z"};t.derive({image:{px:null,nx:null,py:null,ny:null,pz:null,nz:null},pixels:{px:null,nx:null,py:null,ny:null,pz:null,nz:null}},{update:function(e){e.bindTexture(e.TEXTURE_CUBE_MAP,this.cache.get("webgl_texture")),this.beforeUpdate(e);var t=e[this.format.upperCase()],i=e[this.type.upperCase()];if(e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e[this.wrapS.toUpperCase()]),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e[this.wrapT.toUpperCase()]),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e[this.magFilter.toUpperCase()]),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e[this.minFilter.toUpperCase()]),this.cache.miss("anisotropic_ext")){var a=e.getExtension("MOZ_EXT_texture_filter_anisotropic");a||(a=e.getExtension("WEBKIT_EXT_texture_filter_anisotropic")),this.cache.put("anisotropic_ext",null)}else{var a=this.cache.get("anisotropic_ext");a&&e.texParameterf(e.TEXTURE_CUBE_MAP,a.TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropic)}r.each(this.image,function(r,a){r?e.texImage2D(e[n[a]],0,t,t,i,r):e.texImage2D(e[n[a]],0,t,this.width,this.height,0,t,i,this.pixels[a])},this),!this.NPOT&&this.generateMipmaps&&e.generateMipmap(e.TEXTURE_CUBE_MAP),e.bindTexture(e.TEXTURE_CUBE_MAP,null)},bind:function(e){e.bindTexture(e.TEXTURE_CUBE_MAP,this.getWebGLTexture(e))},unbind:function(e){e.bindTexture(e.TEXTURE_CUBE_MAP,null)},isPowerOfTwo:function(e){function t(e){return e&0===e-1}return t(e.px.width)&&t(e.px.height)}})}),n("3d/material",["require","core/base","./shader","util/util","./texture","./texture/texture2d","./texture/texturecube","_"],function(e){var t=e("core/base");e("./shader");var r=e("util/util"),n=e("./texture");e("./texture/texture2d"),e("./texture/texturecube");var i=e("_"),a=t.derive(function(){return{__GUID__:r.genGUID(),uniforms:{},shader:null,depthTest:!0,depthWrite:!0,transparent:!1,blend:null,autoBindingLights:!0}},function(){this.shader&&this.attachShader(this.shader)},{bind:function(e){var t=0;i.each(this.uniforms,function(r,i){if(!r.semantic&&null!==r.value)if(r.value.instanceof&&r.value.instanceof(n)){var a=r.value;e.activeTexture(e["TEXTURE"+t]),a.bind(e),this.shader.setUniform(e,"1i",i,t),t++}else if(r.value instanceof Array){var o=r.value[0];if(o&&o.instanceof&&o.instanceof(n)){for(var s=[],u=0;r.value.length>u;u++){var a=r.value[u];e.activeTexture(e["TEXTURE"+t]),a.bind(e),s.push(t++)}this.shader.setUniform(e,"1iv",i,s)}else this.shader.setUniform(e,r.type,i,r.value)}else this.shader.setUniform(e,r.type,i,r.value)},this)},setUniform:function(e,t){var r=this.uniforms[e];r&&(r.value=t)},setUniforms:function(e){for(var t in e){var r=e[t];this.setUniform(t,r)}},getUniform:function(e){var t=this.uniforms[e];return t?t.value:void 0},attachShader:function(e){this.uniforms=e.createUniforms(),this.shader=e},detachShader:function(){this.shader=null,this.uniforms={}}});return a}),n("3d/mesh",["require","./node","_"],function(e){var t=e("./node");e("_");var r=0,n=t.derive(function(){return{material:null,geometry:null,mode:"TRIANGLES",receiveShadow:!0,castShadow:!0}},{render:function(e,t){this.trigger("beforerender",e);for(var n=t||this.material,i=n.shader,a=this.geometry,o=e[this.mode.toUpperCase()],s=a.getBufferChunks(e),u=0;s.length>u;u++){currentDrawID=e.__GUID__+"_"+a.__GUID__+"_"+u;var l=s[u],c=l.attributeBuffers,f=l.indicesBuffer;if(currentDrawID!==r){r=currentDrawID,availableAttributes={};for(var h in c){var d=c[h],p=d.semantic;if(p)var v=i.semantics[p],m=v&&v.symbol;else var m=h;m&&i.attributeTemplates[m]&&(availableAttributes[m]=d)}i.enableAttributes(e,Object.keys(availableAttributes));for(var m in availableAttributes){var d=availableAttributes[m],g=d.buffer;e.bindBuffer(e.ARRAY_BUFFER,g),i.setMeshAttribute(e,m,d)}}a.useFaces?(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,f.buffer),e.drawElements(o,f.count,e.UNSIGNED_SHORT,0)):e.drawArrays(o,0,a.vertexCount)}var _={faceNumber:a.faces.length,vertexNumber:a.getVerticesNumber(),drawcallNumber:s.length};return this.trigger("afterrender",e,_),_},bindGeometry:function(){this.material.shader,this.geometry}});return n.materialChanged=function(){r=0},n}),n("text",["module"],function(e){var t,n,i=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],a=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,o=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,s="undefined"!=typeof location&&location.href,u=s&&location.protocol&&location.protocol.replace(/\:/,""),l=s&&location.hostname,c=s&&(location.port||void 0),f=[],h=e.config&&e.config()||{};return t={version:"2.0.5",strip:function(e){if(e){e=e.replace(a,"");var t=e.match(o);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:h.createXhr||function(){var e,t,r;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(t=0;3>t;t+=1){r=i[t];try{e=new ActiveXObject(r)}catch(n){}if(e){i=[r];break}}return e},parseName:function(e){var t,r,n,i=!1,a=e.indexOf("."),o=0===e.indexOf("./")||0===e.indexOf("../");return-1!==a&&(!o||a>1)?(t=e.substring(0,a),r=e.substring(a+1,e.length)):t=e,n=r||t,a=n.indexOf("!"),-1!==a&&(i="strip"===n.substring(a+1),n=n.substring(0,a),r?r=n:t=n),{moduleName:t,ext:r,strip:i}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,r,n,i){var a,o,s,u=t.xdRegExp.exec(e);return u?(a=u[2],o=u[3],o=o.split(":"),s=o[1],o=o[0],!(a&&a!==r||o&&o.toLowerCase()!==n.toLowerCase()||(s||o)&&s!==i)):!0},finishLoad:function(e,r,n,i){n=r?t.strip(n):n,h.isBuild&&(f[e]=n),i(n)},load:function(e,r,n,i){if(i.isBuild&&!i.inlineText)return n(),void 0;h.isBuild=i.isBuild;var a=t.parseName(e),o=a.moduleName+(a.ext?"."+a.ext:""),f=r.toUrl(o),d=h.useXhr||t.useXhr;!s||d(f,u,l,c)?t.get(f,function(r){t.finishLoad(e,a.strip,r,n)},function(e){n.error&&n.error(e)}):r([o],function(e){t.finishLoad(a.moduleName+"."+a.ext,a.strip,e,n)})},write:function(e,r,n){if(f.hasOwnProperty(r)){var i=t.jsEscape(f[r]);n.asModule(e+"!"+r,"define(function () { return '"+i+"';});\n")}},writeFile:function(e,r,n,i,a){var o=t.parseName(r),s=o.ext?"."+o.ext:"",u=o.moduleName+s,l=n.toUrl(o.moduleName+s)+".js";t.load(u,n,function(){var r=function(e){return i(l,e)};r.asModule=function(e,t){return i.asModule(e,l,t)},t.write(e,u,r,a)},a)}},"node"===h.env||!h.env&&"undefined"!=typeof process&&process.versions&&process.versions.node?(n=r.nodeRequire("fs"),t.get=function(e,t){var r=n.readFileSync(e,"utf8");0===r.indexOf("﻿")&&(r=r.substring(1)),t(r)}):"xhr"===h.env||!h.env&&t.createXhr()?t.get=function(e,r,n,i){var a,o=t.createXhr();if(o.open("GET",e,!0),i)for(a in i)i.hasOwnProperty(a)&&o.setRequestHeader(a.toLowerCase(),i[a]);h.onXhr&&h.onXhr(o,e),o.onreadystatechange=function(){var t,i;4===o.readyState&&(t=o.status,t>399&&600>t?(i=Error(e+" HTTP status: "+t),i.xhr=o,n(i)):r(o.responseText))},o.send(null)}:("rhino"===h.env||!h.env&&"undefined"!=typeof Packages&&"undefined"!=typeof java)&&(t.get=function(e,t){var r,n,i="utf-8",a=new java.io.File(e),o=java.lang.System.getProperty("line.separator"),s=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(a),i)),u="";try{for(r=new java.lang.StringBuffer,n=s.readLine(),n&&n.length()&&65279===n.charAt(0)&&(n=n.substring(1)),r.append(n);null!==(n=s.readLine());)r.append(o),r.append(n);u=""+r+""}finally{s.close()}t(u)}),t}),n("text!3d/compositor/shaders/vertex.essl",[],function(){return"uniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\n\nattribute vec3 position : POSITION;\nattribute vec2 texcoord : TEXCOORD_0;\n\nvarying vec2 v_Texcoord;\n\nvoid main(){\n\n    v_Texcoord = texcoord;\n    gl_Position = worldViewProjection * vec4(position, 1.0);\n}"}),n("text!3d/compositor/shaders/coloradjust.essl",[],function(){return'@export buildin.pp.coloradjust.fragment\n\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\n\nuniform float brightness : 0.0;\nuniform float contrast : 1.0;\nuniform float exposure : 0.0;\nuniform float gamma : 1.0;\nuniform float saturation : 1.0;\n\n// Values from "Graphics Shaders: Theory and Practice" by Bailey and Cunningham\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\n\nvoid main()\n{\n    vec4 tex = texture2D( texture, v_Texcoord);\n\n    // brightness\n    vec3 color = clamp( tex.rgb + vec3(brightness), 0.0, 1.0);\n    // contrast\n    color = clamp( (color-vec3(0.5))*contrast+vec3(0.5), 0.0, 1.0);\n    // exposure\n    color = clamp( color * pow(2.0, exposure), 0.0, 1.0);\n    // gamma\n    color = clamp( pow(color, vec3(gamma)), 0.0, 1.0);\n    // saturation\n    float luminance = dot( color, w );\n    color = mix(vec3(luminance), color, saturation);\n    \n    gl_FragColor = vec4(color, 1.0);\n}\n\n@end'}),n("text!3d/compositor/shaders/blur.essl",[],function(){return"/**\n *  http://www.gamerendering.com/2008/10/11/gaussian-blur-filter-shader/\n */\n\n@export buildin.pp.gaussian_blur_v.fragment\n\nuniform sampler2D texture; // the texture with the scene you want to blur\nvarying vec2 v_Texcoord;\n \nuniform float blurSize : 3.0; \nuniform float imageWidth : 512.0;\n\nvoid main(void)\n{\n   vec4 sum = vec4(0.0);\n \n   // blur in y (vertical)\n   // take nine samples, with the distance blurSize between them\n   sum += texture2D(texture, vec2(v_Texcoord.x - 4.0*blurSize/imageWidth, v_Texcoord.y)) * 0.05;\n   sum += texture2D(texture, vec2(v_Texcoord.x - 3.0*blurSize/imageWidth, v_Texcoord.y)) * 0.09;\n   sum += texture2D(texture, vec2(v_Texcoord.x - 2.0*blurSize/imageWidth, v_Texcoord.y)) * 0.12;\n   sum += texture2D(texture, vec2(v_Texcoord.x - blurSize/imageWidth, v_Texcoord.y)) * 0.15;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y)) * 0.16;\n   sum += texture2D(texture, vec2(v_Texcoord.x + blurSize/imageWidth, v_Texcoord.y)) * 0.15;\n   sum += texture2D(texture, vec2(v_Texcoord.x + 2.0*blurSize/imageWidth, v_Texcoord.y)) * 0.12;\n   sum += texture2D(texture, vec2(v_Texcoord.x + 3.0*blurSize/imageWidth, v_Texcoord.y)) * 0.09;\n   sum += texture2D(texture, vec2(v_Texcoord.x + 4.0*blurSize/imageWidth, v_Texcoord.y)) * 0.05;\n \n   gl_FragColor = sum;\n}\n\n@end\n\n@export buildin.pp.gaussian_blur_h.fragment\n\nuniform sampler2D texture; // this should hold the texture rendered by the horizontal blur pass\nvarying vec2 v_Texcoord;\n \nuniform float blurSize : 3.0;\nuniform float imageHeight : 512.0;\n \nvoid main(void)\n{\n   vec4 sum = vec4(0.0);\n \n   // blur in y (vertical)\n   // take nine samples, with the distance blurSize between them\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y - 4.0*blurSize/imageHeight)) * 0.05;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y - 3.0*blurSize/imageHeight)) * 0.09;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y - 2.0*blurSize/imageHeight)) * 0.12;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y - blurSize/imageHeight)) * 0.15;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y)) * 0.16;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y + blurSize/imageHeight)) * 0.15;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y + 2.0*blurSize/imageHeight)) * 0.12;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y + 3.0*blurSize/imageHeight)) * 0.09;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y + 4.0*blurSize/imageHeight)) * 0.05;\n \n   gl_FragColor = sum;\n}\n\n@end\n\n@export buildin.pp.box_blur.fragment\n\nuniform sampler2D texture;\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 3.0;\nuniform float imageWidth : 512.0;\nuniform float imageHeight : 512.0;\n\nvoid main(void){\n\n   vec4 tex = texture2D(texture, v_Texcoord);\n   float offsetX = blurSize / imageWidth;\n   float offsetY = blurSize / imageHeight;\n   tex += texture2D(texture, v_Texcoord + vec2(offsetX, 0.0) );\n   tex += texture2D(texture, v_Texcoord + vec2(offsetX, offsetY) );\n   tex += texture2D(texture, v_Texcoord + vec2(-offsetX, offsetY) );\n   tex += texture2D(texture, v_Texcoord + vec2(0.0, offsetY) );\n   tex += texture2D(texture, v_Texcoord + vec2(-offsetX, 0.0) );\n   tex += texture2D(texture, v_Texcoord + vec2(-offsetX, -offsetY) );\n   tex += texture2D(texture, v_Texcoord + vec2(offsetX, -offsetY) );\n   tex += texture2D(texture, v_Texcoord + vec2(0.0, -offsetY) );\n\n   tex /= 9.0;\n   return tex;\n}\n\n@end\n\n// http://www.slideshare.net/DICEStudio/five-rendering-ideas-from-battlefield-3-need-for-speed-the-run\n\n@export buildin.pp.hexagonal_blur_1.fragment\n\n@end\n\n@export buildin.pp_hexagonal_blur_2.fragment"}),n("3d/compositor/pass",["require","core/base","../scene","../camera/orthographic","../geometry/plane","../shader","../material","../mesh","../scene","text!./shaders/vertex.essl","text!./shaders/coloradjust.essl","text!./shaders/blur.essl"],function(e){var t=e("core/base"),r=e("../scene"),n=e("../camera/orthographic"),i=e("../geometry/plane"),a=e("../shader"),o=e("../material"),s=e("../mesh"),r=e("../scene"),u=e("text!./shaders/vertex.essl"),l=new i,c=new s({geometry:l}),f=new r,h=new n;f.add(c);var d=t.derive(function(){return{fragment:"",output:null,_material:null}},function(){var e=new a({vertex:u,fragment:this.fragment}),t=new o({shader:e});e.enableTexturesAll(),this._material=t},{setUniform:function(e,t){var r=this._material.uniforms[e];r&&(r.value=t)},bind:function(e,t){this.output&&(t.attach(e.gl,this.output),t.bind(e))},unbind:function(e,t){t.unbind(e)},render:function(e,t){c.material=this._material,t&&this.bind(e,t),e.render(f,h),t&&this.unbind(e,t)}});return a.import(e("text!./shaders/coloradjust.essl")),a.import(e("text!./shaders/blur.essl")),d}),n("3d/framebuffer",["require","core/base","./texture/texture2d","./texture/texturecube"],function(e){var t=e("core/base");e("./texture/texture2d");var r=e("./texture/texturecube"),n=t.derive(function(){return{depthBuffer:!0,_attachedTextures:{}}},{bind:function(e){var t=e.gl;if(t.bindFramebuffer(t.FRAMEBUFFER,this.getFrameBuffer(t)),this.cache.put("viewport",e.viewportInfo),e.setViewport(0,0,this.cache.get("width"),this.cache.get("height")),this.cache.miss("renderbuffer")&&this.depthBuffer&&!this.cache.get("depth_texture")&&this.cache.put("renderbuffer",t.createRenderbuffer()),!this.cache.get("depth_texture")&&this.depthBuffer){var r=this.cache.get("width"),n=this.cache.get("height"),i=this.cache.get("renderbuffer");(r!==this.cache.get("renderbuffer_width")||n!==this.cache.get("renderbuffer_height"))&&(t.bindRenderbuffer(t.RENDERBUFFER,i),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,r,n),this.cache.put("renderbuffer_width",r),this.cache.put("renderbuffer_height",n),t.bindRenderbuffer(t.RENDERBUFFER,null)),this.cache.get("renderbuffer_attached")||(t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,i),this.cache.put("renderbuffer_attached",!0))}},unbind:function(e){var t=e.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),this.cache.use(t.__GUID__);var n=this.cache.get("viewport");n&&e.setViewport(n.x,n.y,n.width,n.height);for(var i in this._attachedTextures){var a=this._attachedTextures[i];if(!a.NPOT&&a.generateMipmaps){var o=a.instanceof(r)?t.TEXTURE_CUBE_MAP:t.TEXTURE_2D;t.bindTexture(o,a.getWebGLTexture(t)),t.generateMipmap(o),t.bindTexture(o,null)}}},getFrameBuffer:function(e){return this.cache.use(e.__GUID__),this.cache.miss("framebuffer")&&this.cache.put("framebuffer",e.createFramebuffer()),this.cache.get("framebuffer")},attach:function(e,t,r,n){if(!t.width)return console.error("The texture attached to color buffer is not a valid."),void 0;if(this._renderBuffer&&this.depthBuffer&&(this._width!==t.width||this.height!==t.height)&&console.warn("Attached texture has different width or height, it will cause the render buffer recreate a storage "),e.bindFramebuffer(e.FRAMEBUFFER,this.getFrameBuffer(e)),this.cache.put("width",t.width),this.cache.put("height",t.height),n=n||"TEXTURE_2D",r=r||"COLOR_ATTACHMENT0","DEPTH_ATTACHMENT"===r){if(!e.getExtension("WEBKIT_WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture"))return console.error(" Depth texture is not supported by browser "),void 0;if("DEPTH_COMPONENT"!==t.format)return console.error("The texture attached to depth buffer is not a valid."),void 0;this.cache.put("renderbuffer_attached",!1),this.cache.put("depth_texture",!0)}this._attachedTextures[r]=t,e.framebufferTexture2D(e.FRAMEBUFFER,e[r],e[n],t.getWebGLTexture(e),0),e.bindFramebuffer(e.FRAMEBUFFER,null)},detach:function(){},detachDepth:function(){this.cache.put("depth_texture",!1)},dispose:function(e){this.cache.use(e.__GUID__),this.cache.get("renderbuffer")&&e.deleteRenderbuffer(this.cache.get("renderbuffer")),this.cache.get("framebuffer")&&e.deleteFramebuffer(this.cache.get("framebuffer")),this.cache.clearContext()}});return n}),n("3d/compositor/graph/texturepool",["require","../../texture/texture2d"],function(e){function t(e){var t={width:512,height:512,type:"UNSIGNED_BYTE",format:"RGBA",wrapS:"CLAMP_TO_EDGE",wrapT:"CLAMP_TO_EDGE",minFilter:"LINEAR_MIPMAP_LINEAR",magFilter:"LINEAR",generateMipMaps:!0,anisotropy:1,flipY:!0,unpackAlignment:4,premultiplyAlpha:!1},r="";for(var n in t){if(e[n])var i=""+e[n];else var i=""+t[n];r+=i}return r}var r=e("../../texture/texture2d"),n={},i={get:function(e){var i=t(e);n.hasOwnProperty(i)||(n[i]=[]);var a=n[i];if(!a.length){var o=new r(e);return o}return a.pop()},put:function(e){var r=t(e);n.hasOwnProperty(r)||(n[r]=[]);var i=n[r];i.push(e)}};return i}),n("3d/compositor/graph/node",["require","core/base","../pass","../../framebuffer","text!../shaders/vertex.essl","../../shader","./texturepool"],function(e){var t=e("core/base"),r=e("../pass"),n=e("../../framebuffer");e("text!../shaders/vertex.essl"),e("../../shader");var i=e("./texturepool"),a=new n({depthBuffer:!1}),o=t.derive(function(){return{name:"",inputs:{},outputs:null,_inputLinks:{},_outputLinks:{},_textures:{},pass:null,_outputReferences:{}}},function(){if(this.shader){var e=new r({fragment:this.shader});this.pass=e}},{render:function(e,t){for(var r in this._inputLinks){var n=this._inputLinks[r],i=n.node.getOutput(e,n.pin);this.pass.setUniform(r,i)}t?(this.pass.output=t,this.pass.render(e,a)):this.pass.render(e);for(var r in this._inputLinks){var n=this._inputLinks[r];n.node.removeReference(n.pin)}},setParameter:function(e,t){this.pass.setUniform(e,t)},getOutput:function(e,t){var r=this.outputs[t];if(r){if(this._textures[t])return this._textures[t];var n=i.get(r.parameters);return this._textures[t]=n,this.render(e,n),n}},removeReference:function(e){this._outputReferences[e]--,0===this._outputReferences[e]&&(i.put(this._textures[e]),this._textures[e]=null)},link:function(e,t,r){this._inputLinks[e]={node:t,pin:r},t._outputLinks[r]||(t._outputLinks[r]=[]),t._outputLinks[r].push({node:this,pin:e})},clear:function(){this._inputLinks={},this._outputLinks={}},updateReference:function(){for(var e in this._outputLinks)this._outputReferences[e]=this._outputLinks[e].length}});return o}),n("3d/compositor/graph/scenenode",["require","./node","../pass","../../framebuffer"],function(e){var t=e("./node");e("../pass");var r=e("../../framebuffer"),n=new r,i=t.derive(function(){return{scene:null,camera:null}},{render:function(e,t){t&&(n.attach(e.gl,t),n.bind(e)),e.render(this.scene,this.camera),t&&n.unbind(e)}});return i}),n("3d/debug/pointlight",function(){}),n("3d/debug/renderinfo",["require","core/base"],function(e){var t=e("core/base"),r=t.derive(function(){return{renderer:null,frameTime:0,vertexNumber:0,faceNumber:0,drawcallNumber:0,meshNumber:0,_startTime:0}},{enable:function(){this.renderer.on("beforerender",this._beforeRender,this),this.renderer.on("afterrender",this._afterRender,this),this.renderer.on("afterrender:mesh",this._afterRenderMesh,this)},disable:function(){this.renderer.off("beforerender",this._beforeRender),this.renderer.off("afterrender",this._afterRender),this.renderer.off("afterrender:mesh",this._afterRenderMesh)},clear:function(){this.vertexNumber=0,this.faceNumber=0,this.drawcallNumber=0,this.meshNumber=0,this.frameTime=0},_beforeRender:function(){this.clear(),this._startTime=(new Date).getTime()},_afterRender:function(){var e=(new Date).getTime();this.frameTime=e-this._startTime},_afterRenderMesh:function(e,t){this.vertexNumber+=t.vertexNumber,this.faceNumber+=t.faceNumber,this.drawcallNumber+=t.drawcallNumber,this.meshNumber++}});return r}),n("3d/geometry/cube",["require","../geometry","./plane","glmatrix","_"],function(e){function t(e,t,r){a.identity(s);var i=new n({widthSegments:t,heightSegments:r});switch(e){case"px":a.translate(s,s,[1,0,0]),a.rotateY(s,s,Math.PI/2);break;case"nx":a.translate(s,s,[-1,0,0]),a.rotateY(s,s,-Math.PI/2);break;case"py":a.translate(s,s,[0,1,0]),a.rotateX(s,s,-Math.PI/2);break;case"ny":a.translate(s,s,[0,-1,0]),a.rotateX(s,s,Math.PI/2);break;case"pz":a.translate(s,s,[0,0,1]);break;case"nz":a.translate(s,s,[0,0,-1]),a.rotateY(s,s,Math.PI)}return i.applyMatrix(s),i}var r=e("../geometry"),n=e("./plane"),i=e("glmatrix"),a=i.mat4,o=e("_"),s=a.create(),u=r.derive(function(){return{widthSegments:1,heightSegments:1,depthSegments:1,inside:!1}},function(){var e={px:t("px",this.depthSegments,this.heightSegments),nx:t("nx",this.depthSegments,this.heightSegments),py:t("py",this.widthSegments,this.depthSegments),ny:t("ny",this.widthSegments,this.depthSegments),pz:t("pz",this.widthSegments,this.heightSegments),nz:t("nz",this.widthSegments,this.heightSegments)},r=0;for(var n in e)o.each(["position","texcoord0","normal"],function(t){for(var i=e[n].attributes[t].value,a=0;i.length>a;a++){var o=i[a];this.inside&&"normal"===t&&(o[0]=-o[0],o[1]=-o[1],o[2]=-o[2]),this.attributes[t].value.push(o)}for(var s=e[n],a=0;s.faces.length>a;a++){var u=s.faces[a];this.faces.push([u[0]+r,u[1]+r,u[2]+r])}},this),r+=e[n].getVerticesNumber()});return u}),n("3d/geometry/sphere",["require","../geometry","glmatrix"],function(e){var t=e("../geometry"),r=e("glmatrix"),n=r.vec3,i=r.vec2,a=t.derive(function(){return{widthSegments:20,heightSegments:20,phiStart:0,phiLength:2*Math.PI,thetaStart:0,thetaLength:Math.PI,radius:1}},function(){var e,t,r,a,o,s,u,l,c=this.attributes.position.value,f=this.attributes.texcoord0.value,h=this.attributes.normal.value,d=this.heightSegments,p=this.widthSegments,v=this.radius,m=this.phiStart,g=this.phiLength,_=this.thetaStart,x=this.thetaLength,v=this.radius;for(u=0;d>=u;u++)for(s=0;p>=s;s++)a=s/p,o=u/d,e=-v*Math.cos(m+a*g)*Math.sin(_+o*x),t=v*Math.cos(_+o*x),r=v*Math.sin(m+a*g)*Math.sin(_+o*x),c.push(n.fromValues(e,t,r)),f.push(i.fromValues(a,o)),l=n.fromValues(e,t,r),h.push(n.normalize(l,l));var b,y,E,T,w=this.faces,A=p+1;for(u=0;d>u;u++)for(s=0;p>s;s++)b=u*A+s,y=u*A+s+1,E=(u+1)*A+s+1,T=(u+1)*A+s,w.push(n.fromValues(b,y,E)),w.push(n.fromValues(E,T,b))});return a}),n("3d/light",["require","./node"],function(e){var t=e("./node"),r=t.derive(function(){return{color:[1,1,1],intensity:1,castShadow:!0,shadowResolution:512}},{});return r}),n("3d/light/ambient",["require","../light","../shader"],function(e){var t=e("../light"),r=e("../shader"),n=["@export buildin.header.ambient_light","uniform vec3 ambientLightColor[ AMBIENT_LIGHT_NUMBER ];","@end;"].join("\n");r.import(n);var i=t.derive(function(){return{castShadow:!1}},{type:"AMBIENT_LIGHT",uniformTemplates:{ambientLightColor:{type:"3f",value:function(e){var t=e.color,r=e.intensity;return[t[0]*r,t[1]*r,t[1]*r]}}}});return i}),n("3d/light/directional",["require","../light","../shader","glmatrix"],function(e){var t=e("../light"),r=e("../shader"),n=e("glmatrix"),i=n.vec3,a=["@export buildin.header.directional_light","uniform vec3 directionalLightDirection[ DIRECTIONAL_LIGHT_NUMBER ];","uniform vec3 directionalLightColor[ DIRECTIONAL_LIGHT_NUMBER ];","@end;"].join("\n");r.import(a);var o=t.derive(function(){return{shadowCamera:{left:-20,right:20,top:20,bottom:-20,near:0,far:100}}},{type:"DIRECTIONAL_LIGHT",uniformTemplates:{directionalLightDirection:{type:"3f",value:function(){var e,t=i.create();return function(r){return e=r.worldMatrix,i.set(t,e[8],e[9],e[10]),t}}()},directionalLightColor:{type:"3f",value:function(e){var t=e.color,r=e.intensity;return[t[0]*r,t[1]*r,t[1]*r]}}}});return o}),n("3d/light/point",["require","../light","../shader"],function(e){var t=e("../light"),r=e("../shader"),n=["@export buildin.header.point_light","uniform vec3 pointLightPosition[ POINT_LIGHT_NUMBER ];","uniform float pointLightRange[ POINT_LIGHT_NUMBER ];","uniform vec3 pointLightColor[ POINT_LIGHT_NUMBER ];","@end;"].join("\n");r.import(n);var i=t.derive(function(){return{range:100,castShadow:!1}},{type:"POINT_LIGHT",uniformTemplates:{pointLightPosition:{type:"3f",value:function(e){return e.getWorldPosition()}},pointLightRange:{type:"1f",value:function(e){return e.range}},pointLightColor:{type:"3f",value:function(e){var t=e.color,r=e.intensity;return[t[0]*r,t[1]*r,t[1]*r]}}}});return i}),n("3d/light/spot",["require","../light","../shader","glmatrix"],function(e){var t=e("../light"),r=e("../shader"),n=e("glmatrix"),i=n.vec3,a=["@export buildin.header.spot_light","uniform vec3 spotLightPosition[SPOT_LIGHT_NUMBER];","uniform vec3 spotLightDirection[SPOT_LIGHT_NUMBER];","uniform float spotLightRange[SPOT_LIGHT_NUMBER];","uniform float spotLightUmbraAngleCosine[SPOT_LIGHT_NUMBER];","uniform float spotLightPenumbraAngleCosine[SPOT_LIGHT_NUMBER];","uniform float spotLightFalloffFactor[SPOT_LIGHT_NUMBER];","uniform vec3 spotLightColor[SPOT_LIGHT_NUMBER];","@end;"].join("\n");r.import(a);var o=t.derive(function(){return{range:20,umbraAngle:30,penumbraAngle:45,falloffFactor:2}},{type:"SPOT_LIGHT",uniformTemplates:{spotLightPosition:{type:"3f",value:function(e){return e.getWorldPosition()}},spotLightRange:{type:"1f",value:function(e){return e.range}},spotLightUmbraAngleCosine:{type:"1f",value:function(e){return Math.cos(e.umbraAngle*Math.PI/180)}},spotLightPenumbraAngleCosine:{type:"1f",value:function(e){return Math.cos(e.penumbraAngle*Math.PI/180)}},spotLightFalloffFactor:{type:"1f",value:function(e){return e.falloffFactor}},spotLightDirection:{type:"3f",value:function(){var e,t=i.create();return function(r){return e=r.worldMatrix,i.set(t,e[8],e[9],e[10]),t}}()},spotLightColor:{type:"3f",value:function(e){var t=e.color,r=e.intensity;return[t[0]*r,t[1]*r,t[1]*r]}}}});return o}),n("3d/plugin/firstpersoncontrol",["require","core/base","glmatrix"],function(e){function t(e,t){return e.__bindfuc__||(e.__bindfuc__=function(){return e.apply(t,arguments)}),e.__bindfuc__}var r=e("core/base"),n=e("glmatrix"),i=n.vec3;n.mat4;var a=r.derive(function(){return{camera:null,canvas:null,sensitivity:1,speed:.4,_offsetPitch:0,_offsetRoll:0,_moveForward:!1,_moveBackward:!1,_moveLeft:!1,_moveRight:!1}},function(){this._offsetPitch=180*this.camera.rotation[1]/Math.PI,this._offsetRoll=180*this.camera.rotation[0]/Math.PI},{enable:function(){this.camera.on("beforeupdate",this._beforeUpdateCamera,this),this.camera.eulerOrder=["Y","X","Z"];var e=this.canvas;e.addEventListener("click",this.requestPointerLock),document.addEventListener("pointerlockchange",t(this._lockChange,this),!1),document.addEventListener("mozpointerlockchange",t(this._lockChange,this),!1),document.addEventListener("webkitpointerlockchange",t(this._lockChange,this),!1),document.addEventListener("keydown",t(this._keyDown,this),!1),document.addEventListener("keyup",t(this._keyUp,this),!1)},disable:function(){this.camera.off("beforeupdate",this._beforeUpdateCamera);var e=this.canvas;e.exitPointerLock=e.exitPointerLock||e.mozExitPointerLock||e.webkitExitPointerLock,e.exitPointerLock&&e.exitPointerLock(),document.removeEventListener("pointerlockchange",t(this._lockChange,this)),document.removeEventListener("mozpointerlockchange",t(this._lockChange,this)),document.removeEventListener("webkitpointerlockchange",t(this._lockChange,this))},requestPointerLock:function(){var e=this;e.requestPointerLock=e.requestPointerLock||e.mozRequestPointerLock||e.webkitRequestPointerLock,e.requestPointerLock()},_beforeUpdateCamera:function(){this.camera.roll(this._offsetRoll*Math.PI/180),this.camera.pitch(this._offsetPitch*Math.PI/180);var e=this.camera.position,t=this._getXAxis(!0),r=this._getZAxis(!0);this._moveForward&&i.add(e,e,i.scale(r,r,-this.speed)),this._moveBackward&&i.add(e,e,i.scale(r,r,this.speed)),this._moveLeft&&i.add(e,e,i.scale(t,t,-this.speed/2)),this._moveRight&&i.add(e,e,i.scale(t,t,this.speed/2))},_lockChange:function(){document.pointerlockElement===this.canvas||document.mozPointerlockElement===this.canvas||document.webkitPointerLockElement===this.canvas?document.addEventListener("mousemove",t(this._mouseMove,this),!1):document.removeEventListener("mousemove",t(this._mouseMove,this),!1)},_mouseMove:function(e){var t=e.movementX||e.mozMovementX||e.webkitMovementX||0,r=e.movementY||e.mozMovementY||e.webkitMovementY||0;this._offsetPitch-=t*this.sensitivity/10,this._offsetRoll-=r*this.sensitivity/10},_keyDown:function(e){switch(e.keyCode){case 87:case 37:this._moveForward=!0;break;case 83:case 40:this._moveBackward=!0;break;case 65:case 37:this._moveLeft=!0;break;case 68:case 39:this._moveRight=!0}},_keyUp:function(e){switch(e.keyCode){case 87:case 37:this._moveForward=!1;break;case 83:case 40:this._moveBackward=!1;break;case 65:case 37:this._moveLeft=!1;break;case 68:case 39:this._moveRight=!1}},_getXAxis:function(){var e=i.create();return function(t){var r=this.camera.matrix;return i.set(e,r[0],r[1],r[2]),t&&i.normalize(e,e),e}}(),_getZAxis:function(){var e=i.create();return function(t){var r=this.camera.matrix;return i.set(e,r[8],r[9],r[10]),t&&i.normalize(e,e),e}}()});return a}),n("text!3d/shader/source/basic.essl",[],function(){return"@export buildin.basic.vertex\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\n\nuniform vec2 uvRepeat : [1.0, 1.0];\n\nattribute vec3 position : POSITION;\nattribute vec2 texcoord : TEXCOORD_0;\nattribute vec3 normal : NORMAL;\n\nattribute vec3 barycentric;\n\nvarying vec2 v_Texcoord;\nvarying vec3 v_Barycentric;\n\nvoid main(){\n\n    gl_Position = worldViewProjection * vec4( position, 1.0 );\n\n    v_Texcoord = texcoord * uvRepeat;\n    v_Barycentric = barycentric;\n}\n\n@end\n\n\n\n\n@export buildin.basic.fragment\n\nvarying vec2 v_Texcoord;\nuniform sampler2D diffuseMap;\nuniform vec3 color : [1.0, 1.0, 1.0];\nuniform float alpha : 1.0;\n\n// Uniforms for wireframe\nuniform float lineWidth : 0.0;\nuniform vec3 lineColor : [0.0, 0.0, 0.0];\nvarying vec3 v_Barycentric;\n\n@import buildin.util.edge_factor\n\nvoid main(){\n\n    gl_FragColor = vec4(color, alpha);\n    \n    #ifdef DIFFUSEMAP_ENABLED\n        vec4 tex = texture2D( diffuseMap, v_Texcoord );\n        gl_FragColor.rgb *= tex.rgb;\n    #endif\n    \n    if( lineWidth > 0.01){\n        gl_FragColor.xyz = gl_FragColor.xyz * mix(lineColor, vec3(1.0), edgeFactor(lineWidth));\n    }\n}\n\n@end"
}),n("text!3d/shader/source/lambert.essl",[],function(){return"/**\n * http://en.wikipedia.org/wiki/Lambertian_reflectance\n */\n\n@export buildin.lambert.vertex\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform mat4 worldInverseTranspose : WORLDINVERSETRANSPOSE;\nuniform mat4 world : WORLD;\n\nuniform vec2 uvRepeat : [1.0, 1.0];\n\nattribute vec3 position : POSITION;\nattribute vec2 texcoord : TEXCOORD_0;\nattribute vec3 normal : NORMAL;\n\nattribute vec3 barycentric;\n\nvarying vec2 v_Texcoord;\nvarying vec3 v_Normal;\nvarying vec3 v_WorldPosition;\nvarying vec3 v_Barycentric;\n\nvoid main(){\n\n    gl_Position = worldViewProjection * vec4( position, 1.0 );\n\n    v_Texcoord = texcoord * uvRepeat;\n    v_Normal = normalize( ( worldInverseTranspose * vec4(normal, 0.0) ).xyz );\n    v_WorldPosition = ( world * vec4( position, 1.0) ).xyz;\n\n    v_Barycentric = barycentric;\n}\n\n@end\n\n\n\n\n@export buildin.lambert.fragment\n\nvarying vec2 v_Texcoord;\nvarying vec3 v_Normal;\nvarying vec3 v_WorldPosition;\n\nuniform sampler2D diffuseMap;\n\n#ifdef SHADOWMAP_NUMBER\nuniform sampler2D shadowMap[ SHADOWMAP_NUMBER ];\nuniform mat4 shadowCameraMatrix[ SHADOWMAP_NUMBER ];\n#endif\n\nuniform vec3 color : [1.0, 1.0, 1.0];\nuniform float alpha : 1.0;\n\n// Uniforms for wireframe\nuniform float lineWidth : 0.0;\nuniform vec3 lineColor : [0.0, 0.0, 0.0];\nvarying vec3 v_Barycentric;\n\n#ifdef AMBIENT_LIGHT_NUMBER\n@import buildin.header.ambient_light\n#endif\n#ifdef POINT_LIGHT_NUMBER\n@import buildin.header.point_light\n#endif\n#ifdef DIRECTIONAL_LIGHT_NUMBER\n@import buildin.header.directional_light\n#endif\n#ifdef SPOT_LIGHT_NUMBER\n@import buildin.header.spot_light\n#endif\n\n#extension GL_OES_standard_derivatives : enable\n// Import util functions and uniforms needed\n@import buildin.util.calculate_attenuation\n\n@import buildin.util.edge_factor\n\n@import buildin.plugin.compute_shadow_map\n\nvoid main(){\n    \n    gl_FragColor = vec4(color, alpha);\n\n    #ifdef DIFFUSEMAP_ENABLED\n        vec4 tex = texture2D( diffuseMap, v_Texcoord );\n        // http://freesdk.crydev.net/display/SDKDOC3/Specular+Maps\n        gl_FragColor.rgb *= tex.rgb;\n    #endif\n\n    vec3 diffuseColor = vec3(0.0, 0.0, 0.0);\n    \n    #ifdef AMBIENT_LIGHT_NUMBER\n        for(int i = 0; i < AMBIENT_LIGHT_NUMBER; i++){\n            diffuseColor += ambientLightColor[i];\n        }\n    #endif\n    // Compute point light color\n    #ifdef POINT_LIGHT_NUMBER\n        #if defined( SHADOWMAP_ENABLED ) && defined(POINT_LIGHT_SHADOWMAP_NUMBER)\n            float shadowFallOffs[POINT_LIGHT_NUMBER];\n            computeShadowFallOfPointLights( v_WorldPosition, shadowFallOffs );\n        #endif\n        for(int i = 0; i < POINT_LIGHT_NUMBER; i++){\n\n            vec3 lightPosition = pointLightPosition[i];\n            vec3 lightColor = pointLightColor[i];\n            float range = pointLightRange[i];\n\n            vec3 lightDirection = lightPosition - v_WorldPosition;\n\n            // Calculate point light attenuation\n            float dist = length(lightDirection);\n            float attenuation = calculateAttenuation(dist, range);\n\n            // Normalize vectors\n            lightDirection /= dist;\n\n            float ndl = dot( v_Normal, lightDirection );\n\n            float shadowFallOff = 1.0;\n            #if defined( SHADOWMAP_ENABLED ) && defined(POINT_LIGHT_SHADOWMAP_NUMBER)\n                shadowFallOff = shadowFallOffs[ i ];\n            #endif\n\n            diffuseColor += lightColor * clamp(ndl, 0.0, 1.0) * attenuation * shadowFallOff;\n        }\n    #endif\n    #ifdef DIRECTIONAL_LIGHT_NUMBER\n        #if defined( SHADOWMAP_ENABLED ) && defined(DIRECTIONAL_LIGHT_SHADOWMAP_NUMBER)\n            float shadowFallOffs[DIRECTIONAL_LIGHT_NUMBER];\n            computeShadowFallOfDirectionalLights( v_WorldPosition, shadowFallOffs );\n        #endif\n        for(int i = 0; i < DIRECTIONAL_LIGHT_NUMBER; i++){\n            vec3 lightDirection = -directionalLightDirection[i];\n            vec3 lightColor = directionalLightColor[i];\n            \n            float ndl = dot( v_Normal, normalize( lightDirection ) );\n\n            float shadowFallOff = 1.0;\n            #if defined( SHADOWMAP_ENABLED ) && defined(DIRECTIONAL_LIGHT_SHADOWMAP_NUMBER)\n                shadowFallOff = shadowFallOffs[ i ];\n            #endif\n\n            diffuseColor += lightColor * clamp(ndl, 0.0, 1.0) * shadowFallOff;\n        }\n    #endif\n    \n    #ifdef SPOT_LIGHT_NUMBER\n        #if defined( SHADOWMAP_ENABLED ) && defined(SPOT_LIGHT_SHADOWMAP_NUMBER)\n            float shadowFallOffs[SPOT_LIGHT_NUMBER];\n            computeShadowFallOfSpotLights( v_WorldPosition, shadowFallOffs );\n        #endif\n        for(int i = 0; i < SPOT_LIGHT_NUMBER; i++){\n            vec3 lightPosition = -spotLightPosition[i];\n            vec3 spotLightDirection = normalize( spotLightDirection[i] );\n            vec3 lightColor = spotLightColor[i];\n            float range = spotLightRange[i];\n            float umbraAngleCosine = spotLightUmbraAngleCosine[i];\n            float penumbraAngleCosine = spotLightPenumbraAngleCosine[i];\n            float falloffFactor = spotLightFalloffFactor[i];\n\n            vec3 lightDirection = lightPosition - v_WorldPosition;\n            // Calculate attenuation\n            float dist = length(lightDirection);\n            float attenuation = calculateAttenuation(dist, range); \n\n            // Normalize light direction\n            lightDirection /= dist;\n            // Calculate spot light fall off\n            float lightDirectCosine = dot(spotLightDirection, lightDirection);\n\n            float falloff;\n            if( lightDirectCosine < penumbraAngleCosine ){\n                falloff = 1.0;\n            }else if( lightDirectCosine > umbraAngleCosine ){\n                falloff = 0.0;\n            }else{\n                falloff = (lightDirectCosine-umbraAngleCosine)/(penumbraAngleCosine-umbraAngleCosine);\n                falloff = pow(falloff, falloffFactor);\n            }\n\n            float ndl = dot( v_Normal, lightDirection );\n            ndl = clamp(ndl, 0.0, 1.0);\n\n            float shadowFallOff = 1.0;\n            #if defined( SHADOWMAP_ENABLED ) && defined(SPOT_LIGHT_SHADOWMAP_NUMBER)\n                shadowFallOff = shadowFallOffs[i];\n            #endif\n\n            diffuseColor += lightColor * ndl * attenuation * (1.0-falloff) * shadowFallOff;\n\n        }\n    #endif\n\n    gl_FragColor.xyz *= diffuseColor;\n    if( lineWidth > 0.01){\n        gl_FragColor.xyz = gl_FragColor.xyz * mix(lineColor, vec3(1.0), edgeFactor(lineWidth));\n    }\n\n}\n\n@end"}),n("text!3d/shader/source/phong.essl",[],function(){return"\n// http://en.wikipedia.org/wiki/Blinn%E2%80%93Phong_shading_model\n\n@export buildin.phong.vertex\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform mat4 worldInverseTranspose : WORLDINVERSETRANSPOSE;\nuniform mat4 world : WORLD;\n\nuniform vec2 uvRepeat : [1.0, 1.0];\n\nattribute vec3 position : POSITION;\nattribute vec2 texcoord : TEXCOORD_0;\nattribute vec3 normal : NORMAL;\nattribute vec4 tangent : TANGENT;\n\nattribute vec3 barycentric;\n\n\nvarying vec2 v_Texcoord;\nvarying vec3 v_Normal;\nvarying vec3 v_WorldPosition;\nvarying vec3 v_Barycentric;\n\nvarying vec3 v_Tangent;\nvarying vec3 v_Bitangent;\n\nvoid main(){\n\n    gl_Position = worldViewProjection * vec4( position, 1.0 );\n\n    v_Texcoord = texcoord * uvRepeat;\n    v_WorldPosition = ( world * vec4( position, 1.0) ).xyz;\n    v_Barycentric = barycentric;\n\n    v_Normal = normalize( ( worldInverseTranspose * vec4(normal, 0.0) ).xyz );\n    v_Tangent = normalize( (worldInverseTranspose * vec4(tangent.xyz, 0.0) ).xyz );\n    v_Bitangent = normalize( cross(v_Normal, v_Tangent) * tangent.w );\n\n}\n\n@end\n\n\n@export buildin.phong.fragment\n\nuniform mat4 viewInverse : VIEWINVERSE;\n\nvarying vec2 v_Texcoord;\nvarying vec3 v_Normal;\nvarying vec3 v_WorldPosition;\nvarying vec3 v_Tangent;\nvarying vec3 v_Bitangent;\n\nuniform sampler2D diffuseMap;\nuniform sampler2D normalMap;\nuniform sampler2D environmentMap;\n\n#ifdef SHADOWMAP_NUMBER\nuniform sampler2D shadowMap[ SHADOWMAP_NUMBER ];\nuniform mat4 shadowCameraMatrix[ SHADOWMAP_NUMBER ];\n#endif\n\nuniform vec3 color : [1.0, 1.0, 1.0];\nuniform float alpha : 1.0;\n\nuniform float shininess : 30;\n\nuniform vec3 specular : [1.0, 1.0, 1.0];\n\n// Uniforms for wireframe\nuniform float lineWidth : 0.0;\nuniform vec3 lineColor : [0.0, 0.0, 0.0];\nvarying vec3 v_Barycentric;\n\n#ifdef AMBIENT_LIGHT_NUMBER\n@import buildin.header.ambient_light\n#endif\n#ifdef POINT_LIGHT_NUMBER\n@import buildin.header.point_light\n#endif\n#ifdef DIRECTIONAL_LIGHT_NUMBER\n@import buildin.header.directional_light\n#endif\n#ifdef SPOT_LIGHT_NUMBER\n@import buildin.header.spot_light\n#endif\n\n#extension GL_OES_standard_derivatives : enable\n// Import util functions and uniforms needed\n@import buildin.util.calculate_attenuation\n\n@import buildin.util.edge_factor\n\n@import buildin.plugin.compute_shadow_map\n\nvoid main(){\n    \n    vec4 finalColor = vec4(color, alpha);\n\n    #ifdef DIFFUSEMAP_ENABLED\n        vec4 tex = texture2D( diffuseMap, v_Texcoord );\n        finalColor.rgb *= tex.rgb;\n    #endif\n\n    vec3 normal = v_Normal;\n    #ifdef NORMALMAP_ENABLED\n        normal = texture2D( normalMap, v_Texcoord ).xyz * 2.0 - 1.0;\n        mat3 tbn = mat3( v_Tangent, v_Bitangent, v_Normal );\n        normal = normalize( tbn * normal );\n    #endif\n\n    // Diffuse part of all lights\n    vec3 diffuseColor = vec3(0.0, 0.0, 0.0);\n    // Specular part of all lights\n    vec3 specularColor = vec3(0.0, 0.0, 0.0);\n    \n    vec3 eyePos = viewInverse[3].xyz;\n    vec3 viewDirection = normalize(eyePos - v_WorldPosition);\n\n    #ifdef AMBIENT_LIGHT_NUMBER\n        for(int i = 0; i < AMBIENT_LIGHT_NUMBER; i++){\n            diffuseColor += ambientLightColor[i];\n        }\n    #endif\n    #ifdef POINT_LIGHT_NUMBER\n        #if defined( SHADOWMAP_ENABLED ) && defined(POINT_LIGHT_SHADOWMAP_NUMBER)\n            float shadowFallOffs[POINT_LIGHT_NUMBER];\n            computeShadowFallOfPointLights( v_WorldPosition, shadowFallOffs );\n        #endif\n        for(int i = 0; i < POINT_LIGHT_NUMBER; i++){\n\n            vec3 lightPosition = pointLightPosition[i];\n            vec3 lightColor = pointLightColor[i];\n            float range = pointLightRange[i];\n\n            vec3 lightDirection = lightPosition - v_WorldPosition;\n\n            // Calculate point light attenuation\n            float dist = length(lightDirection);\n            float attenuation = calculateAttenuation(dist, range); \n\n            // Normalize vectors\n            lightDirection /= dist;\n            vec3 halfVector = normalize( lightDirection + viewDirection );\n\n            float ndh = dot( normal, halfVector );\n            ndh = clamp(ndh, 0.0, 1.0);\n\n            float ndl = dot( normal,  lightDirection );\n            ndl = clamp(ndl, 0.0, 1.0);\n\n            float shadowFallOff = 1.0;\n            #if defined( SHADOWMAP_ENABLED ) && defined(POINT_LIGHT_SHADOWMAP_NUMBER)\n                shadowFallOff = shadowFallOffs[ i ];\n            #endif\n\n            diffuseColor += lightColor * ndl * attenuation * shadowFallOff;\n\n            specularColor += specular * pow( ndh, shininess ) * attenuation * shadowFallOff;\n\n        }\n    #endif\n\n    #ifdef DIRECTIONAL_LIGHT_NUMBER\n        #if defined( SHADOWMAP_ENABLED ) && defined(DIRECTIONAL_LIGHT_SHADOWMAP_NUMBER)\n            float shadowFallOffs[DIRECTIONAL_LIGHT_NUMBER];\n            computeShadowFallOfDirectionalLights( v_WorldPosition, shadowFallOffs );\n        #endif\n        for(int i = 0; i < DIRECTIONAL_LIGHT_NUMBER; i++){\n\n            vec3 lightDirection = -normalize( directionalLightDirection[i] );\n            vec3 lightColor = directionalLightColor[i];\n\n            vec3 halfVector = normalize( lightDirection + viewDirection );\n\n            float ndh = dot( normal, halfVector );\n            ndh = clamp(ndh, 0.0, 1.0);\n\n            float ndl = dot( normal, lightDirection );\n            ndl = clamp(ndl, 0.0, 1.0);\n\n            float shadowFallOff = 1.0;\n            #if defined( SHADOWMAP_ENABLED ) && defined(DIRECTIONAL_LIGHT_SHADOWMAP_NUMBER)\n                shadowFallOff = shadowFallOffs[ i ];\n            #endif\n\n            diffuseColor += lightColor * ndl * shadowFallOff;\n\n            specularColor += specular * pow( ndh, shininess ) * shadowFallOff;\n        }\n    #endif\n\n    #ifdef SPOT_LIGHT_NUMBER\n        #if defined( SHADOWMAP_ENABLED ) && defined(SPOT_LIGHT_SHADOWMAP_NUMBER)\n            float shadowFallOffs[SPOT_LIGHT_NUMBER];\n            computeShadowFallOfSpotLights( v_WorldPosition, shadowFallOffs );\n        #endif\n        for(int i = 0; i < SPOT_LIGHT_NUMBER; i++){\n            vec3 lightPosition = spotLightPosition[i];\n            vec3 spotLightDirection = -normalize( spotLightDirection[i] );\n            vec3 lightColor = spotLightColor[i];\n            float range = spotLightRange[i];\n            float umbraAngleCosine = spotLightUmbraAngleCosine[i];\n            float penumbraAngleCosine = spotLightPenumbraAngleCosine[i];\n            float falloffFactor = spotLightFalloffFactor[i];\n\n            vec3 lightDirection = lightPosition - v_WorldPosition;\n            // Calculate attenuation\n            float dist = length(lightDirection);\n            float attenuation = calculateAttenuation(dist, range); \n\n            // Normalize light direction\n            lightDirection /= dist;\n            // Calculate spot light fall off\n            float lightDirectCosine = dot(spotLightDirection, lightDirection);\n\n            float falloff;\n            // Fomular from real-time-rendering\n            if( lightDirectCosine < penumbraAngleCosine ){\n                falloff = 1.0;\n            }else if( lightDirectCosine > umbraAngleCosine ){\n                falloff = 0.0;\n            }else{\n                falloff = (lightDirectCosine-umbraAngleCosine)/(penumbraAngleCosine-umbraAngleCosine);\n                falloff = pow(falloff, falloffFactor);\n            }\n\n            vec3 halfVector = normalize( lightDirection + viewDirection );\n\n            float ndh = dot( normal, halfVector );\n            ndh = clamp(ndh, 0.0, 1.0);\n\n            float ndl = dot( normal, lightDirection );\n            ndl = clamp(ndl, 0.0, 1.0);\n\n            float shadowFallOff = 1.0;\n            #if defined( SHADOWMAP_ENABLED ) && defined(SPOT_LIGHT_SHADOWMAP_NUMBER)\n                shadowFallOff = shadowFallOffs[i];\n            #endif\n\n            diffuseColor += lightColor * ndl * attenuation * (1.0-falloff) * shadowFallOff;\n\n            specularColor += specular * pow( ndh, shininess ) * attenuation * (1.0-falloff) * shadowFallOff;\n\n        }\n    #endif\n\n    finalColor.rgb *= diffuseColor;\n    finalColor.rgb += specularColor;\n\n    if( lineWidth > 0.01){\n        finalColor.rgb = finalColor.rgb * mix(lineColor, vec3(1.0), edgeFactor(lineWidth));\n    }\n\n    gl_FragColor = finalColor;\n}\n\n@end"}),n("text!3d/shader/source/wireframe.essl",[],function(){return"@export buildin.wireframe.vertex\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform mat4 world : WORLD;\n\nattribute vec3 position : POSITION;\nattribute vec3 barycentric;\n\nvarying vec3 v_Barycentric;\n\nvoid main(){\n\n    gl_Position = worldViewProjection * vec4( position, 1.0 );\n\n    v_Barycentric = barycentric;\n}\n\n@end\n\n\n\n@export buildin.wireframe.fragment\n\nuniform vec3 color : [0.0, 0.0, 0.0];\n\nuniform float alpha : 1.0;\nuniform float lineWidth : 1.5;\n\nvarying vec3 v_Barycentric;\n\n#extension GL_OES_standard_derivatives : enable\n\n@import buildin.util.edge_factor\n\nvoid main(){\n\n    gl_FragColor.rgb = color;\n    gl_FragColor.a = ( 1.0-edgeFactor(lineWidth) ) * alpha;\n}\n\n@end"}),n("text!3d/shader/source/util.essl",[],function(){return"// Use light attenuation formula in\n// http://blog.slindev.com/2011/01/10/natural-light-attenuation/\n@export buildin.util.calculate_attenuation\n\nuniform float attenuationFactor : 5.0;\n\nfloat calculateAttenuation(float dist, float range){\n    float attenuation = 1.0;\n    if( range > 0.0){\n        attenuation = dist*dist/(range*range);\n        float att_s = attenuationFactor;\n        attenuation = 1.0/(attenuation*att_s+1.0);\n        att_s = 1.0/(att_s+1.0);\n        attenuation = attenuation - att_s;\n        attenuation /= 1.0 - att_s;\n    }\n    return attenuation;\n}\n\n@end\n\n//http://codeflow.org/entries/2012/aug/02/easy-wireframe-display-with-barycentric-coordinates/\n@export buildin.util.edge_factor\n\nfloat edgeFactor(float width){\n    vec3 d = fwidth(v_Barycentric);\n    vec3 a3 = smoothstep(vec3(0.0), d * width, v_Barycentric);\n    return min(min(a3.x, a3.y), a3.z);\n}\n\n@end\n\n// http://aras-p.info/blog/2009/07/30/encoding-floats-to-rgba-the-final/\n// http://www.gamedev.net/topic/442138-packing-a-float-into-a-a8r8g8b8-texture-shader/\n@export buildin.util.pack_depth\nvec4 packDepth( const in float depth ){\n\n    const vec4 bitShifts = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );\n    const vec4 bitMask = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );\n\n    vec4 rgba = fract( depth * bitShifts );\n\n    rgba -= rgba.xxyz * bitMask;\n\n    return rgba;\n}\n@end\n\n@export buildin.util.unpack_depth\nfloat unpackDepth( const in vec4 rgba ){\n    const vec4 bitShifts = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\n    return dot(rgba, bitShifts);\n}\n@end\n\n@export buildin.util.pack_depth_half\nvec2 packDepthHalf( const in float depth ){\n    const vec2 bitShifts = vec2(256.0, 1.0);\n    const vec4 bitMask = vec4(0.0, 1.0/256.0);\n\n    vec2 rg = fract(depth*bitShifts);\n    rg -= rg.xx * bitMask;\n\n    return rg;\n}\n@end\n\n@export buildin.util.unpack_depth_half\nfloat unpackDepthHalf( const in vec2 rg ){\n    const vec4 bitShifts = vec2(1.0/256.0, 1.0);\n    return dot(rg, bitShifts);\n}\n@end"}),n("3d/shader/library",["require","../shader","_","text!3d/shader/source/basic.essl","text!3d/shader/source/lambert.essl","text!3d/shader/source/phong.essl","text!3d/shader/source/wireframe.essl","text!3d/shader/source/util.essl"],function(e){function t(e,t){t?"string"==typeof t&&(t=Array.prototype.slice.call(arguments,1)):t=[];var r=e+"_"+t.sort().join(",");if(_pool[r])return _pool[r];var a=_library[e];if(!a)return console.error('Shader "'+e+'"'+" is not in the library"),void 0;var o=new n({vertex:a.vertex,fragment:a.fragment});return i.each(t,function(e){o.enableTexture(e)}),_pool[r]=o,o}function r(e,t,r){_library[e]={vertex:t,fragment:r}}var n=e("../shader"),i=e("_");return _library={},_pool={},n.import(e("text!3d/shader/source/basic.essl")),n.import(e("text!3d/shader/source/lambert.essl")),n.import(e("text!3d/shader/source/phong.essl")),n.import(e("text!3d/shader/source/wireframe.essl")),n.import(e("text!3d/shader/source/util.essl")),r("buildin.basic",n.source("buildin.basic.vertex"),n.source("buildin.basic.fragment")),r("buildin.lambert",n.source("buildin.lambert.vertex"),n.source("buildin.lambert.fragment")),r("buildin.phong",n.source("buildin.phong.vertex"),n.source("buildin.phong.fragment")),r("buildin.wireframe",n.source("buildin.wireframe.vertex"),n.source("buildin.wireframe.fragment")),{get:t,put:r}}),n("text!3d/plugin/vsm.essl",[],function(){return"// Variance Shadow Mapping\n// http://www.punkuser.net/vsm/vsm_paper.pdf\n// http://developer.download.nvidia.com/SDK/10/direct3d/Source/VarianceShadowMapping/Doc/VarianceShadowMapping.pdf\n@export buildin.vsm.depth.vertex\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\n\nattribute vec3 position : POSITION;\nvarying vec4 v_ViewPosition;\nvoid main(){\n\n    v_ViewPosition = worldViewProjection * vec4( position, 1.0 );\n    gl_Position = worldViewProjection * vec4( position , 1.0 );\n\n}\n@end\n\n\n@export buildin.vsm.depth.fragment\n\nvarying vec4 v_ViewPosition;\n\nuniform int writeChannel : 0;\n\nvoid main(){\n    float z = v_ViewPosition.z / v_ViewPosition.w;\n\n    if( writeChannel == 0){\n        gl_FragColor = vec4(z, z*z, 0.0, 0.0);\n    }else{\n        gl_FragColor = vec4(0.0, 0.0, z, z*z);\n    }\n}\n@end\n\n@export buildin.plugin.compute_shadow_map\n\n#if defined( SHADOWMAP_ENABLED )\n\nvec4 vsmBoxFilter(sampler2D texture, vec2 uv){\n    vec4 tex = texture2D(texture, uv);\n    float offset = 1.0/512.0;\n    tex += texture2D(texture, uv+vec2(offset, 0.0) );\n    tex += texture2D(texture, uv+vec2(offset, offset) );\n    tex += texture2D(texture, uv+vec2(-offset, offset) );\n    tex += texture2D(texture, uv+vec2(0.0, offset) );\n    tex += texture2D(texture, uv+vec2(-offset, 0.0) );\n    tex += texture2D(texture, uv+vec2(-offset, -offset) );\n    tex += texture2D(texture, uv+vec2(offset, -offset) );\n    tex += texture2D(texture, uv+vec2(0.0, -offset) );\n\n    tex /= 9.0;\n    return tex;\n}\n\nfloat computeShadowFalloffOfSingleMap( sampler2D map, mat4 lightVPM, vec3 position){\n    vec4 posInLightSpace = ( lightVPM * vec4(position, 1.0) );\n    posInLightSpace.xyz /= posInLightSpace.w;\n\n    float z = posInLightSpace.z;\n    // In frustum\n    if( all(greaterThan(posInLightSpace.xyz, vec3(-1.0))) &&\n        all(lessThan(posInLightSpace.xyz, vec3(1.0))) ){\n        \n        // To texture uv\n        vec2 uv = (posInLightSpace.xy+1.0) / 2.0;\n        // vec2 moments = texture2D( map, uv ).xy;\n        vec2 moments = vsmBoxFilter( map, uv ).xy;\n        \n        float variance = moments.y - moments.x * moments.x;\n\n        float mD = moments.x - z;\n        float p = variance / (variance + mD * mD);\n\n        if(moments.x + 0.002 < z){\n            return clamp(p, 0.0, 1.0);\n        }else{\n            return 1.0;\n        }\n    }\n    return 1.0;\n}\n\n#if defined(SPOT_LIGHT_NUMBER) && defined(SPOT_LIGHT_SHADOWMAP_NUMBER)\n\nvoid computeShadowFallOfSpotLights( vec3 position, inout float shadowFalloffs[SPOT_LIGHT_NUMBER]  ){\n    for( int i = SPOT_LIGHT_SHADOWMAP_OFFSET; i < SPOT_LIGHT_SHADOWMAP_OFFSET + SPOT_LIGHT_SHADOWMAP_NUMBER; i++){\n        float shadowFalloff = computeShadowFalloffOfSingleMap( shadowMap[i], shadowCameraMatrix[i], position );\n        shadowFalloffs[ i - SPOT_LIGHT_SHADOWMAP_OFFSET ] = shadowFalloff;\n    }\n    // set default fallof of rest lights\n    for( int i = SPOT_LIGHT_SHADOWMAP_NUMBER; i < SPOT_LIGHT_NUMBER; i++){\n        shadowFalloffs[i] = 1.0;\n    }\n}\n\n#endif\n\n\n#if defined(POINT_LIGHT_NUMBER) && defined(POINT_LIGHT_SHADOWMAP_NUMBER)\n\nvoid computeShadowFallOfPointLights( vec3 position, inout float shadowFalloffs[POINT_LIGHT_NUMBER]  ){\n    for( int i = 0; i < POINT_LIGHT_NUMBER; i++){\n        shadowFalloffs[i] = 1.0;\n    }\n    for( int i = POINT_LIGHT_SHADOWMAP_OFFSET; i < POINT_LIGHT_SHADOWMAP_OFFSET + POINT_LIGHT_SHADOWMAP_NUMBER; i++){\n        float shadowFalloff = computeShadowFalloffOfSingleMap( shadowMap[i], shadowCameraMatrix[i], position );\n        \n        shadowFalloffs[ (i - POINT_LIGHT_SHADOWMAP_OFFSET) / 6 ] *= shadowFalloff;\n    }\n}\n\n#endif\n\n\n#if defined(DIRECTIONAL_LIGHT_NUMBER) && defined(DIRECTIONAL_LIGHT_SHADOWMAP_NUMBER)\n\nvoid computeShadowFallOfDirectionalLights( vec3 position, inout float shadowFalloffs[DIRECTIONAL_LIGHT_NUMBER] ){\n    for( int i = DIRECTIONAL_LIGHT_SHADOWMAP_OFFSET; i < DIRECTIONAL_LIGHT_SHADOWMAP_OFFSET + DIRECTIONAL_LIGHT_SHADOWMAP_NUMBER; i++){\n        float shadowFalloff = computeShadowFalloffOfSingleMap( shadowMap[i], shadowCameraMatrix[i], position );\n        shadowFalloffs[ i - POINT_LIGHT_SHADOWMAP_OFFSET] = shadowFalloff;\n    }\n    // set default fallof of rest lights\n    for( int i = DIRECTIONAL_LIGHT_SHADOWMAP_NUMBER; i < DIRECTIONAL_LIGHT_NUMBER; i++){\n        shadowFalloffs[i] = 1.0;\n    }\n}\n\n#endif\n\n#endif\n\n@end"}),n("3d/plugin/shadowmap",["require","core/base","../shader","../light","../light/spot","../light/directional","../light/point","../shader/library","../material","../framebuffer","../texture/texture2d","../camera/perspective","../camera/orthographic","glmatrix","_","text!./vsm.essl"],function(e){function t(e,t){for(var r=[],n=0;e>n;n++)r.push(t);return r}var r=e("core/base"),n=e("../shader"),i=e("../light"),a=e("../light/spot"),o=e("../light/directional"),s=e("../light/point");e("../shader/library");var u=e("../material"),l=e("../framebuffer"),c=e("../texture/texture2d"),f=e("../camera/perspective"),h=e("../camera/orthographic"),d=e("glmatrix"),p=d.mat4,v=e("_"),m=new l;n.import(e("text!./vsm.essl"));var g=r.derive(function(){return{renderer:null,_depthMaterial:new u({shader:new n({vertex:n.source("buildin.vsm.depth.vertex"),fragment:n.source("buildin.vsm.depth.fragment")})}),_textures:{},_cameras:{},_cameraMatrices:[],_shadowMapNumber:{POINT_LIGHT:0,DIRECTIONAL_LIGHT:0,SPOT_LIGHT:0},_shadowMapOrder:{SPOT_LIGHT:0,DIRECTIONAL_LIGHT:1,SPOT_LIGHT:2},_latestRenderQueue:[]}},{enable:function(){this.renderer.on("beforerender",this._renderShadowPass,this)},disable:function(){this.renderer.off("beforerender",this._renderShadowPass,this);for(var e=0;this._latestRenderQueue.length>e;e++){var t=this._latestRenderQueue[e].material.shader;t.disableTexture("shadowMap"),t.update()}},_renderShadowPass:function(e){var r=[],n=[],u=[],l=this.renderer,c=l.gl;e.update(),e.traverse(function(e){e.instanceof(i)&&e.castShadow&&n.push(e),e.material&&e.material.shader&&(e.castShadow&&r.push(e),e.receiveShadow?(u.push(e),e.material.shader.enableTexture("shadowMap")):e.material.shader.disableTexture("shadowMap"))}),c.enable(c.DEPTH_TEST),c.disable(c.BLEND),c.clearColor(0,0,0,0),c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT);var f=["px","nx","py","ny","pz","nz"],h=0,d=[],g=this._cameraMatrices,_=this._shadowMapOrder;n.sort(function(e,t){return _[e]-_[t]});for(var x in this._shadowMapNumber)this._shadowMapNumber[x]=0;v.each(n,function(t){if(t.instanceof(a)||t.instanceof(o)){t.shadowMapIndex=h;var n=this._getTexture(t.shadowMapIndex,t),i=this._getCamera(t.shadowMapIndex,t);m.attach(l.gl,n),m.bind(l),c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT),l._scene=e,l.renderQueue(r,i,this._depthMaterial,!0),m.unbind(l),d.push(n);var u=g[h];u||(u=g[h]=p.create()),p.invert(u,i.worldMatrix),p.multiply(u,i.projectionMatrix,u),h++,this._shadowMapNumber[t.type]++}else if(t.instanceof(s)){t.shadowMapIndex=h;for(var v=0;6>v;v++){var _=f[v],n=this._getTexture(t.shadowMapIndex,t,_),i=this._getCamera(t.shadowMapIndex,t,_);m.attach(l.gl,n),m.bind(l),c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT),l._scene=e,l.renderQueue(r,i,this._depthMaterial,!0),m.unbind(l),d.push(n);var u=g[h+v];u||(u=g[h+v]=p.create()),p.invert(u,i.worldMatrix),p.multiply(u,i.projectionMatrix,u)}this._shadowMapNumber.POINT_LIGHT+=6,h+=6}},this);var b=0;for(var x in this._shadowMapNumber){var y=this._shadowMapNumber[x];b+=y}for(var E={spotLightShadowFalloff:t(this._shadowMapNumber.SPOT_LIGHT,1),pointLightShadowFalloff:t(this._shadowMapNumber.POINT_LIGHT,1),directionalLightShadowFalloff:t(this._shadowMapNumber.DIRECTIONAL_LIGHT,1)},T=0;u.length>T;T++){var w=u[T],A=w.material;A.setUniform("shadowMap",d),A.setUniform("shadowCameraMatrix",g);var O=A.shader,I=!1;for(var x in this._shadowMapNumber){var y=this._shadowMapNumber[x],P=x+"_SHADOWMAP_NUMBER";O.fragmentDefines[P]!==y&&y>0&&(O.fragmentDefines[P]=y,I=!0)}if(I){var M=0;for(var x in this._shadowMapNumber){var P=x+"_SHADOWMAP_OFFSET",y=this._shadowMapNumber[x];O.fragmentDefines[P]=M,M+=y}O.fragmentDefines.SHADOWMAP_NUMBER=b,O.update()}A.setUniforms(E)}this._latestRenderQueue=r},_getTexture:function(e,t,r){var n=this._textures[e],i=t.shadowResolution||512,a=!1;return n?r?(n=n[r],n?n.width!==i&&(n.dispose(),a=!0):a=!0):n.width!==i&&(n.dispose(),a=!0):(a=!0,r&&(this._textures[e]={})),a&&(n=new c({width:i,height:i,type:"FLOAT"}),r?this._textures[e][r]=n:this._textures[e]=n),n},_getCamera:function(e,t,r){var n=this._cameras[e];if(r&&!n&&(n=this._cameras[e]={}),r&&(n=n[r]),n||(t.instanceof(a)||t.instanceof(s)?n=new f({near:.1}):t.instanceof(o)&&(n=new h(t.shadowCamera)),r?this._cameras[e][r]=n:this._cameras[e]=n),t.instanceof(a)&&(n.fov=2*t.penumbraAngle,n.far=t.range),t.instanceof(s)){switch(n.position=t.position,n.far=t.range,n.fov=90,r){case"px":n.pitch(Math.PI/2);break;case"nx":n.pitch(-Math.PI/2);break;case"py":n.roll(-Math.PI/2);break;case"ny":n.roll(Math.PI/2);break;case"nz":n.pitch(Math.PI);default:}n.update()}else{p.copy(n.worldMatrix,t.worldMatrix);var i=n.worldMatrix;i[0]=-i[0],i[1]=-i[1],i[2]=-i[2],i[8]=-i[8],i[9]=-i[9],i[10]=-i[10]}return n.updateProjectionMatrix(),n}});return g}),n("3d/renderer",["require","core/base","_","glmatrix","util/util","./light","./mesh"],function(e){var t=e("core/base"),r=e("_"),n=e("glmatrix"),i=n.mat4,a=e("util/util"),o=e("./light"),s=e("./mesh"),u=t.derive(function(){return{__GUID__:a.genGUID(),canvas:null,devicePixelRatio:window.devicePixelRatio||1,color:[1,1,1,0],clear:16640,alhpa:!0,depth:!0,stencil:!1,antialias:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!1,gl:null,viewportInfo:{},_extensions:null}},function(){this.canvas||(this.canvas=document.createElement("canvas"));try{this.gl=this.canvas.getContext("experimental-webgl",{alhpa:this.alhpa,depth:this.depth,stencil:this.stencil,antialias:this.antialias,premultipliedAlpha:this.premultipliedAlpha,preserveDrawingBuffer:this.preserveDrawingBuffer}),this.gl.__GUID__=this.__GUID__,this.getExtensions(),this.resize(this.canvas.width,this.canvas.height)}catch(e){throw"Error creating WebGL Context"}},{resize:function(e,t){var r=this.canvas;r.style.width=e+"px",r.style.height=t+"px",r.width=e*this.devicePixelRatio,r.height=t*this.devicePixelRatio,this.setViewport(0,0,r.width,r.height)},setViewport:function(e,t,r,n){this.gl.viewport(e,t,r,n),this.viewportInfo={x:e,y:t,width:r,height:n}},getExtensions:function(){return this._extensions||(this._extensions={},r.each(c,function(e){this._extensions[e]=this.gl.getExtension(e)},this)),this._extensions},hasExtension:function(e){return this._extensions[e]},render:function(e,t,n){var i=this.gl;n||this.trigger("beforerender",e,t);var a=this.color;i.clearColor(a[0],a[1],a[2],a[3]),i.clear(this.clear);var s=[],u=[],l=[];t.update(),e.update(),this._scene=e;var c=e.material;e.traverse(function(e){if(!e.visible)return!0;if(e.instanceof(o)&&l.push(e),e.render)if(c)c.transparent?u.push(e):s.push(e);else{if(!e.material||!e.material.shader)return;if(!e.geometry)return;e.material.transparent?u.push(e):s.push(e)}}),e.filter&&(s=r.filter(s,e.filter),u=r.filter(u,e.filter));for(var f={},h=0;l.length>h;h++){var d=l[h];f[d.type]||(f[d.type]=0),f[d.type]++}e.lightNumber=f,this.updateLightUnforms(l),s.sort(this._materialSortFunc),u.sort(this._materialSortFunc),n||this.trigger("beforerender:opaque",s),i.enable(i.DEPTH_TEST),i.disable(i.BLEND),this.renderQueue(s,t,c,n),n||(this.trigger("afterrender:opaque",s),this.trigger("beforerender:transparent",u)),i.disable(i.DEPTH_TEST),i.enable(i.BLEND),i.blendEquation(i.FUNC_ADD),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),this.renderQueue(u,t,c,n),n||(this.trigger("afterrender:transparent",u),this.trigger("afterrender",e,t))},updateLightUnforms:function(e){var t=this._scene.lightUniforms;for(var r in this._scene.lightUniforms)t[r].length=0;for(var n=0;e.length>n;n++){var i=e[n];for(r in i.uniformTemplates){var a=i.uniformTemplates[r];t[r]||(t[r]=[]);var o=a.value(i),s=t[r];switch(a.type){case"1i":case"1f":s.push(o);break;case"2f":case"3f":case"4f":for(var u=0;o.length>u;u++)s.push(o[u]);break;default:console.error("Unkown light uniform type "+a.type)}}}},renderQueue:function(e,t,n,a){i.invert(l.VIEW,t.worldMatrix),i.copy(l.PROJECTION,t.projectionMatrix),i.multiply(l.VIEWPROJECTION,t.projectionMatrix,l.VIEW),i.copy(l.VIEWINVERSE,t.worldMatrix),i.invert(l.PROJECTIONINVERSE,l.PROJECTION),i.invert(l.VIEWPROJECTIONINVERSE,l.VIEWPROJECTION);
for(var o,u,c=this.gl,f=this._scene,h=0;e.length>h;h++){var d=e[h],p=n||d.material,v=p.shader;d.geometry;var m=p.transparent&&p.blend;if(u!==v.__GUID__){var g=!1;if(r.isEqual(v.lightNumber,f.lightNumber)||(g=!0),g){for(var _ in f.lightNumber){var x=f.lightNumber[_];v.lightNumber[_]=x}v.update()}v.bind(c),u=v.__GUID__}if(o!==p.__GUID__){for(var b in f.lightUniforms){var y=p.uniforms[b];y&&(y.value=f.lightUniforms[b])}p.bind(c),o=p.__GUID__,s.materialChanged()}m&&m(c);var E=d.worldMatrix;(v.semantics.hasOwnProperty("WORLD")||v.semantics.hasOwnProperty("WORLDTRANSPOSE"))&&i.copy(l.WORLD,E),(v.semantics.hasOwnProperty("WORLDVIEW")||v.semantics.hasOwnProperty("WORLDVIEWINVERSE")||v.semantics.hasOwnProperty("WORLDVIEWINVERSETRANSPOSE"))&&i.multiply(l.WORLDVIEW,l.VIEW,E),(v.semantics.hasOwnProperty("WORLDVIEWPROJECTION")||v.semantics.hasOwnProperty("WORLDVIEWPROJECTIONINVERSE")||v.semantics.hasOwnProperty("WORLDVIEWPROJECTIONINVERSETRANSPOSE"))&&i.multiply(l.WORLDVIEWPROJECTION,l.VIEWPROJECTION,E),(v.semantics.hasOwnProperty("WORLDINVERSE")||v.semantics.hasOwnProperty("WORLDINVERSETRANSPOSE"))&&i.invert(l.WORLDINVERSE,E),(v.semantics.hasOwnProperty("WORLDVIEWINVERSE")||v.semantics.hasOwnProperty("WORLDVIEWINVERSETRANSPOSE"))&&i.invert(l.WORLDVIEWINVERSE,l.WORLDVIEW),(v.semantics.hasOwnProperty("WORLDVIEWPROJECTIONINVERSE")||v.semantics.hasOwnProperty("WORLDVIEWPROJECTIONINVERSETRANSPOSE"))&&i.invert(l.WORLDVIEWPROJECTIONINVERSE,l.WORLDVIEWPROJECTION);for(var T in l){if(v.semantics.hasOwnProperty(T)){var w=l[T],A=v.semantics[T];v.setUniform(c,A.type,A.symbol,w)}if(v.semantics.hasOwnProperty(T+"TRANSPOSE")){var O=l[T+"TRANSPOSE"],w=l[T],I=v.semantics[T+"TRANSPOSE"];i.transpose(O,w),v.setUniform(c,I.type,I.symbol,O)}}a||this.trigger("beforerender:mesh",d);var P=d.render(c,n);a||this.trigger("afterrender:mesh",d,P),m&&(c.blendEquation(c.FUNC_ADD),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA))}},_materialSortFunc:function(e,t){return e.material.shader==t.material.shader?e.material.__GUID__-t.material.__GUID__:e.material.shader.__GUID__-t.material.__GUID__}}),l={WORLD:i.create(),VIEW:i.create(),PROJECTION:i.create(),WORLDVIEW:i.create(),VIEWPROJECTION:i.create(),WORLDVIEWPROJECTION:i.create(),WORLDINVERSE:i.create(),VIEWINVERSE:i.create(),PROJECTIONINVERSE:i.create(),WORLDVIEWINVERSE:i.create(),VIEWPROJECTIONINVERSE:i.create(),WORLDVIEWPROJECTIONINVERSE:i.create(),WORLDTRANSPOSE:i.create(),VIEWTRANSPOSE:i.create(),PROJECTIONTRANSPOSE:i.create(),WORLDVIEWTRANSPOSE:i.create(),VIEWPROJECTIONTRANSPOSE:i.create(),WORLDVIEWPROJECTIONTRANSPOSE:i.create(),WORLDINVERSETRANSPOSE:i.create(),VIEWINVERSETRANSPOSE:i.create(),PROJECTIONINVERSETRANSPOSE:i.create(),WORLDVIEWINVERSETRANSPOSE:i.create(),VIEWPROJECTIONINVERSETRANSPOSE:i.create(),WORLDVIEWPROJECTIONINVERSETRANSPOSE:i.create()},c=["OES_texture_float","OES_texture_half_float","OES_standard_derivatives","OES_vertex_array_object","OES_element_index_uint"];return u}),n("3d/util/mesh",["require","../geometry","../mesh","glmatrix","_"],function(e){var t=e("../geometry"),r=e("../mesh"),n=e("glmatrix"),i=e("_");n.mat4;var a=n.vec3,o={merge:function(e,n){function o(e){return n?e&&Array.prototype.slice.call(e):e}if(e.length){var n=n===void 0?!0:n,s=e[0],u=s.geometry,l=s.material;i.any(e,function(e){return e.material!==l})&&console.warn("Material of meshes to merge is not the same, program will use the material of first mesh by default");var c=new t,f=c.faces;for(var h in u.attributes){var d=u.attributes[h];c.attributes[h]||(c.attributes[h]={value:[],type:d.type})}for(var p,v,m,g,_,x,b,y,E,T,w=0,A=0!==u.faces.length,O=0;e.length>O;O++){T=e[O],v=T.geometry,T.updateMatrix(),p=v.getVerticesNumber();for(var h in v.attributes)if(m=v.attributes[h],g=c.attributes[h],m.value.length)for(x=0;p>x;x++)"position"===h?(_=o(m.value[x]),a.transformMat4(_,_,T.matrix),g.value.push(_)):"normal"===h?(_=o(m.value[x]),g.value.push(_)):"tangent"===h?(_=o(m.value[x]),g.value.push(_)):g.value.push(o(m.value[x]));if(A)for(b=v.faces.length,x=0;b>x;x++)y=[],E=v.faces[x],y[0]=E[0]+w,y[1]=E[1]+w,y[2]=E[2]+w,f.push(y);w+=p}return new r({material:l,geometry:c})}}};return o}),n("core/event",["require","./base"],function(e){var t=e("./base"),r=t.derive({cancelBubble:!1},{stopPropagation:function(){this.cancelBubble=!0}});r.throw=function(e,t,r){var n=new MouseEvent(r);for(n.sourceTarget=t;t&&!n.cancelBubble;)n.target=t,t.trigger(e,n),t=t.parent}}),n("core/request",["require"],function(){function e(e){var t=new XMLHttpRequest;t.open("get",e.url),t.responseType=e.responseType||"text",e.onprogress&&(t.onprogress=function(t){if(t.lengthComputable){var r=t.loaded/t.total;e.onprogress(r,t.loaded,t.total)}else e.onprogress(null)}),t.onload=function(){e.onload&&e.onload(t.response)},e.onerror&&(t.onerror=e.onerror),t.send(null)}function t(){}return{get:e,put:t}}),n("loader/three/json",["require","core/base","core/request","3d/shader","3d/material","3d/geometry","3d/mesh","3d/node","3d/texture/texture2d","3d/texture/texturecube","3d/shader/library","_","glmatrix"],function(e){function t(e,t){return e&1<<t}function r(e){var t=255&e>>16,r=255&e>>8,n=255&e;return[t/255,r/255,n/255]}var n=e("core/base"),i=e("core/request");e("3d/shader");var a=e("3d/material"),o=e("3d/geometry"),s=e("3d/mesh");e("3d/node");var u=e("3d/texture/texture2d");e("3d/texture/texturecube");var l=e("3d/shader/library"),c=e("_"),f=e("glmatrix");f.vec3,f.vec2;var h=n.derive(function(){return{textureRootPath:"",textureNumber:0}},{load:function(e){var t=this;this.textureNumber=0,i.get({url:e,onprogress:function(e,r,n){t.trigger("progress",e,r,n)},onerror:function(e){t.trigger("error",e)},responseType:"text",onload:function(e){t.parse(JSON.parse(e))}})},parse:function(e){function n(e,t){return w[e]>=0?(O=A[e],p=i[O],v=p.attributes,m=v.position.value,g=v.normal.value,_=[v.texcoord0.value,v.texcoord1.value],x=v.color.value,I[t]=!1,w[e]):(m.push([c[3*e],c[3*e+1],c[3*e+2]]),w[e]=a[N],A[e]=N,I[t]=!0,a[N]++)}for(var i=[],a=[],u=0;1e3>u;u++)i[u]=null,a[u]=0;i[0]=new o,e.materials&&e.materials.length>1;var l=e.faces,c=e.vertices,f=e.normals,h=e.colors,d=e.uvs,p=i[0],v=p.attributes,m=v.position.value,g=v.normal.value,_=[v.texcoord0.value,v.texcoord1.value],x=v.color.value,b=p.faces,y=0;d[0]&&d[0].length&&y++,d[1]&&d[1].length&&y++;for(var E=0,T=l.length,w=[],A=[],u=0;c.length>u;u++)w[u]=-1,A[u]=-1;for(var O=0,I=[],P=[],M=[],R=[],u=0;4>u;u++)P[u]=[0,0],M[u]=[0,0,0],R[u]=[0,0,0];for(var N=0;T>E;){var S=l[E++],D=t(S,0),L=t(S,1),C=t(S,2),B=t(S,3),U=t(S,4),F=t(S,5),k=t(S,6),W=t(S,7),H=D?4:3;if(L&&(N=l[E+(D?4:3)],i[N]||(i[N]=new o),p=i[N],v=p.attributes,m=v.position.value,g=v.normal.value,_=[v.texcoord0.value,v.texcoord1.value],x=v.color.value,b=p.faces),D){var V=l[E++],G=l[E++],z=l[E++],q=l[E++];V=n(V,0),G=n(G,1),z=n(q,2),q=n(G,3);var j=n(z,4),X=n(q,5);b.push([V,G,z],[q,j,X])}else{var V=l[E++],G=l[E++],z=l[E++];V=n(V,0),G=n(G,1),z=n(z,2),b.push([V,G,z])}if(L&&E++,C)for(var u=0;y>u;u++){var J=d[u],Y=b[E++],Z=J[2*Y],Q=J[2*Y+1];D?(I[0]&&(_[u][V]=[Z,Q]),I[1]&&(_[u][G]=[Z,Q]),I[2]&&(_[u][z]=[Z,Q]),I[3]&&(_[u][q]=[Z,Q]),I[4]&&(_[u][j]=[Z,Q]),I[5]&&(_[u][X]=[Z,Q])):(I[0]&&(_[u][V]=[Z,Q]),I[1]&&(_[u][G]=[Z,Q]),I[2]&&(_[u][z]=[Z,Q]))}if(B)for(var u=0;y>u;u++){for(var J=d[u],K=0;H>K;K++){var Y=l[E++];P[K][0]=J[2*Y],P[K][1]=J[2*Y+1]}D?(I[0]&&(_[u][V]=P[0].slice()),I[1]&&(_[u][G]=P[1].slice()),I[2]&&(_[u][z]=P[3].slice()),I[3]&&(_[u][q]=P[1].slice()),I[4]&&(_[u][j]=P[2].slice()),I[5]&&(_[u][X]=P[3].slice())):(I[0]&&(_[u][V]=P[0].slice()),I[1]&&(_[u][G]=P[1].slice()),I[2]&&(_[u][z]=P[2].slice()))}if(U){var $=3*l[E++],et=f[$++],tt=f[$++],rt=f[$];D?(I[0]&&(g[V]=[et,tt,rt]),I[1]&&(g[G]=[et,tt,rt]),I[2]&&(g[z]=[et,tt,rt]),I[3]&&(g[q]=[et,tt,rt]),I[4]&&(g[j]=[et,tt,rt]),I[5]&&(g[X]=[et,tt,rt])):(I[0]&&(g[V]=[et,tt,rt]),I[1]&&(g[G]=[et,tt,rt]),I[2]&&(g[z]=[et,tt,rt]))}if(F){for(var u=0;H>u;u++){var $=3*l[E++];M[u][0]=f[$++],M[u][1]=f[$++],M[u][2]=f[$]}D?(I[0]&&(g[V]=M[0].slice()),I[1]&&(g[G]=M[1].slice()),I[2]&&(g[z]=M[3].slice()),I[3]&&(g[q]=M[1].slice()),I[4]&&(g[j]=M[2].slice()),I[5]&&(g[X]=M[3].slice())):(I[0]&&(g[V]=M[0].slice()),I[1]&&(g[G]=M[1].slice()),I[2]&&(g[z]=M[2].slice()))}if(k){var nt=l[E++],it=r(h[nt]);D?(I[0]&&(x[V]=it),I[1]&&(x[G]=it),I[2]&&(x[z]=it),I[3]&&(x[q]=it),I[4]&&(x[j]=it),I[5]&&(x[X]=it)):(I[0]&&(x[V]=it),I[1]&&(x[G]=it),I[2]&&(x[z]=it))}if(W){for(var u=0;H>u;u++){var nt=l[E++];R[u]=r(h[nt])}D?(I[0]&&(x[V]=R[0].slice()),I[1]&&(x[G]=R[1].slice()),I[2]&&(x[z]=R[3].slice()),I[3]&&(x[q]=R[1].slice()),I[4]&&(x[j]=R[2].slice()),I[5]&&(x[X]=R[3].slice())):(I[0]&&(x[V]=R[0].slice()),I[1]&&(x[G]=R[1].slice()),I[2]&&(x[z]=R[2].slice()))}}for(var at=[],u=0;e.materials.length>u;u++){var p=i[u];if(p&&p.faces.length&&p.attributes.position.value.length){var ot=this.parseMaterial(e.materials[u]),st=new s({geometry:i[u],material:ot});at.push(st)}}return this.trigger("load",at),at},parseMaterial:function(e){var t="buildin.lambert",n=e.shading&&e.shading.toLowerCase();("phong"===n||"lambert"===n)&&(t="buildin."+n);var i=[];e.mapDiffuse&&i.push("diffuseMap"),(e.mapNormal||e.mapBump)&&i.push("normalMap");var o=l.get(t,i),s=new a({shader:o});return e.colorDiffuse?s.setUniform("color",e.colorDiffuse):e.DbgColor&&s.setUniform("color",r(e.DbgColor)),e.colorSpecular&&s.setUniform("specular",e.colorSpecular),void 0!==e.transparent&&e.transparent&&(s.transparent=!0),c.isUndefined(e.depthTest)||(s.depthTest=e.depthTest),c.isUndefined(e.depthWrite)||(s.depthTest=e.depthWrite),e.transparency&&1>e.transparency&&s.setUniform("opacity",e.transparency),e.specularCoef&&s.setUniform("shininess",e.specularCoef),e.mapDiffuse&&s.setUniform("diffuseMap",this.loadTexture(e.mapDiffuse,e.mapDiffuseWrap)),e.mapBump&&s.setUniform("normalMap",this.loadTexture(e.mapBump,e.mapBumpWrap)),e.mapNormal&&s.setUniform("normalMap",this.loadTexture(e.mapNormal,e.mapBumpWrap)),s},loadTexture:function(e,t){var r=this,n=new Image,i=new u;return i.image=n,this.textureNumber++,t&&t.length&&(i.wrapS=t[0].toUpperCase(),i.wrapT=t[1].toUpperCase()),n.onload=function(){r.trigger("load:texture",i),i.dirty()},n.src=this.textureRootPath+"/"+e,i}});return h}),n("util/color",["require"],function(){}),n("util/xmlparser",["require"],function(){}),n("src/qtek",["require","2d/camera","2d/node","2d/renderable/arc","2d/renderable/circle","2d/renderable/image","2d/renderable/line","2d/renderable/path","2d/renderable/polygon","2d/renderable/rectangle","2d/renderable/roundedrectangle","2d/renderable/sector","2d/renderable/text","2d/renderable/textbox","2d/renderer","2d/scene","2d/style","2d/util","3d/camera","3d/camera/orthographic","3d/camera/perspective","3d/compositor/graph/graph","3d/compositor/graph/node","3d/compositor/graph/scenenode","3d/compositor/graph/texturepool","3d/compositor/pass","3d/debug/pointlight","3d/debug/renderinfo","3d/framebuffer","3d/geometry","3d/geometry/cube","3d/geometry/plane","3d/geometry/sphere","3d/light","3d/light/ambient","3d/light/directional","3d/light/point","3d/light/spot","3d/material","3d/mesh","3d/node","3d/plugin/firstpersoncontrol","3d/plugin/shadowmap","3d/renderer","3d/scene","3d/shader","3d/shader/library","3d/texture","3d/texture/texture2d","3d/texture/texturecube","3d/util/mesh","core/base","core/cache","core/event","core/mixin/derive","core/mixin/dirty","core/mixin/notifier","core/request","loader/three/json","text","util/color","util/util","util/xmlparser","glmatrix"],function(e){var t={"2d":{Camera:e("2d/camera"),Node:e("2d/node"),renderable:{Arc:e("2d/renderable/arc"),Circle:e("2d/renderable/circle"),Image:e("2d/renderable/image"),Line:e("2d/renderable/line"),Path:e("2d/renderable/path"),Polygon:e("2d/renderable/polygon"),Rectangle:e("2d/renderable/rectangle"),RoundedRectangle:e("2d/renderable/roundedrectangle"),Sector:e("2d/renderable/sector"),Text:e("2d/renderable/text"),TextBox:e("2d/renderable/textbox")},Renderer:e("2d/renderer"),Scene:e("2d/scene"),Style:e("2d/style"),util:e("2d/util")},"3d":{Camera:e("3d/camera"),camera:{Orthographic:e("3d/camera/orthographic"),Perspective:e("3d/camera/perspective")},compositor:{graph:{Graph:e("3d/compositor/graph/graph"),Node:e("3d/compositor/graph/node"),SceneNode:e("3d/compositor/graph/scenenode"),Texturepool:e("3d/compositor/graph/texturepool")},Pass:e("3d/compositor/pass")},debug:{Pointlight:e("3d/debug/pointlight"),RenderInfo:e("3d/debug/renderinfo")},FrameBuffer:e("3d/framebuffer"),Geometry:e("3d/geometry"),geometry:{Cube:e("3d/geometry/cube"),Plane:e("3d/geometry/plane"),Sphere:e("3d/geometry/sphere")},Light:e("3d/light"),light:{Ambient:e("3d/light/ambient"),Directional:e("3d/light/directional"),Point:e("3d/light/point"),Spot:e("3d/light/spot")},Material:e("3d/material"),Mesh:e("3d/mesh"),Node:e("3d/node"),plugin:{FirstPersonControl:e("3d/plugin/firstpersoncontrol"),ShadowMap:e("3d/plugin/shadowmap")},Renderer:e("3d/renderer"),Scene:e("3d/scene"),Shader:e("3d/shader"),shader:{library:e("3d/shader/library")},Texture:e("3d/texture"),texture:{Texture2D:e("3d/texture/texture2d"),TextureCube:e("3d/texture/texturecube")},util:{mesh:e("3d/util/mesh")}},core:{Base:e("core/base"),Cache:e("core/cache"),Event:e("core/event"),mixin:{derive:e("core/mixin/derive"),Dirty:e("core/mixin/dirty"),notifier:e("core/mixin/notifier")},requester:e("core/request")},loader:{three:{JSON:e("loader/three/json")}},Text:e("text"),util:{Color:e("util/color"),Util:e("util/util"),Xmlparser:e("util/xmlparser")}},r=e("glmatrix");return t.math=r,t});var i=r("src/qtek");for(var a in i)e[a]=i[a]});